L.TileLayer.Bing=L.TileLayer.extend({supportedTypes:["Road","Aerial","AerialWithLabels"],attributionTemplate:'<span style="display:inline-block">'+'<a target="_blank" href="http://www.bing.com/maps/">'+'<img src="{logo}" /></a><br><span>{copyrights}'+'<a style="white-space: nowrap" target="_blank" '+'href="http://www.microsoft.com/maps/product/terms.html">'+"Terms of Use</a></span></span>",initialize:function(e,t,n){this._apiKey=e;this._mapType=t;this._loadMetadata();L.Util.setOptions(this,n)},_loadMetadata:function(){this._callbackId="_l_tilelayer_bing_"+L.TileLayer.Bing._callbackId++;var e=this;window[this._callbackId]=function(){L.TileLayer.Bing.processMetadata.apply(e,arguments)};var t={key:this._apiKey,jsonp:this._callbackId,include:"ImageryProviders"},n="http://dev.virtualearth.net/REST/v1/Imagery/Metadata/"+this._mapType+L.Util.getParamString(t),r=document.createElement("script");r.type="text/javascript";r.src=n;r.id=this._callbackId;document.getElementsByTagName("head")[0].appendChild(r)},_onMetadataLoaded:function(){},onAdd:function(e,t){if(!this.metadata){this._onMetadataLoaded=L.Util.bind(function(){L.TileLayer.prototype.onAdd.call(this,e,t);e.on("moveend",this._updateAttribution,this);this._updateAttribution()},this)}else{L.TileLayer.prototype.onAdd.call(this,e,t);e.on("moveend",this._updateAttribution,this);this._updateAttribution()}L.TileLayer.prototype.onAdd.call(this,e)},onRemove:function(e){if(this._map.attributionControl){this._map.attributionControl.removeAttribution(this.attribution)}this._map.off("moveend",this._updateAttribution,this);L.TileLayer.prototype.onRemove.call(this,e)},getTileUrl:function(e,t){var n=this.options.subdomains,r=[],i=t,s,o,u;for(;i>0;--i){s="0";o=1<<i-1;if((e.x&o)!=0){s++}if((e.y&o)!=0){s++;s++}r.push(s)}return this._url.replace("{subdomain}",n[(e.x+e.y)%n.length]).replace("{quadkey}",r.join(""))},_updateAttribution:function(){if(this._map.attributionControl){var e=this.metadata;var t=e.resourceSets[0].resources[0];var n=this._map.getBounds();var r=t.imageryProviders,i=this._map.getZoom()+1,s="",o,u,a,f,l,c,h;for(u=0,a=r.length;u<a;++u){o=r[u];for(f=0,l=o.coverageAreas.length;f<l;++f){h=o.coverageAreas[f];if(i<=h.zoomMax&&i>=h.zoomMin&&h.bbox.intersects(n)){s+=o.attribution+" ";f=l}}}this._map.attributionControl.removeAttribution(this.attribution);this._map.attributionControl._attributions={};this._map.attributionControl._update();this.attribution=this.attributionTemplate.replace("{logo}",e.brandLogoUri).replace("{copyrights}",s);this._map.attributionControl.addAttribution(this.attribution)}}});L.TileLayer.Bing._callbackId=0;L.TileLayer.Bing.processMetadata=function(e){if(e.authenticationResultCode!="ValidCredentials"){throw"Invalid Bing Maps API Key"}if(!e.resourceSets.length||!e.resourceSets[0].resources.length){throw"No resources returned, perhaps "+this._mapType+" is an invalid map type?"}if(e.statusCode!=200){throw"Bing Maps API request failed with status code "+e.statusCode}this.metadata=e;var t=e.resourceSets[0].resources[0],n=t.imageryProviders,r=0,i,s,o,u=document.getElementById(this._callbackId);for(;r<n.length;r++){s=n[r];for(i=0;i<s.coverageAreas.length;i++){o=s.coverageAreas[i].bbox;s.coverageAreas[i].bbox=new L.LatLngBounds(new L.LatLng(o[0],o[1],true),new L.LatLng(o[2],o[3],true))}}this._url=t.imageUrl.replace("{culture}","en-US");this.options.subdomains=[].concat(t.imageUrlSubdomains);u.parentNode.removeChild(u);window[this._callbackId]=undefined;delete this._callbackId;this._onMetadataLoaded()}
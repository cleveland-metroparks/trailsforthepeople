var MOBILE;var ICON_TARGET=L.icon({iconUrl:"https://maps.clevelandmetroparks.com/static/common/marker-target.png",iconSize:[25,41],iconAnchor:[13,41]});var MARKER_TARGET=L.marker(L.latLng(0,0),{clickable:false,draggable:false,icon:ICON_TARGET});var ICON_GPS=L.icon({iconUrl:"https://maps.clevelandmetroparks.com/static/common/marker-gps.png",iconSize:[25,41],iconAnchor:[13,41]});var MARKER_GPS=L.marker(L.latLng(0,0),{clickable:false,draggable:false,icon:ICON_GPS});var ICON_FROM=L.icon({iconUrl:"https://maps.clevelandmetroparks.com/static/desktop/measure1.png",iconSize:[20,34],iconAnchor:[10,34]});var ICON_TO=L.icon({iconUrl:"https://maps.clevelandmetroparks.com/static/desktop/measure2.png",iconSize:[20,34],iconAnchor:[10,34]});var MARKER_FROM=L.marker(L.latLng(0,0),{clickable:true,draggable:true,icon:ICON_FROM});var MARKER_TO=L.marker(L.latLng(0,0),{clickable:true,draggable:true,icon:ICON_TO});var CIRCLE=new L.Circle(L.latLng(0,0),1);var ELEVATION_PROFILE=null;var DIRECTIONS_TARGET=L.latLng(0,0);var DIRECTIONS_LINE=null;var DIRECTIONS_LINE_STYLE={color:"#0000FF",weight:5,opacity:1,clickable:false,smoothFactor:.25};var HIGHLIGHT_LINE=null;var HIGHLIGHT_LINE_STYLE={color:"#FF00FF",weight:3,opacity:.75,clickable:false,smoothFactor:.25};var URL_PARAMS=null;var SHARE_URL_STRING=null;var ENABLE_MAPCLICK=true;var SKIP_TO_DIRECTIONS=false;L.LatLng.prototype.bearingTo=function(other){var d2r=L.LatLng.DEG_TO_RAD;var r2d=L.LatLng.RAD_TO_DEG;var lat1=this.lat*d2r;var lat2=other.lat*d2r;var dLon=(other.lng-this.lng)*d2r;var y=Math.sin(dLon)*Math.cos(lat2);var x=Math.cos(lat1)*Math.sin(lat2)-Math.sin(lat1)*Math.cos(lat2)*Math.cos(dLon);var brng=Math.atan2(y,x);brng=parseInt(brng*r2d);brng=(brng+360)%360;return brng};L.LatLng.prototype.bearingWordTo=function(other){var bearing=this.bearingTo(other);var bearingword="";if(bearing>=22&&bearing<=67)bearingword="NE";else if(bearing>=67&&bearing<=112)bearingword="E";else if(bearing>=112&&bearing<=157)bearingword="SE";else if(bearing>=157&&bearing<=202)bearingword="S";else if(bearing>=202&&bearing<=247)bearingword="SW";else if(bearing>=247&&bearing<=292)bearingword="W";else if(bearing>=292&&bearing<=337)bearingword="NW";else if(bearing>=337||bearing<=22)bearingword="N";return bearingword};if(!jQuery.fn.tap){jQuery.fn.tap=jQuery.fn.click}else{jQuery.fn.click=jQuery.fn.tap}function initMap(){if(MOBILE)$("#page-settings").page();var base=URL_PARAMS.param("base");if(!base)base="mapbox";var basemap;switch(base){case"photo":var checkbox=$('input[name="basemap"][value="photo"]').prop("checked",true);if(MOBILE)checkbox.checkboxradio("refresh");basemap=PHOTOBASE;break;case"map":var checkbox=$('input[name="basemap"][value="map"]').prop("checked",true);if(MOBILE)checkbox.checkboxradio("refresh");basemap=MAPBASE;break;case"mapbox":var checkbox=$('input[name="basemap"][value="mapbox"]').prop("checked",true);if(MOBILE)checkbox.checkboxradio("refresh");basemap=MAPBOXBASE;break;default:throw"Invalid basemap given?";break}var options={attributionControl:false,zoomControl:true,dragging:true,closePopupOnClick:false,crs:L.CRS.EPSG3857,minZoom:MIN_ZOOM,maxZoom:MAX_ZOOM,layers:[basemap]};var android4=navigator.userAgent.match(/Android (4|5)/);if(android4){options.fadeAnimation=true;options.zoomAnimation=true;options.markerZoomAnimation=true}MAP=new L.Map("map_canvas",options);if(URL_PARAMS.param("x")&&URL_PARAMS.param("y")&&URL_PARAMS.param("z")){var x=parseFloat(URL_PARAMS.param("x"));var y=parseFloat(URL_PARAMS.param("y"));var z=parseInt(URL_PARAMS.param("z"));MAP.setView(L.latLng(y,x),z);MAP.addLayer(MARKER_TARGET);MARKER_TARGET.setLatLng(L.latLng(y,x))}else{MAP.fitBounds(MAX_BOUNDS)}L.control.scale().addTo(MAP);function debugBoundsOutput(){console.log(["zoom",MAP.getZoom()]);console.log(["center",MAP.getCenter()]);console.log(["bounds",MAP.getBounds()])}function debugScaleZoomOutput(){var DOTS_PER_INCH=72;var INCHES_PER_METER=1/.0254000508001016;var INCHES_PER_KM=INCHES_PER_METER*1e3;var sw=MAP.getBounds().getSouthWest();var ne=MAP.getBounds().getNorthEast();var halflng=(sw.lng+ne.lng)/2;var midBottom=L.latLng(sw.lat,halflng);var midTop=L.latLng(ne.lat,halflng);var mheight=midTop.distanceTo(midBottom);var pxheight=MAP.getSize().x;var kmperpx=mheight/pxheight/1e3;var scale=Math.round((kmperpx||1e-6)*INCHES_PER_KM*DOTS_PER_INCH);scale*=2;scale=1e3*Math.round(scale/1e3);console.log(["zoom & scale",MAP.getZoom(),scale])}MAP.on("click",function(event){if(!ENABLE_MAPCLICK)return;if($(".leaflet-popup").length){return MAP.closePopup()}wmsGetFeatureInfoByPoint(event.layerPoint)});if(URL_PARAMS.param("type")&&URL_PARAMS.param("name")){var params={type:URL_PARAMS.param("type"),name:URL_PARAMS.param("name")};$.get("../ajax/exactnamesearch",params,function(reply){if(!reply||!reply.s||!reply.w||!reply.n||!reply.e)return alert("Cound not find that feature.");var box=L.latLngBounds(L.latLng(reply.s,reply.w),L.latLng(reply.n,reply.e));MAP.fitBounds(box);if(reply.lat&&reply.lng){placeTargetMarker(reply.lat,reply.lng)}else if(reply.wkt){HIGHLIGHT_LINE=lineWKTtoFeature(reply.wkt,HIGHLIGHT_LINE_STYLE);MAP.addLayer(HIGHLIGHT_LINE)}},"json")}if(URL_PARAMS.param("routefrom")&&URL_PARAMS.param("routeto")&&URL_PARAMS.param("routevia")){var sourcelat=URL_PARAMS.param("routefrom").split(",")[0];var sourcelng=URL_PARAMS.param("routefrom").split(",")[1];var targetlat=URL_PARAMS.param("routeto").split(",")[0];var targetlng=URL_PARAMS.param("routeto").split(",")[1];var via=URL_PARAMS.param("routevia");var tofrom="to";if(MOBILE)$("#page-getdirections").page();$("#getdirections_disabled").hide();$("#getdirections_enabled").show();$("#directions_target_title").text(URL_PARAMS.param("routetitle"));$("#directions_via").val(URL_PARAMS.param("routevia"));if(MOBILE)$("#directions_via").selectmenu("refresh");$("#directions_type").val("geocode");if(MOBILE)$("#directions_type").selectmenu("refresh");if(MOBILE)$("#directions_type_geocode_wrap").show();else $("#directions_type").change();$("#directions_address").val(URL_PARAMS.param("routefrom"));$("#directions_target_lat").val(targetlat);$("#directions_target_lng").val(targetlng);$("#directions_via").trigger("change");$("#directions_address").val(URL_PARAMS.param("fromaddr"));$("#directions_reverse").val(URL_PARAMS.param("whichway"));$("#directions_via_bike").val(URL_PARAMS.param("routevia_bike"));setTimeout(function(){$("#directions_reverse").trigger("change")},1e3);$("#directions_type").val(URL_PARAMS.param("loctype"));getDirections(sourcelat,sourcelng,targetlat,targetlng,tofrom,via)}$("#share_url").click(function(){$(this).select()});MAP.on("moveend",updateShareUrl);MAP.on("zoomend",updateShareUrl);MAP.on("layerremove",updateShareUrl);MAP.on("layeradd",updateShareUrl);updateShareUrl()}function lineWKTtoFeature(wkt,style){var parser=new Wkt.Wkt;parser.read(wkt);return parser.toObject(style)}function WSENtoBounds(west,south,east,north){return L.latLngBounds([[south,west],[north,east]])}function selectBasemap(which){switch(which){case"photo":if(MAP.hasLayer(MAPBASE))MAP.removeLayer(MAPBASE);if(MAP.hasLayer(MAPBOXBASE))MAP.removeLayer(MAPBOXBASE);if(!MAP.hasLayer(PHOTOBASE))MAP.addLayer(PHOTOBASE,true);PHOTOBASE.bringToBack();break;case"map":if(MAP.hasLayer(PHOTOBASE))MAP.removeLayer(PHOTOBASE);if(MAP.hasLayer(MAPBOXBASE))MAP.removeLayer(MAPBOXBASE);if(!MAP.hasLayer(MAPBASE))MAP.addLayer(MAPBASE,true);MAPBASE.bringToBack();break;case"mapbox":if(MAP.hasLayer(MAPBASE))MAP.removeLayer(MAPBASE);if(MAP.hasLayer(PHOTOBASE))MAP.removeLayer(PHOTOBASE);if(!MAP.hasLayer(MAPBOXBASE))MAP.addLayer(MAPBOXBASE,true);MAPBOXBASE.bringToBack();break}}function placeTargetMarker(lat,lon){MAP.addLayer(MARKER_TARGET);MARKER_TARGET.setLatLng(L.latLng(lat,lon))}function clearTargetMarker(){MAP.removeLayer(MARKER_TARGET)}function placeGPSMarker(lat,lon){MAP.addLayer(MARKER_GPS);MARKER_GPS.setLatLng(L.latLng(lat,lon))}function clearGPSMarker(){MAP.removeLayer(MARKER_GPS)}function placeCircle(lat,lon,meters){MAP.removeLayer(CIRCLE);CIRCLE.setLatLng(L.latLng(lat,lon));CIRCLE.setRadius(meters);MAP.addLayer(CIRCLE)}function clearCircle(){CIRCLE.setLatLng(L.latLng(0,0));CIRCLE.setRadius(1);MAP.removeLayer(CIRCLE)}function strToLatLng(text){var text=text.replace(/\s+$/,"").replace(/^\s+/,"");if(text.match(/^[\d\.\-\,\s]+$/)){var dd=text.split(/[\s\,]+/);if(dd.length==2){dd[0]=parseFloat(dd[0]);dd[1]=parseFloat(dd[1]);if(dd[0]&&dd[1]){var lat,lng;if(dd[0]<0){lat=dd[1];lng=dd[0]}else{lat=dd[0];lng=dd[1]}return L.latLng([lat,lng])}}}var gps=text.match(/^N\s*(\d\d)\s+(\d\d\.\d\d\d)\s+W\s*(\d\d\d)\s+(\d\d\.\d\d\d)$/i);if(gps){var latd=parseInt(gps[1]);var latm=parseInt(gps[2]);var lond=parseInt(gps[3]);var lonm=parseInt(gps[4]);var lat=latd+latm/60;var lng=-lond-lonm/60;return L.latLng([lat,lng])}return null}function zoomToAddress(searchtext){if(!searchtext)return false;var params={};params.address=searchtext;params.bing_key=BING_API_KEY;params.bbox=GEOCODE_BIAS_BOX;$.get("../ajax/geocode",params,function(result){if(!result)return alert("We couldn't find that address or city.\nPlease try again.");var latlng=L.latLng(result.lat,result.lng);if(!MAX_BOUNDS.contains(latlng)){return alert("The only results we could find are too far away to zoom the map there.")}switchToMap(function(){MAP.setView(latlng,16);placeTargetMarker(result.lat,result.lng);var html="";html+='<h3 class="popup_title">'+result.title+"</h3>";html+='<span class="fakelink zoom" title="'+result.title+'" lat="'+result.lat+'" lng="'+result.lng+'" w="'+result.w+'" s="'+result.s+'" e="'+result.e+'" n="'+result.n+'" onClick="zoomElementClick( $(this) );">Directions</span>';var popup=new L.Popup;popup.setLatLng(latlng);popup.setContent(html);MAP.openPopup(popup)})},"json")}function wmsGetFeatureInfoByPoint(pixel){var pixelbuffer=20;var sw=MAP.layerPointToLatLng(new L.Point(pixel.x-pixelbuffer,pixel.y+pixelbuffer));var ne=MAP.layerPointToLatLng(new L.Point(pixel.x+pixelbuffer,pixel.y-pixelbuffer));var bbox={w:sw.lng,s:sw.lat,e:ne.lng,n:ne.lat};var anchor=MAP.layerPointToLatLng(new L.Point(pixel.x,pixel.y));wmsGetFeatureInfoByLatLngBBOX(bbox,anchor)}function wmsGetFeatureInfoByLatLng(latlng){var bbox={w:latlng.lng,s:latlng.lat,e:latlng.lng,n:latlng.lat};var anchor=latlng;wmsGetFeatureInfoByLatLngBBOX(bbox,anchor)}function wmsGetFeatureInfoByLatLngBBOX(bbox,anchor){var data=bbox;data.zoom=MAP.getZoom();$.get("../ajax/query",data,function(html){if(!html)return;var options={};options.maxHeight=parseInt($("#map_canvas").height()-$("#toolbar").height());options.maxWidth=parseInt($("#map_canvas").width());var popup=new L.Popup(options);popup.setLatLng(anchor);popup.setContent(html);MAP.openPopup(popup)},"html")}$(window).resize(function(){MAP.invalidateSize()});$(window).load(function(){var thisCallback=function(){var address=$("#geocode_text").val();zoomToAddress(address)};$("#geocode_button").tap(thisCallback);$("#geocode_text").keydown(function(key){if(key.keyCode==13)$("#geocode_button").tap()})});$(window).load(function(){var openDetailsPanel=function(){zoomElementClick($(this))};$(".zoom").tap(openDetailsPanel);var showOnMap=function(){var element=$(this).data("zoomelement");if(element){var w=element.attr("w");var s=element.attr("s");var e=element.attr("e");var n=element.attr("n");var x=element.attr("lng");var y=element.attr("lat");var type=element.attr("type");var wkt=$(this).data("wkt");switchToMap(function(){var bounds=L.latLngBounds(L.latLng(s,w),L.latLng(n,e));bounds=bounds.pad(.15);MAP.fitBounds(bounds);if(type=="poi"||type=="loop")placeTargetMarker(y,x);if(wkt){if(HIGHLIGHT_LINE){MAP.removeLayer(HIGHLIGHT_LINE);HIGHLIGHT_LINE=null}HIGHLIGHT_LINE=lineWKTtoFeature(wkt,HIGHLIGHT_LINE_STYLE);MAP.addLayer(HIGHLIGHT_LINE)}})}};$("#show_on_map").tap(showOnMap)});$(window).load(function(){$('input[type="radio"][name="basemap"]').change(function(){var which=$(this).val();selectBasemap(which)})});$(window).load(function(){$("#getdirections_clear").click(function(){clearDirectionsLine();$("#directions_steps").empty()});$("#directions_via").change(function(){$("#directions_via_bike_wrap").hide();var which=$(this).val();switch(which){case"bike":$("#directions_via_bike_wrap").show();break;case"hike":break;case"car":break;default:break}})});function processGetDirectionsForm(){var tofrom=$("#directions_reverse").val();var via=$("#directions_via").val();switch(via){case"hike":via="hike";break;case"bike":via=$("#directions_via_bike").val();break}$("#directions_source_gid").val("");$("#directions_source_type").val("");$.ajaxSetup({async:false});var sourcelat,sourcelng;var addresstype=$("#directions_type").val();switch(addresstype){case"gps":sourcelat=LAST_KNOWN_LOCATION.lat;sourcelng=LAST_KNOWN_LOCATION.lng;break;case"geocode":var address=$("#directions_address").val();if(!address)return alert("Please enter an address, city, or landmark.");var is_coords=/^(\d+\.\d+)\,(\-\d+\.\d+)$/.exec(address);if(is_coords){sourcelat=parseFloat(is_coords[1]);sourcelng=parseFloat(is_coords[2]);getDirections(sourcelat,sourcelng,targetlat,targetlng,tofrom,via)}else{disableDirectionsButton();var params={};params.address=address;params.bing_key=BING_API_KEY;params.bbox=GEOCODE_BIAS_BOX;$.get("../ajax/geocode",params,function(result){enableDirectionsButton();if(!result)return alert("We couldn't find that address or city.\nPlease try again.");sourcelat=result.lat;sourcelng=result.lng;if(!MAX_BOUNDS.contains(L.latLng(sourcelat,sourcelng))){var from="adr."+address;var to="pos."+targetlat+"_"+targetlng;var params={rtp:from+"~"+to};var gmapsurl="http://bing.com/maps/default.aspx"+"?"+$.param(params);var target=$("#directions_steps");target.empty();target.append($("<div></div>").html("The address you have chosen is outside of the covered area.<br/>Click the link below to go to Bing Maps for directions."));target.append($("<a></a>").text("Click here for directions from Bing Maps").prop("href",gmapsurl).prop("target","_blank"));return}},"json")}break;case"features":disableDirectionsButton();var params={};params.keyword=$("#directions_address").val();params.limit=30;params.lat=MOBILE?LAST_KNOWN_LOCATION.lat:MAP.getCenter().lat;params.lng=MOBILE?LAST_KNOWN_LOCATION.lng:MAP.getCenter().lng;params.via=via;$.get("../ajax/keyword",params,function(reply){enableDirectionsButton();if(!reply||!reply.length)return alert("We couldn't find any matching landmarks.");var matchme=$("#directions_address").val().replace(/\W/g,"").toLowerCase();for(var i=0,l=reply.length;i<l;i++){var stripped=reply[i].name.replace(/\W/g,"").toLowerCase();if(stripped==matchme){reply=[reply[i]];break}}if(reply.length>1){sourcelat=null;sourcelng=null;populateDidYouMean(reply);return}var placename=reply[0].name.replace(/^\s*/,"").replace(/\s*$/,"");$("#directions_address").val(placename);$("#directions_source_gid").val(reply[0].gid);$("#directions_source_type").val(reply[0].type);sourcelat=parseFloat(reply[0].lat);sourcelng=parseFloat(reply[0].lng)},"json");if(!sourcelat||!sourcelng)return;break}var targetlat=parseFloat($("#directions_target_lat").val());var targetlng=parseFloat($("#directions_target_lng").val());var source_gid=$("#directions_source_gid").val();var source_type=$("#directions_source_type").val();if(source_type=="poi"||source_type=="reservation"||source_type=="building"||source_type=="trail"){var params={};params.type=source_type;params.gid=source_gid;params.lat=targetlat;params.lng=targetlng;params.via=via;$.get("../ajax/geocode_for_directions",params,function(reply){sourcelat=reply.lat;sourcelng=reply.lng;$("#directions_source_lat").val(reply.lat);$("#directions_source_lng").val(reply.lng)},"json")}var target_gid=$("#directions_target_gid").val();var target_type=$("#directions_target_type").val();if(target_type=="poi"||target_type=="reservation"||target_type=="building"||target_type=="trail"){var params={};params.type=target_type;params.gid=target_gid;params.lat=sourcelat;params.lng=sourcelng;params.via=via;$.get("../ajax/geocode_for_directions",params,function(reply){targetlat=reply.lat;targetlng=reply.lng;$("#directions_target_lat").val(reply.lat);$("#directions_target_lng").val(reply.lng)},"json")}if(!targetlat||!targetlng)return alert("Please close the directions panel, and pick a location.");$.ajaxSetup({async:true});getDirections(sourcelat,sourcelng,targetlat,targetlng,tofrom,via)}function populateDidYouMean(results){var target=$("#directions_steps");target.empty();var item=$("<li></li>").append($("<span></span>").addClass("ui-li-heading").text("Did you mean one of these?"));target.append(item);for(var i=0,l=results.length;i<l;i++){var result=results[i];var placename=result.name.replace(/^\s*/,"").replace(/\s*$/,"");var item=$("<li></li>");item.append($("<span></span>").addClass("ui-li-heading").text(placename)).attr("type",result.type).attr("gid",result.gid);var tapToFill=function(){$("#directions_address").val($(this).text());$("#directions_source_gid").val($(this).attr("gid"));$("#directions_source_type").val($(this).attr("type"));$("#directions_button").click()};if(MOBILE)item.tap(tapToFill);else item.click(tapToFill);item.css({cursor:"pointer"});target.append(item)}if(MOBILE)target.listview("refresh")}function getDirections(sourcelat,sourcelng,targetlat,targetlng,tofrom,via){$("#directions_steps").empty();disableDirectionsButton();$("#directions_source_lat").val(sourcelat);$("#directions_source_lng").val(sourcelng);var prefer=$("#directions_prefer").val();var params={sourcelat:sourcelat,sourcelng:sourcelng,targetlat:targetlat,targetlng:targetlng,tofrom:tofrom,via:via,prefer:prefer,bing_key:BING_API_KEY};$.get("../ajax/directions",params,function(reply){enableDirectionsButton();if(!reply||!reply.wkt){var message="Could not find directions.";if(via!="hike")message+="\nTry a different type of trail, terrain, or difficulty.";return alert(message)}renderDirectionsStructure(reply)},"json")}function disableDirectionsButton(){var button=$("#directions_button");if(MOBILE){button.button("disable");button.closest(".ui-btn").find(".ui-btn-text").text(button.attr("value0"))}else{button.prop("disabled",true);button.val(button.attr("value0"))}}function enableDirectionsButton(){var button=$("#directions_button");if(MOBILE){button.button("enable");button.closest(".ui-btn").find(".ui-btn-text").text(button.attr("value1"))}else{button.prop("disabled",false);button.val(button.attr("value1"))}}function renderDirectionsStructure(directions,target,options){if(!options)options={};clearDirectionsLine();var polyline=lineWKTtoFeature(directions.wkt,DIRECTIONS_LINE_STYLE);var startpoint=L.latLng(directions.start.lat,directions.start.lng);var endpoint=L.latLng(directions.end.lat,directions.end.lng);placeDirectionsLine(polyline,startpoint,endpoint);DIRECTIONS_LINE.extent=WSENtoBounds(directions.bounds.west,directions.bounds.south,directions.bounds.east,directions.bounds.north);if(!MOBILE||$.mobile.activePage.prop("id")=="page-map"){var bbox=DIRECTIONS_LINE.extent.pad(.15);MAP.fitBounds(bbox)}if(!target)target=$("#directions_steps");target.empty();for(var i=0,l=directions.steps.length;i<l;i++){var step=directions.steps[i];var li=$("<li></li>");var title=step.stepnumber?step.stepnumber+". "+(step.turnword?step.turnword:"")+" "+step.text:step.turnword+" "+step.text;li.append($("<span></span>").addClass("ui-li-heading").text(title));if(step.distance&&step.duration&&step.distance.substr(0,1)!="0"){var subtitle=step.distance+", "+step.duration;li.append($("<span></span>").addClass("ui-li-desc").text(subtitle))}target.append(li)}var note=$("<span></span>").addClass("ui-li-desc").html("");if(directions.retries&&directions.retries>3){note.html("Route may be approximated.")}var total=$("<span></span>").addClass("ui-li-heading").html("<b>Total:</b> "+directions.totals.distance+", "+directions.totals.duration);target.append($("<li></li>").append(total).append(note));var funcs=$("<li></li>").addClass("directions_functions");if(directions.elevationprofile){var profile=$("<img></img>").prop("title","Elevation Profile").prop("id","elevationprofile_button").addClass("fakelink").prop("src","/static/common/elevprofile.png");profile.attr("value1","Elevation Profile").attr("value0","Loading");profile.tap(function(){openElevationProfileBySegments()});funcs.append(profile)}if(MOBILE){funcs.append("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");var showonmap=$("<img></img>").prop("title","Map").addClass("fakelink").prop("src","/static/common/map.png");showonmap.tap(function(){switchToMap(function(){if(DIRECTIONS_LINE)MAP.fitBounds(DIRECTIONS_LINE.extent)})});funcs.append(showonmap);var clearmap=$("<img></img>").prop("title","Clear").addClass("fakelink").prop("src","/static/common/smallclear.png");clearmap.tap(function(){$("#directions_steps").empty();clearDirectionsLine()});funcs.append(clearmap)}if(!options.noshare){var shareroute=$("<img></img>").prop("title","Share").addClass("fakelink").prop("id","share_route_button").prop("src","/static/common/share.png");shareroute.click(function(){updateShareUrlByDirections();if(MOBILE){$.mobile.changePage("#page-share")}else{$(".dialog").dialog("close");$("#share").dialog("open")}});funcs.append(shareroute)}if(!MOBILE){var printme=$("<img></img>").attr("title","Print").addClass("fakelink").prop("src","/static/common/print.png");printme.click(function(){$("#button_print").click()});funcs.append(printme)}target.append(funcs);ELEVATION_PROFILE=[];if(directions.elevationprofile){ELEVATION_PROFILE=directions.elevationprofile}if(MOBILE){target.listview("refresh");$(".directions_functions img:first").removeClass("ui-li-thumb")}}function clearDirectionsLine(){if(DIRECTIONS_LINE){MAP.removeLayer(DIRECTIONS_LINE);DIRECTIONS_LINE=null}if(MAP.hasLayer(MARKER_FROM)){MARKER_FROM.setLatLng(L.latLng(0,0));MAP.removeLayer(MARKER_FROM)}if(MAP.hasLayer(MARKER_TO)){MARKER_TO.setLatLng(L.latLng(0,0));MAP.removeLayer(MARKER_TO)}$("#directions_steps").empty();$("#measure_steps").empty()}function placeDirectionsLine(polyline,startll,endll){DIRECTIONS_LINE=polyline;MAP.addLayer(DIRECTIONS_LINE);MARKER_FROM.setLatLng(startll);MAP.addLayer(MARKER_FROM);MARKER_TO.setLatLng(endll);MAP.addLayer(MARKER_TO);MARKER_FROM.dragging.disable();MARKER_TO.dragging.disable()}function openElevationProfileBySegments(){if(!ELEVATION_PROFILE)return;var x=[];var y=[];for(var i=0,l=ELEVATION_PROFILE.length;i<l;i++){x[x.length]=ELEVATION_PROFILE[i].x;y[y.length]=ELEVATION_PROFILE[i].y}x=x.join(",");y=y.join(",");$.post("../ajax/elevationprofilebysegments",{x:x,y:y},function(url){if(url.indexOf("http")!=0)return alert(url);showElevation(url)})}function disableKeywordButton(){var button=$("#search_keyword_button");if(MOBILE){button.button("disable");button.closest(".ui-btn").find(".ui-btn-text").text(button.attr("value0"))}else{button.prop("disabled",true);button.val(button.attr("value0"))}}function enableKeywordButton(){var button=$("#search_keyword_button");if(MOBILE){button.button("enable");button.closest(".ui-btn").find(".ui-btn-text").text(button.attr("value1"))}else{button.prop("disabled",false);button.val(button.attr("value1"))}}function printMapPrepare(){$("#print_waiting").show();$("#print_ready").hide()}function printMapDone(url){$("#print_waiting").hide();if(url){$("#print_link").prop("href",url);$("#print_ready").show()}}function printMap(){var comment=$("#print_comment").val();var paper=$("#print_paper").val();var page2title="";var page2text1="";var page2text2="";var mapwidth=PRINT_SIZES[paper][0];var mapheight=PRINT_SIZES[paper][1];var pixelcenter=MAP.latLngToLayerPoint(MAP.getCenter());var sw=wgsToLocalSRS(MAP.layerPointToLatLng(new L.Point(pixelcenter.x-mapwidth/2,pixelcenter.y+mapheight/2)));var ne=wgsToLocalSRS(MAP.layerPointToLatLng(new L.Point(pixelcenter.x+mapwidth/2,pixelcenter.y-mapheight/2)));var projbbox=[sw[0],sw[1],ne[0],ne[1]];var wmsparams={format_options:"dpi:300"};var layers=[];if(MAP.hasLayer(PHOTOBASE)){if(MAP.getZoom()<14)return alert("Before printing, zoom in closer.");layers[layers.length]={baseURL:"http://maps.clevelandmetroparks.com/proxy/ohioimagery",opacity:1,singleTile:false,type:"WMS",layers:["0"],format:"image/png",styles:[""]}}if(MAP.hasLayer(MAPBASE)){layers[layers.length]={baseURL:"http://maps.clevelandmetroparks.com/gwms",opacity:1,singleTile:true,type:"WMS",layers:["group_basemap"],format:"image/jpeg",styles:[""],customParams:wmsparams};layers[layers.length]={baseURL:"http://maps.clevelandmetroparks.com/gwms",opacity:1,singleTile:true,type:"WMS",layers:["cm:trails","cm:closures","cm:markers_other","cm:markers_swgh"],format:"image/png",styles:"",customParams:wmsparams}}if(DIRECTIONS_LINE&&MAP.hasLayer(DIRECTIONS_LINE)){var vertices=[];for(var li in DIRECTIONS_LINE._layers){var subline=DIRECTIONS_LINE._layers[li];var subverts=[];for(var i=0,l=subline._latlngs.length;i<l;i++){subverts[subverts.length]=wgsToLocalSRS([subline._latlngs[i].lng,subline._latlngs[i].lat])}vertices[vertices.length]=subverts}var opacity=DIRECTIONS_LINE_STYLE.opacity;var color=DIRECTIONS_LINE_STYLE.color;var weight=3;layers[layers.length]={type:"Vector",name:"Directions Line",opacity:opacity,styles:{"default":{strokeColor:color,strokeWidth:weight,strokeLinecap:"round"}},styleProperty:"style_index",geoJson:{type:"FeatureCollection",features:[{type:"Feature",properties:{style_index:"default"},geometry:{type:"MultiLineString",coordinates:vertices}}]}};var iconurl=ICON_FROM.options.iconUrl.replace("maps.clevelandmetroparks.com","10.0.0.23").replace("https:","http:");var projdot=wgsToLocalSRS(MARKER_FROM.getLatLng());var iconxoff=-10;var iconyoff=0;var iconsize=15;layers[layers.length]={type:"Vector",name:"Target Marker",opacity:1,styleProperty:"style_index",styles:{"default":{externalGraphic:iconurl,fillOpacity:1,pointRadius:iconsize,graphicXOffset:iconxoff,graphicYOffset:iconyoff}},geoJson:{type:"FeatureCollection",features:[{type:"Feature",properties:{style_index:"default"},geometry:{type:"Point",coordinates:projdot}}]}};var iconurl=ICON_TO.options.iconUrl.replace("maps.clevelandmetroparks.com","10.0.0.23").replace("https:","http:");var projdot=wgsToLocalSRS(MARKER_TO.getLatLng());var iconxoff=-10;var iconyoff=0;var iconsize=15;layers[layers.length]={type:"Vector",name:"Target Marker",opacity:1,styleProperty:"style_index",styles:{"default":{externalGraphic:iconurl,fillOpacity:1,pointRadius:iconsize,graphicXOffset:iconxoff,graphicYOffset:iconyoff}},geoJson:{type:"FeatureCollection",features:[{type:"Feature",properties:{style_index:"default"},geometry:{type:"Point",coordinates:projdot}}]}};paper+=" with directions";var tofrom1=$("#directions_reverse").val();var tofrom2=tofrom1=="to"?"from":"to";var placename=$("#directions_target_title").text();var addrname=$("#directions_address").val();var via=$("#directions_via option:selected").text().toLowerCase();var steps;if(tofrom1&&tofrom2&&placename&&addrname){page2title="Directions\n"+tofrom1+" "+placename+"\n"+tofrom2+" "+addrname+"\n"+via;steps=$("#directions_steps li")}else{page2title="Measurement directions";steps=$("#measure_steps li")}var maxstepsperpage=25;switch(paper){case"Letter portrait with directions":maxstepsperpage=40;break;case"Letter landscape with directions":maxstepsperpage=31;break;case"Ledger portrait with directions":maxstepsperpage=65;break;case"Ledger landscape with directions":maxstepsperpage=45;break}page2text1=[];page2text2=[];steps.each(function(){var steptext=$(this).find(".ui-li-heading").eq(0).text();var timedist=$(this).find(".ui-li-desc").eq(0).text();var linetext=steptext+"\n"+"     "+timedist;if(page2text1.length<maxstepsperpage)page2text1[page2text1.length]=linetext;else page2text2[page2text2.length]=linetext});page2text1=page2text1.join("\n");page2text2=page2text2.join("\n")}if(HIGHLIGHT_LINE&&MAP.hasLayer(HIGHLIGHT_LINE)){var vertices=[];var lines=HIGHLIGHT_LINE.getLatLngs();for(var li=0,ll=lines.length;li<ll;li++){var thisline=[];for(vi=0,vl=lines[li].length;vi<vl;vi++){thisline[thisline.length]=wgsToLocalSRS([lines[li][vi].lng,lines[li][vi].lat])}vertices[vertices.length]=thisline}var opacity=HIGHLIGHT_LINE_STYLE.opacity;var color=HIGHLIGHT_LINE_STYLE.color;var weight=3;layers[layers.length]={type:"Vector",name:"Highlight Line",opacity:opacity,styles:{"default":{strokeColor:color,strokeWidth:weight,strokeLinecap:"round"}},styleProperty:"style_index",geoJson:{type:"FeatureCollection",features:[{type:"Feature",properties:{style_index:"default"},geometry:{type:"MultiLineString",coordinates:vertices}}]}};var whats_showing=$("#show_on_map").data("zoomelement").attr("type");if(whats_showing=="loop"){var steps=$("#moreinfo_steps li");paper+=" with directions";page2title=$("#show_on_map").data("zoomelement").attr("title");var maxstepsperpage=25;switch(paper){case"Letter portrait with directions":maxstepsperpage=40;break;case"Letter landscape with directions":maxstepsperpage=31;break;case"Ledger portrait with directions":maxstepsperpage=65;break;case"Ledger landscape with directions":maxstepsperpage=45;break}page2text1=[];page2text2=[];steps.each(function(){var steptext=$(this).find(".ui-li-heading").eq(0).text();var timedist=$(this).find(".ui-li-desc").eq(0).text();var linetext=steptext+"\n"+"     "+timedist;if(page2text1.length<maxstepsperpage)page2text1[page2text1.length]=linetext;else page2text2[page2text2.length]=linetext});page2text1=page2text1.join("\n");page2text2=page2text2.join("\n")}}if(MARKER_TARGET&&MAP.hasLayer(MARKER_TARGET)){var iconurl=ICON_TARGET.options.iconUrl;var projdot=wgsToLocalSRS(MARKER_TARGET.getLatLng());var iconxoff=-10;var iconyoff=0;var iconsize=15;layers[layers.length]={type:"Vector",name:"Target Marker",opacity:1,styleProperty:"style_index",styles:{"default":{externalGraphic:iconurl,fillOpacity:1,pointRadius:iconsize,graphicXOffset:iconxoff,graphicYOffset:iconyoff}},geoJson:{type:"FeatureCollection",features:[{type:"Feature",properties:{style_index:"default"},geometry:{type:"Point",coordinates:projdot}}]}}}var params={units:"feet",srs:"EPSG:3734",layout:paper,dpi:300,layers:layers,pages:[{bbox:projbbox,rotation:"0",comment:comment}],layersMerging:true,page2title:page2title,page2text1:page2text1,page2text2:page2text2};printMapPrepare();$.ajax({url:PRINT_URL,type:"POST",data:JSON.stringify(params),processData:false,contentType:"application/json",success:function(reply){var url=reply.getURL;url=url.split("/");url=url[url.length-1];url=PRINT_PICKUP_BASEURL+url;printMapDone(url)},error:function(xhr,status,text){alert("Printing failed. Please try again.");printMapDone()}})}function wgsToLocalSRS(dot){var srsin=new Proj4js.Proj("EPSG:4326");var srsout=new Proj4js.Proj("EPSG:3734");var newdot=dot.lat?new Proj4js.Point(dot.lng,dot.lat):new Proj4js.Point(dot[0],dot[1]);Proj4js.transform(srsin,srsout,newdot);return[newdot.x,newdot.y]}function loadTwitter(){var target=$("#tweets");target.empty();target.append($("<tr></tr>").append($("<td></td>").text("Loading...")));var params={};$.get("../ajax/fetch_tweets",params,function(tweets){target.empty();for(var i=0,l=tweets.length;i<l;i++){var tweet=tweets[i];var row=$("<tr></tr>");var cell1=$("<td></td>").addClass("twitter_lhs");var userpic=$("<img></img>").prop("src",tweet.picture);var userlink=$("<a></a>").prop("target","_blank").text(tweet.username).prop("href","http://twitter.com/"+tweet.username);cell1.append(userpic);cell1.append($("<br></br>"));cell1.append(userlink);var cell2=$("<td></td>").addClass("twitter_rhs");var content=$("<span></span>").html(tweet.prettydate+": "+tweet.content);cell2.append(content);row.append(cell1);row.append(cell2);target.append(row)}},"json")}$(window).load(function(){if(MOBILE)$("#page-trailfinder").page();$("#trailfinder_typeicons img").tap(function(){var $this=$(this);var value=$this.attr("data-value");$('input[name="trailfinder_uses"]').removeAttr("checked").filter('[value="'+value+'"]').attr("checked","checked");$("#trailfinder_typeicons img").each(function(){var src=$(this).prop("src");if($(this).is($this)){src=src.replace("_off.png","_on.png")}else{src=src.replace("_on.png","_off.png")}$(this).prop("src",src)});$("#trailfinder_go").click()}).first().tap();$("#trailfinder_go").click(function(){
var params={};params.reservation=$('select[name="trailfinder_reservation"]').val();params.paved=$('select[name="trailfinder_paved"]').val();params.uses=[];$('input[name="trailfinder_uses"]:checked').each(function(){params.uses[params.uses.length]=$(this).val()});params.uses=params.uses.join(",");searchTrails(params)});$('select[name="trailfinder_reservation"]').change(function(){$("#trailfinder_go").click()});$('select[name="trailfinder_paved"]').change(function(){$("#trailfinder_go").click()})});function searchTrails(params){var target=$("#trailfinder_results");target.empty();var button=$("#trailfinder_go");if(MOBILE){$("#page-trailfinder .sortpicker").hide();button.button("disable");button.closest(".ui-btn").find(".ui-btn-text").text(button.attr("value0"))}else{button.prop("disabled",true);button.val(button.attr("value0"))}$.get("../ajax/search_trails",params,function(results){if(MOBILE){$("#page-trailfinder .sortpicker").show();button.button("enable");button.closest(".ui-btn").find(".ui-btn-text").text(button.attr("value1"))}else{button.prop("disabled",false);button.val(button.attr("value1"))}if(results.length){for(var i=0,l=results.length;i<l;i++){var result=results[i];var li=$("<li></li>").addClass("zoom");li.attr("title",result.name);li.attr("gid",result.gid).attr("type",result.type).attr("w",result.w).attr("s",result.s).attr("e",result.e).attr("n",result.n).attr("lat",result.lat).attr("lng",result.lng);li.attr("backbutton","#page-trailfinder");var div=$("<div></div>").addClass("ui-btn-text");div.append($("<span></span>").addClass("ui-li-heading").text(result.name));if(result.note){div.append($("<span></span>").addClass("ui-li-desc").html(result.note))}if(MOBILE){div.append($("<span></span>").addClass("zoom_distance").addClass("ui-li-count").addClass("ui-btn-up-c").addClass("ui-btn-corner-all").text("0 mi"))}li.click(function(){zoomElementClick($(this))});li.append(div);target.append(li)}}else{target.append($("<li></li>").text("No results."))}if(MOBILE)target.listview("refresh");if(MOBILE)sortLists(target)},"json")}function populateShareBox(){var params={uri:URL_PARAMS.attr("path"),querystring:SHARE_URL_STRING};$.get("../ajax/make_shorturl",params,function(shortstring){if(!shortstring)return alert("Unable to fetch a short URL.\nPlease try again.");var url=URL_PARAMS.attr("protocol")+"://"+URL_PARAMS.attr("host")+"/url/"+shortstring;if(MOBILE){$("#share_url").text(url)}else{$("#share_url").val(url)}})}function updateShareUrl(){var params={};params.z=MAP.getZoom();params.x=MAP.getCenter().lng;params.y=MAP.getCenter().lat;if(MAP.hasLayer(PHOTOBASE))params.base="photo";if(MAP.hasLayer(MAPBASE))params.base="map";if(MAP.hasLayer(MAPBOXBASE))params.base="mapbox";SHARE_URL_STRING=$.param(params)}function updateShareUrlByFeature(element){var params={};params.type=element.attr("type");params.name=element.attr("title");SHARE_URL_STRING=$.param(params)}function updateShareUrlByDirections(){if(!$("#directions_source_lat").val())return;var params={};if(MAP.hasLayer(PHOTOBASE))params.base="photo";if(MAP.hasLayer(MAPBASE))params.base="map";params.routevia=$("#directions_via").val();params.routevia_bike=$("#directions_via_bike").val();params.routefrom=$("#directions_source_lat").val()+","+$("#directions_source_lng").val();params.routeto=$("#directions_target_lat").val()+","+$("#directions_target_lng").val();params.routetitle=$("#directions_target_title").text();params.whichway=$("#directions_reverse").val();params.loctype=$("#directions_type").val();params.fromaddr=$("#directions_address").val();if(params.routevia=="trail")params.routevia=$("#directions_via_trail").val();SHARE_URL_STRING=$.param(params)}$(window).load(function(){if(MOBILE){$("#page-settings").page();$("#page-welcome").page()}var show_welcome=cookieGet("show_welcome");if(show_welcome){$("#settings_show_welcome").prop("checked","checked");if(MOBILE)$("#settings_show_welcome").checkboxradio("refresh");$("#show_welcome").prop("checked","checked");if(MOBILE)$("#show_welcome").checkboxradio("refresh")}else{$("#settings_show_welcome").removeAttr("checked");if(MOBILE)$("#settings_show_welcome").checkboxradio("refresh");$("#show_welcome").prop("checked","checked");if(MOBILE)$("#show_welcome").checkboxradio("refresh")}$("#show_welcome").change(function(){toggleWelcome($(this).is(":checked"))});$("#settings_show_welcome").change(function(){toggleWelcome($(this).is(":checked"))})});function toggleWelcome(show_welcome){if(show_welcome){cookieSet("show_welcome",1)}else{cookieDelete("show_welcome")}}$(window).load(function(){$("#share_feature").click(function(){var element=$("#show_on_map").data("zoomelement");if(!element)return;updateShareUrlByFeature(element);if(!MOBILE)$("#share").dialog("open")})});

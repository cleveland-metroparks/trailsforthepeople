var WEBAPP_BASEPATH="/",API_BASEPATH="/",MAP=null,API_NEW_HOST="maps-api.clevelandmetroparks.com",API_NEW_PROTOCOL="https:",API_NEW_BASEPATH="/api/v1/",API_NEW_BASE_URL=API_NEW_PROTOCOL+"//"+API_NEW_HOST+API_NEW_BASEPATH,WEBAPP_BASE_URL_ABSOLUTE_PROTOCOL="https:",WEBAPP_BASE_URL_ABSOLUTE_HOST="maps.clevelandmetroparks.com",WEBAPP_BASE_URL_ABSOLUTE=WEBAPP_BASE_URL_ABSOLUTE_PROTOCOL+"//"+WEBAPP_BASE_URL_ABSOLUTE_HOST+"/",CM_SITE_BASEURL="https://www.clevelandmetroparks.com/",MAX_BOUND_SW=new mapboxgl.LngLat(-82.08504,41.11816),MAX_BOUND_NE=new mapboxgl.LngLat(-81.28029,41.70009),MAX_BOUNDS=new mapboxgl.LngLatBounds(MAX_BOUND_SW,MAX_BOUND_NE),DEFAULT_POI_ZOOM=15,GEOCODE_BIAS_BOX="41.202048178648, -81.9627793163304, 41.5885467839419, -81.386224018357",PRINT_URL="/pdf/create.json",PRINT_PICKUP_BASEURL="/pdf/",BING_API_KEY="AjBuYw8goYn_CWiqk65Rbf_Cm-j1QFPH-gGfOxjBipxuEB2N3n9yACKu5s8Dl18N",PRINT_SIZES={"Letter portrait":[580,714],"Letter landscape":[762,526],"Ledger portrait":[744,1126],"Ledger landscape":[1178,690]},START_CENTER=[-81.673,41.3953],START_ZOOM=14;mapboxgl.accessToken="pk.eyJ1IjoiY2xldmVsYW5kLW1ldHJvcGFya3MiLCJhIjoiWHRKaDhuRSJ9.FGqNSOHwiCr2dmTH2JTMAA";var ctrlGeolocate,STYLE_LAYER_CM_MAP="mapbox://styles/cleveland-metroparks/cisvvmgwe00112xlk4jnmrehn?optimize=true",STYLE_LAYER_CM_SAT="mapbox://styles/cleveland-metroparks/cjcutetjg07892ro6wunp2da9?optimize=true",STYLE_LAYERS={map:STYLE_LAYER_CM_MAP,photo:STYLE_LAYER_CM_SAT},STYLE_NAMES={"CM Light":"map","CM-Aerial":"photo"},isMobile=/Mobi/.test(navigator.userAgent),MARKER_TARGET=new mapboxgl.Marker({color:"#207FD0"}),MARKER_START=new mapboxgl.Marker({color:"#6BB03E"}),MARKER_END=new mapboxgl.Marker({color:"#FF7866"}),SKIP_TO_DIRECTIONS=!1,SETTINGS=[];function initMap(e){var t;switch(e.base||"map"){case"photo":t=STYLE_LAYER_CM_SAT;break;case"map":default:t=STYLE_LAYER_CM_MAP}MAP=new mapboxgl.Map({container:"map_canvas",style:t,center:START_CENTER,zoom:START_ZOOM,preserveDrawingBuffer:!0});var a=new mapboxgl.NavigationControl;MAP.addControl(a,"bottom-right"),ctrlGeolocate=new mapboxgl.GeolocateControl({positionOptions:{enableHighAccuracy:!0},trackUserLocation:0!=e.trackUserLocation}),MAP.addControl(ctrlGeolocate,"bottom-right");var i=new mapboxgl.ScaleControl({maxWidth:80,unit:"imperial"});if(MAP.addControl(i,"bottom-left"),e.lat&&e.lng&&e.zoom){var n=parseFloat(e.lat),r=parseFloat(e.lng),o=parseInt(e.zoom);MAP.setCenter([r,n]),MAP.setZoom(o),e.drop_marker&&(MAP.addLayer(MARKER_TARGET),placeMarker(MARKER_TARGET,r,n))}else MAP.fitBounds(MAX_BOUNDS);$.event.trigger({type:"mapInitialized"})}function placeMarker(e,t,a){e.setLngLat([a,t]).addTo(MAP)}function clearMarker(e){e.remove()}function showInfoPopup(e,t){switch(t){case"warning":classes="info-popup warning";break;case"error":classes="info-popup error";break;default:classes="info-popup"}new mapboxgl.Popup({closeOnClick:!1,className:classes}).setLngLat(MAP.getCenter()).setHTML(e).addTo(MAP)}function changeBasemap(e){active_layer=STYLE_LAYERS[e],MAP.setStyle(active_layer)}function getBasemap(){return style=MAP.getStyle(),STYLE_NAMES[style.name]}function formatCoords(e,t){switch(format=null!=t?t:SETTINGS.coordinate_format,format){case"ddm":return formatCoordsDdm(e);case"dd":return formatCoordsDd(e);case"dms":default:return formatCoordsDms(e)}}function formatCoordsDms(e,t){t=void 0!==t?t:0;var a=e.lat<0?"S":"N",i=e.lng<0?"W":"E";lat_dd=Math.abs(e.lat),lng_dd=Math.abs(e.lng);var n=parseInt(lat_dd),r=parseInt(60*(lat_dd-n)),o=(3600*(lat_dd-n-r/60)).toFixed(t),l=parseInt(lng_dd),s=parseInt(60*(lng_dd-l)),c=(3600*(lng_dd-l-s/60)).toFixed(t);return coordsStr=n+"째 "+r+"' "+o+'" '+a+", "+l+"째 "+s+"' "+c+'" '+i,coordsStr}function formatCoordsDdm(e,t){t=void 0!==t?t:2;var a=e.lat<0?"S":"N",i=e.lng<0?"W":"E",n=Math.abs(e.lat),r=Math.abs(e.lng),o=parseInt(n),l=(60*(n-o)).toFixed(t),s=parseInt(r),c=(60*(r-s)).toFixed(t);return coordsStr=o+"째 "+l+"' "+a+", "+s+"째 "+c+"' "+i,coordsStr}function formatCoordsDd(e,t){return t=void 0!==t?t:4,coordsStr=e.lat.toFixed(t)+", "+e.lng.toFixed(t),coordsStr}function shortenStr(e,t,a){if(e.length<=t)return e;var i=e.substr(0,e.lastIndexOf(" ",t));return a&&(i+="..."),i}function saveWindowURL(e,t){WINDOW_URL=decodeURIComponent(location.pathname+"?"+e),WINDOW_URL_QUERYSTRING=e.toString(),t?window.history.pushState(null,null,WINDOW_URL):window.history.replaceState(null,null,WINDOW_URL)}function setWindowURLQueryStringParameters(e,t,a){var i;i=t?new URLSearchParams:new URLSearchParams(location.search),$.each(e,(function(e,t){i.set(e,t)})),saveWindowURL(i,a)}SETTINGS.coordinate_format="dms";var CM={activities:[],amenities:[],attractions:[],attractions_nearby:[],autocomplete_keywords:[],categories:[],reservations:[],trails:[],visitor_centers:[]},fuseOptions={keys:["title"],includeScore:!0,ignoreLocation:!0},dummySearchItem={title:"title",gid:"gid",type:"type",w:"boxw",s:"boxs",e:"boxe",n:"boxn",lat:"latitude",lng:"longitude",drivingLat:"drivingDestinationLatitude",drivingLng:"drivingDestinationLongitude"},fuse=new Fuse([dummySearchItem],fuseOptions);function activity_icon_filepath(e){var t={1:"bike",2:"swim",3:"boat",4:"hike",5:"fish",6:"archery",7:"xcski",9:"geocache",11:"horse",12:"mtnbike",13:"picnic",14:"",15:"sled",16:"snowshoe",17:"",18:"leafman",19:"geology",20:"history",21:"dine",22:"",23:"leafman",24:"",25:"fitness",26:"",30:"golf",39:"fitness",41:""}[e];return t?"/static/images/activities/"+t+".svg":null}function str_to_bool(e){switch(e){case"Yes":case"yes":case"True":case"true":case"1":case 1:case!0:return!0;case"No":case"no":case"False":case"false":case"0":case 0:case!1:case"":case null:default:return!1}}$.get(API_NEW_BASE_URL+"categories",null,(function(e){for(var t=0;t<e.data.length;t++){var a=e.data[t].categorytypeid;CM.categories[a]={name:e.data[t].name}}$.event.trigger({type:"dataReadyCategories"})}),"json"),$.get(API_NEW_BASE_URL+"amenities",null,(function(e){CM.amenities=e.data;var t={221:"baseball",231:"basketball",280:"boat_rental",14:"drink",243:"playground",13:"restroom",28:"gifts",240:"volleyball"};CM.amenities.forEach((function(e){e.icon=t[e.amenitytypeid]})),$.event.trigger({type:"dataReadyAmenities"})}),"json"),$.get(API_NEW_BASE_URL+"visitor_centers",null,(function(e){CM.visitor_centers=e.data,CM.visitor_centers.forEach((function(e){e.categories=e.categories?e.categories.split("|").map(Number):null,e.amenities=e.amenities?e.amenities.split("|").map(Number):null,e.activities=e.activities?e.activities.split("|").map(Number):null})),$.event.trigger({type:"dataReadyVisitorCenters"})}),"json"),$.get(API_NEW_BASE_URL+"reservations",null,(function(e){CM.reservations=e.data,CM.reservations.forEach((function(e){searchItem={title:e.pagetitle,gid:e.record_id,type:"reservation_new",w:e.boxw,s:e.boxs,e:e.boxe,n:e.boxn,lat:e.latitude,lng:e.longitude,drivingLat:e.drivingdestinationlatitude,drivingLng:e.drivingdestinationlongitude},fuse.add(searchItem)})),$.event.trigger({type:"dataReadyReservations"})}),"json"),$.get(API_NEW_BASE_URL+"attractions",null,(function(e){CM.attractions=e.data,CM.attractions.forEach((function(e){e.categories=e.categories?e.categories.split("|").map(Number):null,e.amenities=e.amenities?e.amenities.split("|").map(Number):null,e.activities=e.activities?e.activities.split("|").map(Number):null})),CM.attractions.forEach((function(e){searchItem={title:e.pagetitle,gid:e.gis_id,type:"attraction",w:null,s:null,e:null,n:null,lat:e.latitude,lng:e.longitude,drivingLat:e.drivingdestinationlatitude,drivingLng:e.drivingdestinationlongitude},fuse.add(searchItem)})),$.event.trigger({type:"dataReadyAttractions"})}),"json"),$.get(API_NEW_BASE_URL+"activities",null,(function(e){for(var t=0;t<e.data.length;t++){var a=e.data[t].eventactivitytypeid;CM.activities[a]=e.data[t],CM.activities[a].icon=activity_icon_filepath(a)}$.event.trigger({type:"dataReadyActivities"})}),"json"),$.get(API_NEW_BASE_URL+"autocomplete_keywords",null,(function(e){for(var t=0;t<e.data.length;t++)CM.autocomplete_keywords.push(e.data[t].word);$.event.trigger({type:"dataReadyAutocompleteKeywords"})}),"json"),$.get(API_NEW_BASE_URL+"trails",null,(function(e){for(var t=0;t<e.data.length;t++)trail=e.data[t],trail.bike=str_to_bool(trail.bike),trail.hike=str_to_bool(trail.hike),trail.bridle=str_to_bool(trail.bridle),trail.mountainbike=str_to_bool(trail.mountainbike),CM.trails[e.data[t].id]=trail;CM.trails.forEach((function(e){searchItem={title:e.name,gid:e.id,type:"loop",w:e.boxw,s:e.boxs,e:e.boxe,n:e.boxn,lat:e.lat,lng:e.lng},fuse.add(searchItem)})),$.event.trigger({type:"dataReadyTrails"})}),"json"),CM.get_reservation=function(e){for(var t=0;t<CM.reservations.length;t++)if(CM.reservations[t].record_id==e)return CM.reservations[t]},CM.get_attraction=function(e){for(var t=0;t<CM.attractions.length;t++)if(CM.attractions[t].gis_id==e)return CM.attractions[t]},CM.get_attractions_by_activity=function(e){e=(e=Array.isArray(e)?e:[e]).map(Number);var t=[];return CM.attractions.forEach((function(a){for(var i=!0,n=0;n<e.length;n++)if(!a.activities||!a.activities.includes(e[n])){i=!1;break}i&&t.push(a)})),t},CM.get_attractions_by_amenity=function(e){e=(e=Array.isArray(e)?e:[e]).map(Number);var t=[];return CM.attractions.forEach((function(a){for(var i=!0,n=0;n<e.length;n++)if(!a.amenities||!a.amenities.includes(e[n])){i=!1;break}i&&t.push(a)})),t};var WINDOW_URL=null,WINDOW_URL_QUERYSTRING=null,sidebar=null,LAST_BEEP_IDS=[],LAST_KNOWN_LOCATION=mapboxgl.LngLat.convert(START_CENTER),AUTO_CENTER_ON_LOCATION=!1,DEFAULT_SORT="distance",TRAILVIEW_ENABLED=!0;function createStartHereTooltip(){var e=$(".sidebar-tabs ul li:first")[0],t=$("body > div.ui-page")[0];return new Tooltip(e,{title:"Start exploring here!",container:t,placement:"right",trigger:"manual"})}function switchToMap(){sidebarCoversMap()&&sidebar.close()}function loadMapAndStartingState(){var e=new URLSearchParams(location.search),t=e.get("lat")||e.get("y"),a=e.get("lng")||e.get("x"),i=e.get("zoom")||e.get("z");if(mapOptions={base:e.get("base"),lat:t,lng:a,zoom:i,drop_marker:!1},initMap(mapOptions),e.get("type")&&e.get("gid")){var n=e.get("type");switch(n){case"attraction":$(document).on("dataReadyAttractions",(function(){var t=e.get("gid"),a={};if((attraction=CM.get_attraction(t))&&(a.gid=attraction.gis_id,a.title=attraction.pagetitle,a.lat=attraction.latitude,a.lng=attraction.longitude),!a.lat||!a.lng)return alert("Cound not find that feature.");zoomToFeature(a),showFeatureInfo(n,a)}));break;case"reservation_new":$(document).on("dataReadyReservations",(function(){var t=e.get("gid"),a={type:"reservation_new"};if((reservation=CM.get_reservation(t))&&(a.gid=reservation.record_id,a.w=reservation.boxw,a.n=reservation.boxn,a.e=reservation.boxe,a.s=reservation.boxs,a.lat=reservation.latitude,a.lng=reservation.longitude),!(a.w&&a.n&&a.e&&a.s||a.lat&&a.lng))return alert("Cound not find that reservation.");zoomToFeature(a),showFeatureInfo(n,a)}));break;case"loop":$(document).on("dataReadyTrails",(function(){var t={type:"loop",gid:e.get("gid")};showFeatureInfo(n,t)}))}}if("directions"==e.get("action")){var r=e.get("via"),o=e.get("sourceText");o&&$("#source-input").val(o);var l=e.get("sourceLatLng").split(",")[0],s=e.get("sourceLatLng").split(",")[1],c=new mapboxgl.LngLat(s,l);setDirectionsInputLngLat($("#source-input"),c);var d=e.get("targetText");d&&$("#target-input").val(d);var u=e.get("targetLatLng").split(",")[0],p=e.get("targetLatLng").split(",")[1],g=new mapboxgl.LngLat(p,u);setDirectionsInputLngLat($("#target-input"),g),sidebar.open("pane-directions"),getDirections(c,g,r)}var m=e.get("base")||"map",f=$('input[name="basemap"][value="photo"]'),v=$('input[name="basemap"][value="map"]');switch(m){case"photo":f.prop("checked",!0).checkboxradio("refresh"),v.prop("checked",!1).checkboxradio("refresh");break;case"map":default:f.prop("checked",!1).checkboxradio("refresh"),v.prop("checked",!0).checkboxradio("refresh")}$.event.trigger({type:"mapReady"})}function make_image_from_pagethumbnail(e,t){e=e.replace("~/","https://www.clevelandmetroparks.com/");var a=new URL(e),i=a.searchParams.get("width"),n=a.searchParams.get("height"),r=a.searchParams;return new_height=parseInt(n/(i/t)),r.set("width",2*t),r.set("height",2*new_height),{src:a.protocol+"//"+a.hostname+a.pathname+"?"+r.toString(),width:t,height:new_height}}function make_activity_icons_list(e){var t=[];return e.forEach((function(e){CM.activities[e]?t.push({src:CM.activities[e].icon,title:CM.activities[e].pagetitle,alt:CM.activities[e].pagetitle}):console.error("Error in make_activity_icons_list(): Activity "+e+" does not exist.")})),t}function showFeatureInfoContent(e,t){switch(e){case"attraction":var a=CM.get_attraction(t),i=CM.Templates.info_attraction,n=[];a.activities&&(n=make_activity_icons_list(a.activities));var r=[];if(a.pagethumbnail&&(r=make_image_from_pagethumbnail(a.pagethumbnail,320)),a.latitude&&a.longitude){var o=new mapboxgl.LngLat(a.longitude,a.latitude);a.coords_formatted=formatCoords(o)}if(a.cmp_url){var l=a.cmp_url;const e=/^\//;a.main_site_url=CM_SITE_BASEURL+l.replace(e,"")}var s={feature:a,activity_icons:n,img:r};$("#info-content").html(i(s));break;case"reservation_new":var c=CM.get_reservation(t);i=CM.Templates.info_reservation;c.pagethumbnail&&(r=make_image_from_pagethumbnail(c.pagethumbnail,320));s={feature:c,img:r};$("#info-content").html(i(s));break;case"loop":if(t in CM.trails){$.get(API_NEW_BASE_URL+"trail_geometries/"+t,null,(function(e){e.data.geom_geojson&&drawHighlightLine(JSON.parse(e.data.geom_geojson))})),$.get(API_NEW_BASE_URL+"trail_profiles/"+t,null,(function(e){e.data.elevation_profile&&makeElevationProfileChart(e.data.elevation_profile,"elevation-profile-trail")}));var d=CM.trails[t];i=CM.Templates.info_trail,s={feature:d,img_src:"static/images/loops/"+d.id+".jpg"};$("#info-content").html(i(s))}else console.error("Error: loop id: "+t+" does not exist in CM.trails (app_view_trails).")}}function makeElevationProfileChart(e,t){if(!e){if(!CM.elevationProfileData)return;e=CM.elevationProfileData}for(var a=[],i=0,n=e.length;i<n;i++)a.push({x:e[i].x/5280,y:e[i].y});t||(t="elevation-profile");var r=document.getElementById(t).getContext("2d");new Chart(r,{type:"line",data:{datasets:[{label:"Elevation Profile",data:a,pointRadius:0,backgroundColor:"rgba(0, 0, 0, 0.2)",borderColor:"rgba(0, 0, 0, 1)",borderWidth:2,fill:!1}]},options:{plugins:{legend:{display:!1}},responsive:!0,scales:{y:{title:{display:!0,text:"Elevation (feet)",color:"#000"}},x:{type:"linear",title:{display:!0,text:"Distance (miles)",color:"#000"},ticks:{min:0,precision:2}}}}})}function zoomElementClick(e){var t=getFeatureFromElement(e);showFeatureInfo(t.type,t),showOnMap(t)}function setUpDirectionsTarget(e){}function showFeatureInfo(e,t){$("#show_on_map").data("zoomelement",t),$("#show_on_map").data("wkt",null),setUpDirectionsTarget(t),sidebar.open("pane-info"),t.back_url||(t.back_url="#pane-browse"),set_pane_back_button("#pane-info",t.back_url),$("#info-content").text("Loading...");var a=t.gid||t.record_id;a&&showFeatureInfoContent(e,a)}function getFeatureFromElement(e){var t={};return t.title=e.attr("title"),t.w=e.attr("w"),t.s=e.attr("s"),t.e=e.attr("e"),t.n=e.attr("n"),t.lat=e.attr("lat"),t.lng=e.attr("lng"),t.type=e.attr("type"),"reservation_new"==t.type&&e.attr("record_id")?t.gid=e.attr("record_id"):t.gid=e.attr("gid"),t.back_url=e.attr("backbutton"),t}function getListDistances(e){(e||(e=$(".sidebar-pane.active ul.distance_sortable").eq(0)).length)&&e.find(".zoom_distance").each((function(){var e=$(this).parent().parent(),t=new mapboxgl.LngLat(e.attr("lng"),e.attr("lat")),a=distanceTo(LAST_KNOWN_LOCATION,t),i=bearingToInNESW(LAST_KNOWN_LOCATION,t),n=3.2808399*a,r=n>900?(a/1609.344).toFixed(1)+" mi":n.toFixed(0)+" ft";r+=" "+i,$(this).text(r),e.data("meters",a)}))}function sortLists(e,t){if(e||(e=$(".sidebar-pane.active ul.distance_sortable").eq(0)).length){switch(getListDistances(e),t||(t=DEFAULT_SORT),t){case"distance":e.children("li").sort((function(e,t){return $(e).data("meters")>$(t).data("meters")?1:-1}));break;case"alphabetical":e.children("li").sort((function(e,t){return $(e).text()>$(t).text()?1:-1}))}e.children("li.ui-first-child").removeClass("ui-first-child"),e.children("li").first().addClass("ui-first-child"),e.children("li.ui-last-child").removeClass("ui-last-child"),e.children("li").last().addClass("ui-last-child")}}function showWkt(e){drawHighlightLine(new Wkt.Wkt(e).toJson())}function drawHighlightLine(e){clearHighlightLine(),MAP.addLayer({id:"highlightLine",type:"line",source:{type:"geojson",data:e},layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#01B3FD","line-width":6,"line-opacity":.75}})}function clearHighlightLine(){MAP.getLayer("highlightLine")&&MAP.removeLayer("highlightLine"),MAP.getSource("highlightLine")&&MAP.removeSource("highlightLine")}function zoomToAddress(e){if(!e)return!1;$.get(API_NEW_BASE_URL+"geocode/"+e,null,(function(e){if(!e.data)return alert("We couldn't find that address or city.\nPlease try again.");var t=new mapboxgl.LngLat(e.data.lng,e.data.lat);if(!MAX_BOUNDS.contains(t))return alert("The only results we could find are too far away to zoom the map there.");switchToMap(),placeMarker(MARKER_TARGET,e.data.lat,e.data.lng),MAP.flyTo({center:t,zoom:DEFAULT_POI_ZOOM});var a='<h3 class="popup_title">'+e.data.title+"</h3>";a+='<span class="fakelink zoom" title="'+e.data.title+'" lat="'+e.data.lat+'" lng="'+e.data.lng+'" w="'+e.data.w+'" s="'+e.data.s+'" e="'+e.data.e+'" n="'+e.data.n+'" onClick="zoomElementClick($(this));">Directions</span>';(new mapboxgl.Popup).setLngLat(t).setHTML(a).addTo(MAP)}),"json")}function showOnMap(e,t){e.type&&e.gid&&0!=e.gid&&setWindowURLQueryStringParameters({type:e.type,gid:e.gid},!1,!0);zoomToFeature(e,t)}function zoomToFeature(e,t){if(clearMarker(MARKER_TARGET),clearHighlightLine(),t&&switchToMap(),e.w&&e.s&&e.e&&e.n&&0!=e.w&&0!=e.s&&0!=e.e&&0!=e.n){var a=new mapboxgl.LngLat(e.w,e.s),i=new mapboxgl.LngLat(e.e,e.n),n=new mapboxgl.LngLatBounds(a,i);MAP.fitBounds(n,{padding:10})}else e.lng&&e.lat&&MAP.flyTo({center:[e.lng,e.lat],zoom:DEFAULT_POI_ZOOM});"poi"!=e.type&&"attraction"!=e.type&&"loop"!=e.type||placeMarker(MARKER_TARGET,e.lat,e.lng),e.wkt&&showWkt(e.wkt)}function setupWindowURLUpdates(){MAP.on("zoomend",updateWindowURLZoom),MAP.on("moveend",updateWindowURLCenter),MAP.on("layerremove",updateWindowURLLayer),MAP.on("layeradd",updateWindowURLLayer)}function updateWindowURLCenter(){var e=MAP.getCenter(),t=e.lat.toFixed(7),a=e.lng.toFixed(7);invalidateWindowURL(),params={lat:t,lng:a},setWindowURLQueryStringParameters(params,!1,!1)}function updateWindowURLZoom(){var e=MAP.getZoom().toFixed(1);invalidateWindowURL(),setWindowURLQueryStringParameters({zoom:e},!1)}function updateWindowURLLayer(){var e="map";"photo"==getBasemap()&&(e="photo"),invalidateWindowURL(),setWindowURLQueryStringParameters({base:e},!1)}function invalidateWindowURL(){hideShareURL()}function changeCoordinateFormat(e){SETTINGS.coordinate_format=e,localStorage.setItem("coordinateFormat",e)}function getSessionCoordinateFormat(){var e=localStorage.getItem("coordinateFormat");"dms"!=e&&"ddm"!=e&&"dd"!=e||(SETTINGS.coordinate_format=e,$("#coordinate_format input[name=coordinate_format]").prop("checked",!1).checkboxradio("refresh"),$("#coordinate_format input[name=coordinate_format][value="+e+"]").prop("checked",!0).checkboxradio("refresh"),updateUserCoordsDisplay())}function populateSidebarPanes(){$(document).on("dataReadyActivities",(function(){populatePaneActivities()})),$(document).on("dataReadyAmenities",(function(){populatePaneAmenities()})),$(document).on("dataReadyReservations",(function(){populatePaneTrails()}))}function populatePaneActivities(){var e=CM.Templates.pane_activities_item;CM.activities.forEach((function(t){if(t.icon){var a="pois_usetype_"+encodeURIComponent(t.pagetitle);t.link_url="#browse-results?id="+t.eventactivitytypeid+"&category="+a;var i={activity:t};$("#activities-list").append(e(i))}})),$("#activities-list").listview("refresh"),sortLists($("#activities-list"),"alphabetical"),$("#activities-list li a").click((function(){re=/id=(\d*)/;var e=this.hash.match(re);2==e.length&&(activity_id=e[1]),sidebar.open("pane-browse-results"),pane_title=$(this).text().trim(),set_pane_back_button("#pane-browse-results","#pane-activities");var t=CM.get_attractions_by_activity(activity_id);CM.display_attractions_results(pane_title,t,"attraction")}))}function populatePaneAmenities(){var e=CM.Templates.pane_amenities_item;CM.amenities.forEach((function(t){t.link_url="#browse-results?amenity_id="+t.amenitytypeid;var a={amenity:t};$("#amenities-list").append(e(a))})),$("#amenities-list").listview("refresh"),sortLists($("#amenities-list"),"alphabetical"),$("#amenities-list li a").click((function(){re=/amenity_id=(\d*)/;var e=this.hash.match(re);2==e.length&&(amenity_id=e[1]),pane_title=$(this).text().trim(),set_pane_back_button("#pane-browse-results","#pane-amenities");var t=CM.get_attractions_by_amenity(amenity_id);CM.display_attractions_results(pane_title,t,"attraction")}))}function populatePaneTrails(){var e=CM.Templates.pane_trails_reservation_filter_option;CM.reservations.forEach((function(t){var a={reservation:t};$("#loops_filter_reservation").append(e(a))}))}function sidebarCoversMap(){return window_width=$(window).width(),window_width<=768}function basicGeolocate(){navigator.geolocation.getCurrentPosition(geolocateSuccess,null,{enableHighAccuracy:!0})}function geolocateSuccess(e){LAST_KNOWN_LOCATION.lng=e.coords.longitude,LAST_KNOWN_LOCATION.lat=e.coords.latitude}function updateUserCoordsDisplay(){var e=LAST_KNOWN_LOCATION?formatCoords(LAST_KNOWN_LOCATION):"unknown";$("#gps_location").val(e)}function getDirections(e,t,a,i){disableDirectionsButton();var n={sourcelat:sourcelat=parseFloat(e.lat),sourcelng:sourcelng=parseFloat(e.lng),targetlat:targetlat=parseFloat(t.lat),targetlng:targetlng=parseFloat(t.lng)};switch(a){case"car":$.get(API_NEW_BASE_URL+"directions_driving",n,(function(e){renderDirectionsStructure(e.data),updateWindowURLWithDirections()}),"json").fail((function(e,t,a){showInfoPopup("Error getting driving directions.","error"),console.error(t+": "+a)})).always((function(){enableDirectionsButton()}));break;case"bus":$.get(API_NEW_BASE_URL+"directions_transit",n,(function(e){renderDirectionsStructure(e.data),updateWindowURLWithDirections()}),"json").fail((function(e,t,a){showInfoPopup("Error getting transit directions.","error"),console.error(t+": "+a)})).always((function(){enableDirectionsButton()}));break;default:n.via=a,$.get(API_NEW_BASE_URL+"directions_trails",n,(function(e){if(e.data&&e.data.wkt)renderDirectionsStructure(e.data),updateWindowURLWithDirections();else{var t="Could not find directions over trails for this start and endpoint.";"hike"!=a&&(t+="\nTry a different type of trail, terrain, or difficulty."),showInfoPopup(t,"error")}}),"json").fail((function(e,t,a){showInfoPopup("Error getting directions.","error"),console.error(t+": "+a)})).always((function(){enableDirectionsButton()}))}}function disableDirectionsButton(){$("#get-directions").prop("disabled",!0)}function enableDirectionsButton(){$("#get-directions").prop("disabled",!1)}function setDirectionsInputLngLat(e,t,a,i){e.data("lat",t.lat),e.data("lng",t.lng),a?(e.data("trail-lat",a.lat),e.data("trail-lng",a.lng)):(e.removeData("trail-lat"),e.removeData("trail-lng")),i?(e.data("driving-lat",i.lat),e.data("driving-lng",i.lng)):(e.removeData("driving-lat"),e.removeData("driving-lng")),placeMarker("target"==getSourceTargetInputId(e)?MARKER_END:MARKER_START,t.lat,t.lng),zoomToDirectionsBounds()}function setAppropriateDestination(e){useDrivingDestination()?e.data("driving-lat")&&e.data("driving-lat")&&(e.data("lat",e.data("driving-lat")),e.data("lng",e.data("driving-lng"))):e.data("trail-lat")&&e.data("trail-lat")&&(e.data("lat",e.data("trail-lat")),e.data("lng",e.data("trail-lng")))}function useDrivingDestination(){return"hike"!=$("#directions-via").attr("data-value")}function getDirectionsInputLngLat(e){var t=e.data("lat"),a=e.data("lng");if(t&&a)return new mapboxgl.LngLat(a,t)}function clearDirectionsInputData(e,t){e.removeData("lat"),e.removeData("lng"),e.removeData("isFromGeolocation")}function geolocateUserForDirectionsInput(e){basicGeolocate(),isFromGeolocation=!0;var t=LAST_KNOWN_LOCATION;e.val(t.lat+", "+t.lng),setDirectionsInputLngLat(e,t)}function zoomToDirectionsBounds(){var e=new mapboxgl.LngLatBounds,t=getDirectionsInputLngLat($("#source-input"));t&&e.extend(t);var a=getDirectionsInputLngLat($("#target-input"));a&&e.extend(a),(t||a)&&MAP.fitBounds(e,{padding:100})}function geocodeDirectionsInput(e){var t=e.val();return $.ajax({url:API_NEW_BASE_URL+"geocode/"+t,dataType:"json",success:function(t){if(t&&t.data.lng&&t.data.lat){var a=new mapboxgl.LngLat(t.data.lng,t.data.lat);setDirectionsInputLngLat(e,a)}else{console.error("geocodeDirectionsInput(): failure"),showInfoPopup("source"==getSourceTargetInputId(e)?'Can\'t find the source ("From:") address.\nPlease try again.':'Can\'t find the target ("To:") address.\nPlease try again.',"error")}}})}function setRoutingNotes(e){$("#directions-notes").text(e)}function checkDirectionsInput(e){var t=e.val();if(0==t.length)return!1;if(e.data("lat")&&e.data("lng"))return!0;var a=/(^[-+]?(?:[1-8]?\d(?:\.\d+)?|90(?:\.0+)?))\s*,\s*([-+]?(?:180(?:\.0+)?|(?:(?:1[0-7]\d)|(?:[1-9]?\d))(?:\.\d+)?))$/.exec(t);if(a)return setDirectionsInputLngLat(e,new mapboxgl.LngLat(a[2],a[1])),!0;var i=fuse.search(t);if(i.length){var n=i[0].item;if(simplifyTextForMatch(n.title)==simplifyTextForMatch(t))return setInputToKnownFeature(e,n.title,n.lng,n.lat,n.drivingLng,n.drivingLat),!0}return geocodeDirectionsInput(e).fail((function(){console.error("geocode failure")}))}async function processGetDirectionsForm(){clearDirectionsLine(),clearDirectionsSteps();var e=checkDirectionsInput($("#source-input")),t=checkDirectionsInput($("#target-input"));$.when(e,t).done((function(){processDirectionsInputsWithLatLngs()}))}function processDirectionsInputsWithLatLngs(){var e=parseFloat($("#source-input").data("lat")),t=parseFloat($("#source-input").data("lng")),a=new mapboxgl.LngLat(t,e),i=parseFloat($("#target-input").data("lat")),n=parseFloat($("#target-input").data("lng")),r=new mapboxgl.LngLat(n,i),o=!!$("#target-input").data("isFromGeolocation");getDirections(a,r,$("#directions-via").attr("data-value"),o)}function simplifyTextForMatch(e){return e.replace(/\W/g,"").toLowerCase()}function renderDirectionsStructure(e){var t=new mapboxgl.LngLat(e.start.lng,e.start.lat),a=new mapboxgl.LngLat(e.end.lng,e.end.lat);drawDirectionsLine(new Wkt.Wkt(e.wkt).toJson(),t,a);var i=new mapboxgl.LngLat(e.bounds.west,e.bounds.south),n=new mapboxgl.LngLat(e.bounds.east,e.bounds.north),r=new mapboxgl.LngLatBounds(i,n);MAP.fitBounds(r,{padding:10});var o=$("#directions-steps");o.empty();for(var l=0,s=e.steps.length;l<s;l++){var c=e.steps[l],d=$("<li></li>"),u=l+1+". "+(c.step_action?c.step_action:"")+" "+c.text;if(d.append($("<span></span>").addClass("ui-li-heading").text(u)),c.distance&&c.duration){var p=c.distance+", "+c.duration;d.append($("<span></span>").addClass("ui-li-desc").text(p))}o.append(d)}var g=$("<span></span>").addClass("ui-li-desc").html("");e.retries&&e.retries>3&&g.html("Route may be approximated.");var m=$("<span></span>").addClass("ui-li-heading").html("<b>Total:</b> "+e.totals.distance+", "+e.totals.duration);o.append($("<li></li>").append(m).append(g));var f=$("<div></div>").addClass("directions-functions");if(e.elevationprofile){var v=$("<a></a>").addClass("ui-btn").addClass("ui-btn-inline").addClass("ui-corner-all").prop("id","elevationprofile_button").text("Elevation Profile");v.attr("value1","Elevation Profile").attr("value0","Loading"),v.click((function(){makeElevationProfileChart(),sidebar.open("pane-elevationprofile")})),f.append(v)}var h=$("<a></a>").addClass("ui-btn").addClass("ui-btn-inline").addClass("ui-corner-all").text("Clear");h.click((function(){clearDirectionsLine(),clearDirectionsMarkers(),clearDirectionsSteps()})),f.append(h);var _=$("<a></a>").addClass("ui-btn").addClass("ui-btn-inline").addClass("ui-corner-all").prop("id","share_route_button").text("Share");_.click((function(){makeAndShowShortURL(),sidebar.open("pane-share")})),f.append(_);var b=$("<a></a>").addClass("ui-btn").addClass("ui-btn-inline").addClass("ui-corner-all").text("Print");b.click((function(){$("#button_print").click()})),f.append(b),o.after(f),CM.elevationProfileData=[],e.elevationprofile&&(CM.elevationProfileData=e.elevationprofile),o.listview("refresh")}function updateWindowURLWithDirections(){var e={};e.base="photo"==getBasemap()?"photo":"map",e.action="directions";var t=$("#directions-via").attr("data-value");e.via=t||"hike",e.sourceText=$("#source-input").val();var a=parseFloat($("#source-input").data("lat")),i=parseFloat($("#source-input").data("lng"));a&&i&&(e.sourceLatLng=a+","+i),e.targetText=$("#target-input").val();var n=parseFloat($("#target-input").data("lat")),r=parseFloat($("#target-input").data("lng"));n&&r&&(e.targetLatLng=n+","+r),setWindowURLQueryStringParameters(e,!0,!0)}function drawDirectionsLine(e,t,a){clearDirectionsLine(),clearDirectionsMarkers(),placeMarker(MARKER_START,t.lat,t.lng),placeMarker(MARKER_END,a.lat,a.lng),MAP.addLayer({id:"directionsLine",type:"line",source:{type:"geojson",data:e},layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#0000FF","line-width":6,"line-opacity":.5}})}function clearDirectionsLine(){MAP.getLayer("directionsLine")&&MAP.removeLayer("directionsLine"),MAP.getSource("directionsLine")&&MAP.removeSource("directionsLine")}function clearDirectionsMarkers(){clearMarker(MARKER_START),clearMarker(MARKER_END)}function clearDirectionsSteps(){$("#directions-steps").empty(),$(".directions-functions").remove()}function launchGetDirections(e){$("#directions-via a[data-value='"+e+"']").click(),sidebar.open("pane-directions")}function getSourceTargetInputId(e){if(e.attr("data-value-sourcetarget"))return e.attr("data-value-sourcetarget")}function setInputToKnownFeature(e,t,a,i,n,r){e.val(t);var o,l=new mapboxgl.LngLat(a,i);n&&r&&(o=new mapboxgl.LngLat(n,r)),setDirectionsInputLngLat(e,useDrivingDestination()&&o?o:l,l,o)}function showShareURL(){$("#share_url_controls").show(),$("#make_share_url_controls").hide(),setShareURLBoxWidth()}function hideShareURL(){$("#share_url_controls").hide(),$("#make_share_url_controls").show()}function makeAndShowShortURL(){var e=WINDOW_URL;"/"==e.charAt(0)&&(e=e.substr(1)),"?"==e.charAt(0)&&(e=e.substr(1));var t={querystring:e="/?"+e};$.post(API_NEW_BASE_URL+"shorturls",t,(function(e){var t=new URL(location.href),a=("file:"!=t.protocol?t.protocol:WEBAPP_BASE_URL_ABSOLUTE_PROTOCOL)+"//"+(t.host?t.host:WEBAPP_BASE_URL_ABSOLUTE_HOST)+"/url/"+e.data.shortcode;$("#share_url").val(a),showShareURL()})).fail((function(){alert("Unable to fetch a short URL.\nPlease try again.")}))}function setShareURLBoxWidth(){var e=$("#share_url_controls").width(),t=$("#pane-share .copy-to-clipboard").outerWidth(),a=$("#share_url_controls .ui-input-text"),i=e-t-(a.outerWidth()-a.width());a.width(i)}function createCopiedToClipboardTooltip(e,t){return new Tooltip(e,{title:"Copied to clipboard.",container:t,placement:"bottom",trigger:"manual"})}function disableKeywordButton(){var e=$("#search_keyword_button");e.button("disable"),e.closest(".ui-btn").find(".ui-btn-text").text(e.attr("value0"))}function enableKeywordButton(){var e=$("#search_keyword_button");e.button("enable"),e.closest(".ui-btn").find(".ui-btn-text").text(e.attr("value1"))}function strToLngLat(e){if((e=e.replace(/\s+$/,"").replace(/^\s+/,"")).match(/^[\d\.\-\,\s]+$/)){var t=e.split(/[\s\,]+/);if(2==t.length)if(t[0]=parseFloat(t[0]),t[1]=parseFloat(t[1]),t[0]&&t[1])return t[0]<0?(i=t[1],n=t[0]):(i=t[0],n=t[1]),new mapboxgl.LngLat(n,i)}var a=e.match(/^N\s*(\d\d)\s+(\d\d\.\d\d\d)\s+W\s*(\d\d\d)\s+(\d\d\.\d\d\d)$/i);if(a){var i=parseInt(a[1])+parseInt(a[2])/60,n=-parseInt(a[3])-parseInt(a[4])/60;return new mapboxgl.LngLat(n,i)}return null}function searchByKeyword(e){var t=strToLngLat(e);if(t)return MAP.flyTo({center:t,zoom:16}),void placeMarker(MARKER_TARGET,t.lat,t.lng);var a=$("#keyword_results");a.empty(),disableKeywordButton(),$("#pane-search .sortpicker").hide();var i=fuse.search(e);enableKeywordButton(),$("#pane-search .sortpicker").show();var n=i.filter(e=>e.score<.5);if(!n.length)return $("<li></li>").text("No Cleveland Metroparks results found. Trying an address search.").appendTo(a),void zoomToAddress(e);for(var r=0,o=n.length;r<o;r++){var l=n[r];if(l.item.lat&&l.item.lng){var s=$("<li></li>").addClass("zoom").addClass("ui-li-has-count");s.attr("title",l.item.title).attr("gid",l.item.gid).attr("type",l.item.type).attr("w",l.item.w).attr("s",l.item.s).attr("e",l.item.e).attr("n",l.item.n).attr("lat",l.item.lat).attr("lng",l.item.lng),s.attr("backbutton","#pane-search"),link=$("<a></a>"),link.attr("class","ui-btn ui-btn-text"),s.click((function(){zoomElementClick($(this))})),s.append(link),link.append($("<h4></h4>").addClass("ui-li-heading").text(l.item.title)),resultTypeNames[l.item.type]&&link.append($("<span></span>").addClass("ui-li-desc").text(resultTypeNames[l.item.type])),link.append($("<span></span>").addClass("zoom_distance").addClass("ui-li-count").addClass("ui-btn-up-c").addClass("ui-btn-corner-all").text("0 mi")),s.append(link),a.append(s)}}a.listview("refresh"),getListDistances(a)}$(document).on("mapInitialized",(function(){if(sidebar||(sidebar=$("#sidebar").sidebar()),"/"!=window.location.pathname||""!=window.location.search||sidebarCoversMap()){var e=createStartHereTooltip();setTimeout(e.show,2500),setTimeout(e.dispose,15e3),$(document).click((function(){e.hide()}))}else sidebar.open("pane-welcome")})),$(document).ready((function(){loadMapAndStartingState(),populateSidebarPanes(),initTrailView()})),window.onpopstate=function(){loadMapAndStartingState()},$(document).ready((function(){$('input[type="radio"][name="basemap"]').change((function(){changeBasemap($(this).val())}))})),$(document).ready((function(){$("div.sortpicker span").click((function(){DEFAULT_SORT=$(this).attr("value"),sortLists()}))})),$(document).ready((function(){$(".zoom").click((function(){zoomElementClick($(this))}))})),$(document).ready((function(){$("#geocode_button").click((function(){zoomToAddress($("#geocode_text").val())})),$("#geocode_text").keydown((function(e){13==e.keyCode&&$("#geocode_button").click()}))})),$(document).ready((function(){$("#show_on_map").click((function(){var e=$(this).data("zoomelement");e&&(e.wkt=$(this).data("wkt"),showOnMap(e,!0))}))})),$(document).on("mapReady",setupWindowURLUpdates),$(document).ready((function(){$('input[type="radio"][name="coordinate_format"]').change((function(){changeCoordinateFormat($(this).val()),updateUserCoordsDisplay()}))})),$(document).ready((function(){getSessionCoordinateFormat()})),$(document).on("mapReady",(function(){MAP.on("mousemove",(function(e){var t=MAP.queryRenderedFeatures(e.point);document.getElementById("debug-features").innerHTML=JSON.stringify(t,null,2)}))})),$(document).ready((function(){$(".sidebar-pane-link").click((function(){link=$(this).attr("href"),"#"==link.charAt(0)&&(pane=link.substr(1)),sidebar.open(pane)})),$('#pane-browse li a[href="#pane-activities"]').click((function(){set_pane_back_button("#pane-activities","#pane-browse")})),$('#pane-browse li a[href="#pane-trails"]').click((function(){set_pane_back_button("#pane-trails","#pane-browse"),doTrailSearch()})),$('.sidebar-tabs li a[href="#pane-nearby"]').click((function(){updateNearYouNow()})),$("#pane-welcome .welcome-pane-visitorcenters a").click((function(){pane_title="Visitor Centers",set_pane_back_button("#pane-browse-results","#pane-welcome"),CM.display_attractions_results(pane_title,CM.visitor_centers,"attraction")})),$("#pane-welcome .welcome-pane-parks a").click((function(){pane_title="Parks",set_pane_back_button("#pane-browse-results","#pane-welcome"),CM.display_attractions_results(pane_title,CM.reservations,"reservation_new")})),$("#pane-welcome .welcome-pane-activities a").click((function(){set_pane_back_button("#pane-activities","#pane-welcome")})),$("#pane-welcome .welcome-pane-trails a").click((function(){set_pane_back_button("#pane-trails","#pane-welcome"),doTrailSearch()})),$("#share_facebook").click((function(){var e=$("#share_url").val();return e="http://www.facebook.com/share.php?u="+encodeURIComponent(e),$("#share_facebook").prop("href",e),!0})),$("#share_twitter").click((function(){var e=$("#share_url").val();return e="http://twitter.com/home?status="+encodeURIComponent(e),$("#share_twitter").prop("href",e),!0}))})),CM.display_attractions_results=function(e,t,a){$("#pane-browse-results h1.sidebar-header .title-text").text(e),sidebar.open("pane-browse-results");var i=$("ul#browse_results");i.empty();for(var n=0,r=t.length;n<r;n++){var o=t[n],l=$("<li></li>").addClass("zoom").attr("title",o.pagetitle).attr("gid",o.gis_id).attr("record_id",o.record_id).attr("type",a).attr("w",o.boxw).attr("s",o.boxs).attr("e",o.boxe).attr("n",o.boxn).attr("lat",o.latitude).attr("lng",o.longitude).attr("backbutton","#pane-browse-results");link=$("<a></a>"),link.attr("class","ui-btn ui-btn-text"),l.append(link),l.click((function(){zoomElementClick($(this))})),link.append($("<span></span>").addClass("ui-li-heading").text(o.pagetitle)),link.append($("<span></span>").addClass("zoom_distance").addClass("ui-li-count").addClass("ui-btn-up-c").addClass("ui-btn-corner-all").text("0 mi")),l.append(link),i.append(l)}i.listview("refresh"),sortLists(i)},set_pane_back_button=function(e,t){$(".sidebar-back",$(e)).prop("href",t)},$(document).bind("pagechange",(function(e,t){})),$(document).ready((function(){$((function(){FastClick.FastClick.attach(document.getElementById("sidebar"))}))})),$(document).on("mapInitialized",(function(){ctrlGeolocate.on("geolocate",(function(e){if(geolocateSuccess(e),updateNearYouNow(),$("#nearby_enabled").is(":checked")){var t=$("#nearby-radius").val(),a=[];$('input[name="nearby-category"]:checked').each((function(){a[a.length]=$(this).val()}));var i=mapboxgl.LngLat.convert([e.coords.longitude,e.coords.latitude]);placeCircle(i,t),checkNearby(i,t,a)}updateUserCoordsDisplay()})),basicGeolocate()})),$(document).ready((function(){$("#directions_hike").click((function(){launchGetDirections("hike")})),$("#directions_bike").click((function(){launchGetDirections("bike")})),$("#directions_car").click((function(){launchGetDirections("car")})),$("#directions_bus").click((function(){launchGetDirections("bus")})),$("#source-geolocate-btn").click((function(){geolocateUserForDirectionsInput($("#source-input"))})),$("#get-directions").click((function(){processGetDirectionsForm()})),$(".via-buttons a").click((function(){$(this).parent().attr("data-value",$(this).attr("data-value")),$(this).parent().children().removeClass("active"),$(this).addClass("active"),setAppropriateDestination($("#source-input")),setAppropriateDestination($("#target-input")),processGetDirectionsForm()})),$(".feature-search-autocomplete").on("filterablebeforefilter",(function(e,t){var a=$(this),i=$(t.input),n=i.val(),r="";if(a.html(""),clearDirectionsInputData(i),n&&n.length>2){var o=fuse.search(n);o&&($.each(o,(function(e,t){var a="";a+="<li>",a+='<a href="#" data-transition="fade" class="ui-btn"',a+='data-value-lat="'+t.item.lat+'" ',a+='data-value-lng="'+t.item.lng+'" ',a+='data-value-drivinglat="'+t.item.drivingLat+'" ',a+='data-value-drivinglng="'+t.item.drivingLng+'" ',a+=">"+t.item.title+"</a>",r+=a+="</li>"})),a.html(r),a.show(),a.listview("refresh").trigger("updatelayout"),a.children().each((function(){$(this).click((function(){setInputToKnownFeature(i,$(this).text(),$(this).children("a").attr("data-value-lng"),$(this).children("a").attr("data-value-lat"),$(this).children("a").attr("data-value-drivinglng"),$(this).children("a").attr("data-value-drivinglat")),a.hide()}))})))}}))})),$(document).ready((function(){hideShareURL(),$("#share_url").click((function(){$(this).select()})),$("#make_share_url_btn").click((function(){makeAndShowShortURL()}))})),$(document).ready((function(){$(".copy-to-clipboard").click((function(){var e=$(this).attr("data-copy-id"),t=$(this).closest(".sidebar-pane")[0],a=$("#"+e);a.focus(),a.select(),a[0].setSelectionRange(0,9999),document.execCommand("copy");var i=createCopiedToClipboardTooltip(a[0],t);i.show(),$(document).on("click",(function(e){$(e.target).closest(".copy-to-clipboard").length||i.hide()}))}))})),$(document).ready((function(){$("#browse_keyword_button").click((function(){sidebar.open("pane-search"),$("#search_keyword").val($("#browse_keyword").val()),$("#search_keyword_button").click()})),$("#browse_keyword").keydown((function(e){13==e.keyCode&&$("#browse_keyword_button").click()})),$("#search_keyword_button").click((function(){searchByKeyword($("#search_keyword").val())})),$("#search_keyword").keydown((function(e){13==e.keyCode&&$("#search_keyword_button").click()}))}));var resultTypeNames={attraction:"Attraction",loop:"Trail",reservation:"Reservation",reservation_new:"Reservation"};function turfPointToLngLat(e){return mapboxgl.LngLat.convert(e.geometry.coordinates)}function distanceTo(e,t){var a=turf.point(e.toArray()),i=turf.point(t.toArray());return turf.distance(a,i,{units:"meters"})}function bearingTo(e,t){var a=turf.point(e.toArray()),i=turf.point(t.toArray());return turf.bearing(a,i,{final:!0})}function bearingToInNESW(e,t){var a=bearingTo(e,t);return a>=22&&a<=67?"NE":a>=67&&a<=112?"E":a>=112&&a<=157?"SE":a>=157&&a<=202?"S":a>=202&&a<=247?"SW":a>=247&&a<=292?"W":a>=292&&a<=337?"NW":a>=337||a<=22?"N":void 0}function addActivityTypesToNearby(){var e='<fieldset id="nearby-activities" data-role="controlgroup">';$.each(CM.activities,(function(t,a){a&&a.pagetitle&&(e+='<label><input type="checkbox" name="nearby-category" value="'+a.pagetitle+'">'+a.pagetitle+"</label>")})),e+="</fieldset>",$(".form-group-wrapper").append(e).enhanceWithin()}function updateNearYouNow(){for(var e=$("#alerts"),t=0,a=CM.attractions_nearby.length;t<a;t++){var i=CM.attractions_nearby[t],n=new mapboxgl.LngLat(i.longitude,i.latitude);i.meters=distanceTo(LAST_KNOWN_LOCATION,n),i.miles=i.meters/1609.344,i.feet=3.2808399*i.meters,i.range=i.feet>900?i.miles.toFixed(1)+" mi":i.feet.toFixed(0)+" ft",i.bearing=bearingToInNESW(LAST_KNOWN_LOCATION,n)}CM.attractions_nearby.sort((function(e,t){return e.meters-t.meters}));var r=CM.attractions_nearby.slice(0,25);e.empty();for(t=0,a=r.length;t<a;t++){i=r[t];var o=$("<li></li>").addClass("zoom").addClass("ui-li-has-count");o.attr("title",i.pagetitle),o.attr("category",i.categories),o.attr("type","attraction").attr("gid",i.gis_id),o.attr("lat",i.latitude).attr("lng",i.longitude),o.attr("backbutton","#pane-nearby");var l=$("<div></div>").addClass("ui-btn-text");l.append($("<h2></h2>").text(i.pagetitle));var s="";Array.isArray(i.categories)&&i.categories.forEach((function(e,t){t>0&&(s+="; "),s+=CM.categories[e].name})),l.append($("<p></p>").text(s)),l.append($("<span></span>").addClass("zoom_distance").addClass("ui-li-count").addClass("ui-btn-up-c").addClass("ui-btn-corner-all").text(i.range+" "+i.bearing)),o.click((function(){zoomElementClick($(this))})),o.append(l),e.append(o)}e.listview("refresh")}function placeCircle(e,t){clearCircle();var a=t/1e3,i=turf.circle(turf.point(e.toArray()),a,{units:"kilometers"});MAP.addLayer({id:"circle",type:"fill",source:{type:"geojson",data:i},layout:{},paint:{"fill-color":"#21A1F3","fill-opacity":.3}})}function clearCircle(){MAP.getLayer("circle")&&MAP.removeLayer("circle"),MAP.getSource("circle")&&MAP.removeSource("circle")}function checkNearby(e,t,a){t=parseFloat(t);for(var i=[],n=0,r=CM.attractions_nearby.length;n<r;n++){var o=CM.attractions_nearby[n],l=distanceTo(e,new mapboxgl.LngLat(o.longitude,o.latitude));if(!(l>t)){if(a){for(var s=o.categories.split("; "),c=!1,d=0,u=s.length;d<u;d++)for(var p=0,g=a.length;p<g;p++)if(a[p]==s[d]){c=!0;break}if(!c)continue}var m=3.2808399*l,f=m>900?(l/1609.344).toFixed(1)+" mi":m.toFixed(0)+" ft";i[i.length]={gid:o.gid,title:o.title,range:f}}}var v=!1;for(n=0,r=i.length;n<r;n++){var h=parseInt(i[n].gid);if(-1==LAST_BEEP_IDS.indexOf(h)){v=!0;break}}LAST_BEEP_IDS=[];for(n=0,r=i.length;n<r;n++){h=parseInt(i[n].gid);LAST_BEEP_IDS[LAST_BEEP_IDS.length]=h}if(LAST_BEEP_IDS.sort(),v){document.getElementById("alert_beep").play();var _=[];for(n=0,r=i.length;n<r;n++)_[_.length]=i[n].title+", "+i[n].range;setTimeout((function(){alert(_.join("\n"))}),1e3)}}function filterTrails(e,t,a,i){"bike"==e.substr(0,4)&&(e="bike");var n=CM.trails.filter((function(n){return!(e&&!n[e])&&((!t||n.res==t)&&(void 0===a||!i||!(n.distance_feet<a||n.distance_feet>i)))}));return n}function doTrailSearch(){$("#loops_list li").show();var e=$("#loops_filter_type").val(),t=filterTrails(e,$("#loops_filter_reservation").val(),5280*parseInt($("#loops_filter_distance_min").val()),5280*parseInt($("#loops_filter_distance_max").val())),a=$("#loops_list");if(a.empty(),$(".results-notes").remove(),!t||!t.length){a.after('<p class="results-notes">No results.</p>')}for(var i=0;i<t.length;i++){var n,r=t[i],o=$("<li></li>").addClass("zoom").addClass("ui-li-has-count");switch(o.attr("title",r.name).attr("gid",r.id).attr("type","loop").attr("w",r.boxw).attr("s",r.boxs).attr("e",r.boxe).attr("n",r.boxn).attr("lat",r.lat).attr("lng",r.lng),o.attr("backbutton","#pane-trails"),link=$("<a></a>"),link.attr("class","ui-btn ui-btn-text"),o.click((function(){zoomElementClick($(this))})),o.append(link),link.append($("<h4></h4>").addClass("ui-li-heading").text(r.name)),e){case"mountainbike":case"bike_Advanced":n=r.durationtext_bike;break;case"bridle":n=r.durationtext_bridle;break;case"hike":default:n=r.durationtext_hike}link.append($("<span></span>").addClass("ui-li-desc").html(r.distancetext+" &nbsp;&nbsp; "+n)),link.append($("<span></span>").addClass("zoom_distance").addClass("ui-li-count").addClass("ui-btn-up-c").addClass("ui-btn-corner-all").text("0 mi")),o.append(link),a.append(o)}$("#pane-trails .sortpicker").show(),a.listview("refresh"),sortLists(a)}$(document).on("dataReadyAutocompleteKeywords",(function(){$.each(CM.autocomplete_keywords,(function(e,t){var a="";a+='<li data-icon="arrow-r">',a+='<a href="#" data-transition="fade" class="ui-btn ui-btn-icon-right ui-icon-arrow-r">'+t+"</a>",a+="</li>",$("#browse_keyword_autocomplete").append(a),$("#search_keyword_autocomplete").append(a)})),$("#browse_keyword_autocomplete").listview("refresh").trigger("updatelayout"),$("#search_keyword_autocomplete").listview("refresh").trigger("updatelayout"),$("#browse_keyword_autocomplete li").click((function(){$("#browse_keyword").val("").trigger("change"),$("#browse_keyword").val($(this).text()),$("#browse_keyword_button").click()})),$("#search_keyword_autocomplete li").click((function(){$("#search_keyword").val("").trigger("change"),$("#search_keyword").val($(this).text()),$("#search_keyword_button").click()}))})),$(document).on("dataReadyAttractions",(function(){CM.attractions_nearby=CM.attractions.slice(0),updateNearYouNow()})),$(document).on("dataReadyAttractions",(function(){addActivityTypesToNearby()})),$(document).ready((function(){$("#nearby_enabled").change((function(){var e=$(this).is(":checked");e?$("#nearby-config").show():$("#nearby-config").hide(),e||($("#alerts li").slice(0,25).show(),$("#alerts li").slice(25).hide(),clearCircle())}))})),$(document).ready((function(){$("#loops_typeicons img").click((function(){var e=$(this),t=e.attr("data-value");$("#loops_filter_type").val(t).trigger("change"),$("#loops_typeicons img").each((function(){var t=$(this).prop("src");$(this).is(e)?t.includes("-on.svg")||(t=t.replace(".svg","-on.svg")):t=t.replace("-on.svg",".svg"),$(this).prop("src",t)}))})).first().click(),$("#loops_filter_distancepicker a").click((function(){var e=$(this),t=e.attr("data-min"),a=e.attr("data-max");$("#loops_filter_distance_min").val(t),$("#loops_filter_distance_max").val(a),$("#loops_filter_distancepicker a").each((function(){$(this).is(e)?$(this).addClass("active"):$(this).removeClass("active")})),doTrailSearch()})),$("#loops_filter_reservation").change((function(){doTrailSearch()})),$("#loops_filter_distance_min").change(),$("#loops_filter_distance_max").change(),$("#loops_filter_type").change((function(){switch($(this).val()){case"hike":case"exercise":$(".time_estimate").hide(),$(".time_hike").show(),$(".time_estimate_prefix").hide();break;case"bridle":$(".time_estimate").hide(),$(".time_bridle").show(),$(".time_estimate_prefix").hide();break;case"bike":case"bike_Novice":case"bike_Beginner":case"bike_Intermediate":case"bike_Advanced":case"mountainbike":$(".time_estimate").hide(),$(".time_bike").show(),$(".time_estimate_prefix").hide();break;default:$(".time_estimate").show(),$(".time_estimate_prefix").show()}doTrailSearch()}))})),this.CM=this.CM||{},this.CM.Templates=this.CM.Templates||{},this.CM.Templates.info_attraction=Handlebars.template({1:function(e,t,a,i,n){var r,o=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'    <h4>Activities:</h4>\n    <ul class="activities-icon-list">\n'+(null!=(r=o(a,"each").call(null!=t?t:e.nullContext||{},null!=t?o(t,"activity_icons"):t,{name:"each",hash:{},fn:e.program(2,n,0),inverse:e.noop,data:n,loc:{start:{line:6,column:8},end:{line:8,column:17}}}))?r:"")+"    </ul>\n"},2:function(e,t,a,i,n){var r=e.lambda,o=e.escapeExpression,l=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'            <li><img src="'+o(r(null!=t?l(t,"src"):t,t))+'" title="'+o(r(null!=t?l(t,"title"):t,t))+'" alt="'+o(r(null!=t?l(t,"title"):t,t))+'"></li>\n'},4:function(e,t,a,i,n){var r,o=e.lambda,l=e.escapeExpression,s=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'    <img src="'+l(o(null!=(r=null!=t?s(t,"img"):t)?s(r,"src"):r,t))+'" width="'+l(o(null!=(r=null!=t?s(t,"img"):t)?s(r,"width"):r,t))+'" height="'+l(o(null!=(r=null!=t?s(t,"img"):t)?s(r,"height"):r,t))+'" alt="'+l(o(null!=(r=null!=t?s(t,"feature"):t)?s(r,"pagetitle"):r,t))+'">\n'},6:function(e,t,a,i,n){var r,o=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'    <div class="feature-description">'+e.escapeExpression(e.lambda(null!=(r=null!=t?o(t,"feature"):t)?o(r,"descr"):r,t))+"</div>\n"},8:function(e,t,a,i,n){var r,o=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'    <ul class="nobull">\n        <li><a href="'+e.escapeExpression(e.lambda(null!=(r=null!=t?o(t,"feature"):t)?o(r,"main_site_url"):r,t))+'" target="_blank">More info</a></li>\n    </ul>\n'},compiler:[8,">= 4.3.0"],main:function(e,t,a,i,n){var r,o=e.lambda,l=e.escapeExpression,s=null!=t?t:e.nullContext||{},c=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return"<h2>"+l(o(null!=(r=null!=t?c(t,"feature"):t)?c(r,"pagetitle"):r,t))+"</h2>\n\n"+(null!=(r=c(a,"if").call(s,null!=(r=null!=t?c(t,"feature"):t)?c(r,"activities"):r,{name:"if",hash:{},fn:e.program(1,n,0),inverse:e.noop,data:n,loc:{start:{line:3,column:0},end:{line:10,column:7}}}))?r:"")+"\n"+(null!=(r=c(a,"if").call(s,null!=t?c(t,"img"):t,{name:"if",hash:{},fn:e.program(4,n,0),inverse:e.noop,data:n,loc:{start:{line:12,column:0},end:{line:14,column:7}}}))?r:"")+"\n"+(null!=(r=c(a,"if").call(s,null!=(r=null!=t?c(t,"feature"):t)?c(r,"descr"):r,{name:"if",hash:{},fn:e.program(6,n,0),inverse:e.noop,data:n,loc:{start:{line:16,column:0},end:{line:18,column:7}}}))?r:"")+"\n"+(null!=(r=c(a,"if").call(s,null!=(r=null!=t?c(t,"feature"):t)?c(r,"cmp_url"):r,{name:"if",hash:{},fn:e.program(8,n,0),inverse:e.noop,data:n,loc:{start:{line:20,column:0},end:{line:24,column:7}}}))?r:"")+'\n<h4>GPS coordinates:</h4>\n<div class="small-light">\n    '+l(o(null!=(r=null!=t?c(t,"feature"):t)?c(r,"coords_formatted"):r,t))+"\n</div>"},useData:!0}),this.CM.Templates.info_reservation=Handlebars.template({1:function(e,t,a,i,n){var r,o=e.lambda,l=e.escapeExpression,s=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'    <img src="'+l(o(null!=(r=null!=t?s(t,"img"):t)?s(r,"src"):r,t))+'" width="'+l(o(null!=(r=null!=t?s(t,"img"):t)?s(r,"width"):r,t))+'" height="'+l(o(null!=(r=null!=t?s(t,"img"):t)?s(r,"height"):r,t))+'" alt="'+l(o(null!=(r=null!=t?s(t,"feature"):t)?s(r,"pagetitle"):r,t))+'">\n'},3:function(e,t,a,i,n){var r,o=e.lambda,l=e.escapeExpression,s=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'\t<h4>Phone</h4>\n\t<a title="Call '+l(o(null!=(r=null!=t?s(t,"feature"):t)?s(r,"pagetitle"):r,t))+'" href="tel:'+l(o(null!=(r=null!=t?s(t,"feature"):t)?s(r,"phone"):r,t))+'">'+l(o(null!=(r=null!=t?s(t,"feature"):t)?s(r,"phone"):r,t))+"</a>\n"},compiler:[8,">= 4.3.0"],main:function(e,t,a,i,n){var r,o=e.lambda,l=e.escapeExpression,s=null!=t?t:e.nullContext||{},c=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return"<h2>"+l(o(null!=(r=null!=t?c(t,"feature"):t)?c(r,"pagetitle"):r,t))+"</h2>\n\n"+(null!=(r=c(a,"if").call(s,null!=t?c(t,"img"):t,{name:"if",hash:{},fn:e.program(1,n,0),inverse:e.noop,data:n,loc:{start:{line:3,column:0},end:{line:5,column:7}}}))?r:"")+"\n<p>"+l(o(null!=(r=null!=t?c(t,"feature"):t)?c(r,"descr"):r,t))+"</p>\n\n<h4>Hours of Operation</h4>\n"+l(o(null!=(r=null!=t?c(t,"feature"):t)?c(r,"hoursofoperation"):r,t))+"\n\n"+(null!=(r=c(a,"if").call(s,null!=(r=null!=t?c(t,"feature"):t)?c(r,"phone"):r,{name:"if",hash:{},fn:e.program(3,n,0),inverse:e.noop,data:n,loc:{start:{line:12,column:0},end:{line:15,column:7}}}))?r:"")+'\n<div class="lat_driving">'+l(o(null!=(r=null!=t?c(t,"feature"):t)?c(r,"drivingdestinationlatitude"):r,t))+'</div>\n<div class="lng_driving">'+l(o(null!=(r=null!=t?c(t,"feature"):t)?c(r,"drivingdestinationlongitude"):r,t))+"</div>"},useData:!0}),this.CM.Templates.info_trail=Handlebars.template({1:function(e,t,a,i,n){var r,o=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return"\tEst time, walking: "+e.escapeExpression(e.lambda(null!=(r=null!=t?o(t,"feature"):t)?o(r,"durationtext_hike"):r,t))+"<br/>\n"},3:function(e,t,a,i,n){var r,o=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return"\tEst time, bicycle: "+e.escapeExpression(e.lambda(null!=(r=null!=t?o(t,"feature"):t)?o(r,"durationtext_bike"):r,t))+"<br/>\n"},5:function(e,t,a,i,n){var r,o=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return"\tEst time, horseback: "+e.escapeExpression(e.lambda(null!=(r=null!=t?o(t,"feature"):t)?o(r,"durationtext_bridle"):r,t))+"<br/>\n"},compiler:[8,">= 4.3.0"],main:function(e,t,a,i,n){var r,o=e.lambda,l=e.escapeExpression,s=null!=t?t:e.nullContext||{},c=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return"<h2>"+l(o(null!=(r=null!=t?c(t,"feature"):t)?c(r,"name"):r,t))+"</h2>\n\n<p>\nLength: "+l(o(null!=(r=null!=t?c(t,"feature"):t)?c(r,"distancetext"):r,t))+"<br/>\n"+(null!=(r=c(a,"if").call(s,null!=(r=null!=t?c(t,"feature"):t)?c(r,"hike"):r,{name:"if",hash:{},fn:e.program(1,n,0),inverse:e.noop,data:n,loc:{start:{line:5,column:0},end:{line:7,column:7}}}))?r:"")+(null!=(r=c(a,"if").call(s,null!=(r=null!=t?c(t,"feature"):t)?c(r,"bike"):r,{name:"if",hash:{},fn:e.program(3,n,0),inverse:e.noop,data:n,loc:{start:{line:8,column:0},end:{line:10,column:7}}}))?r:"")+(null!=(r=c(a,"if").call(s,null!=(r=null!=t?c(t,"feature"):t)?c(r,"bridle"):r,{name:"if",hash:{},fn:e.program(5,n,0),inverse:e.noop,data:n,loc:{start:{line:11,column:0},end:{line:13,column:7}}}))?r:"")+"</p>\n\n"+(null!=(r=o(null!=(r=null!=t?c(t,"feature"):t)?c(r,"description"):r,t))?r:"")+'\n\n<div class="elevationprofileimage" style="text-align:center;">\n    <canvas id="elevation-profile-trail" alt="Elevation profile"></canvas>\n</div>\n'},useData:!0}),this.CM.Templates.pane_activities_item=Handlebars.template({compiler:[8,">= 4.3.0"],main:function(e,t,a,i,n){var r,o=e.lambda,l=e.escapeExpression,s=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'<li>\n    <a href="'+l(o(null!=(r=null!=t?s(t,"activity"):t)?s(r,"link_url"):r,t))+'">\n        <img class="ui-li-icon" src="'+l(o(null!=(r=null!=t?s(t,"activity"):t)?s(r,"icon"):r,t))+'" /> <span class="title">'+l(o(null!=(r=null!=t?s(t,"activity"):t)?s(r,"pagetitle"):r,t))+"</span>\n    </a>\n</li>\n"},useData:!0}),this.CM.Templates.pane_amenities_item=Handlebars.template({compiler:[8,">= 4.3.0"],main:function(e,t,a,i,n){var r,o=e.lambda,l=e.escapeExpression,s=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'<li>\n    <a href="'+l(o(null!=(r=null!=t?s(t,"amenity"):t)?s(r,"link_url"):r,t))+'">\n        <i class="cm-icon cm-icon-'+l(o(null!=(r=null!=t?s(t,"amenity"):t)?s(r,"icon"):r,t))+'"></i>\n        '+l(o(null!=(r=null!=t?s(t,"amenity"):t)?s(r,"name"):r,t))+"\n    </a>\n</li>\n"},useData:!0}),this.CM.Templates.pane_trails_reservation_filter_option=Handlebars.template({compiler:[8,">= 4.3.0"],main:function(e,t,a,i,n){var r,o=e.lambda,l=e.escapeExpression,s=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'<option value="'+l(o(null!=(r=null!=t?s(t,"reservation"):t)?s(r,"pagetitle"):r,t))+'">'+l(o(null!=(r=null!=t?s(t,"reservation"):t)?s(r,"pagetitle"):r,t))+"</option>\n"},useData:!0});let trailviewToggled=!1,trailviewViewer=null,trailviewMapMarker=null,trailviewMouseOnDot=!1,trailviewFocusedElement="map",lastMapResize=new Date;function initTrailView(){const e=document.querySelector("#trailviewIcon");if(null===e)throw new Error("trailviewIcon id not found");e.addEventListener("click",()=>{toggleTrailView()});const t=document.querySelector("#map_canvas");new ResizeObserver(()=>{(new Date).valueOf()-lastMapResize.valueOf()>100&&(MAP.resize(),lastMapResize=new Date)}).observe(t),t.addEventListener("transitionend",()=>{MAP.resize(),null!==trailviewMapMarker&&MAP.easeTo({center:trailviewMapMarker.getLngLat(),duration:500})})}function toggleTrailView(){if(!1===trailviewToggled){if(trailviewToggled=!0,addTrailViewMapLayer(),$("#trailviewViewer").fadeIn(),null===trailviewViewer){const e=trailviewer.defaultBaseOptions;e.target="trailviewViewer",trailviewViewer=new trailviewer.TrailViewerBase(e),trailviewViewer.on("image-change",e=>{null!==MAP&&null!==trailviewMapMarker&&(trailviewMapMarker.setLngLat([e.longitude,e.latitude]),MAP.easeTo({center:trailviewMapMarker.getLngLat(),duration:500}))})}addTrailViewExpandButton()}else"viewer"===trailviewFocusedElement&&toggleTrailViewFocus(),trailviewToggled=!1,removeTrailViewMapLayer(),$("#trailviewViewer").fadeOut(),trailviewViewer.destroy(),trailviewViewer=null}function removeTrailViewMapLayer(){MAP.getSource("dots")&&(MAP.removeLayer("dots"),MAP.removeSource("dots"))}function addTrailViewExpandButton(){const e=document.createElement("button");e.type="button",e.id="trailviewExpandIcon",e.classList.add("trailview-button"),e.setAttribute("data-role","none");const t=document.createElement("span");t.classList.add("cm-icon-expand"),e.appendChild(t),document.querySelector("#trailviewViewer").appendChild(e),e.addEventListener("click",()=>{toggleTrailViewFocus()})}function toggleTrailViewFocus(){"map"===trailviewFocusedElement?(trailviewFocusedElement="viewer",document.querySelector("#map_canvas").classList.add("trailview-map-small"),document.querySelector("#trailviewViewer").classList.remove("trailviewer-small"),document.querySelector("#trailviewViewer").classList.add("trailviewer-focus"),document.querySelector("#map_canvas").addEventListener("transitionend",()=>{MAP.resize()},{once:!0})):"viewer"===trailviewFocusedElement&&(trailviewFocusedElement="map",document.querySelector("#map_canvas").classList.remove("trailview-map-small"),document.querySelector("#trailviewViewer").classList.remove("trailviewer-focus"),document.querySelector("#trailviewViewer").classList.add("trailviewer-small"),MAP.resize())}function addTrailViewMapLayer(){if(null===MAP)return;removeTrailViewMapLayer();MAP.addSource("dots",{type:"vector",format:"pbf",tiles:["https://trailview.cmparks.net/api/tiles/{z}/{x}/{y}/standard"]}),MAP.addLayer({id:"dots","source-layer":"geojsonLayer",source:"dots",type:"circle",paint:{"circle-radius":10,"circle-color":["case",["==",["get","visible"],!0],"#00a108","#db8904"]}}),MAP.setPaintProperty("dots","circle-radius",["interpolate",["exponential",.5],["zoom"],13,3,16,5,17,7,20,8]),MAP.setPaintProperty("dots","circle-opacity",["interpolate",["exponential",.5],["zoom"],13,.05,15,.1,17,.25,20,1]),MAP.on("mouseenter","dots",()=>{trailviewMouseOnDot=!0,null!==MAP&&(MAP.getCanvas().style.cursor="pointer")}),MAP.on("mouseleave","dots",()=>{trailviewMouseOnDot=!1,null!==MAP&&(MAP.getCanvas().style.cursor="grab")}),MAP.on("mousedown",()=>{null===MAP||trailviewMouseOnDot||(MAP.getCanvas().style.cursor="grabbing")}),MAP.on("mouseup",()=>{null!==MAP&&trailviewMouseOnDot?MAP.getCanvas().style.cursor="pointer":null!==MAP&&(MAP.getCanvas().style.cursor="grab")}),createTrailviewMapMarker(),MAP.on("click","dots",e=>{void 0!==e.features&&null!==e.features[0].properties?trailviewViewer.goToImageID(e.features[0].properties.imageID):console.warn("Features is undefiend or properties are null")})}function createTrailviewMapMarker(){const e=document.createElement("div");e.classList.add("trailview-current-marker-wrapper");const t=document.createElement("div");t.classList.add("trailview-current-marker");const a=document.createElement("div");a.classList.add("trailview-marker-viewer"),e.appendChild(t),e.appendChild(a),trailviewMapMarker=new mapboxgl.Marker(e).setLngLat([-81.682665,41.4097766]).addTo(MAP).setRotationAlignment("map"),updateTrailViewMarkerRotation()}function updateTrailViewMarkerRotation(){if(null!==trailviewViewer&&null!==trailviewMapMarker){const e=trailviewViewer.getBearing();void 0!==e&&trailviewMapMarker.setRotation((e+225)%360)}!1!==trailviewToggled?requestAnimationFrame(updateTrailViewMarkerRotation):trailviewMapMarker.remove()}
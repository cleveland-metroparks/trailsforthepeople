var WEBAPP_BASEPATH="/",API_BASEPATH="/",MAP=null,API_NEW_HOST="maps-api.clevelandmetroparks.com",API_NEW_PROTOCOL="https:",API_NEW_BASEPATH="/api/v1/",API_NEW_BASE_URL=API_NEW_PROTOCOL+"//"+API_NEW_HOST+API_NEW_BASEPATH,WEBAPP_BASE_URL_ABSOLUTE_PROTOCOL="https:",WEBAPP_BASE_URL_ABSOLUTE_HOST="maps.clevelandmetroparks.com",WEBAPP_BASE_URL_ABSOLUTE=WEBAPP_BASE_URL_ABSOLUTE_PROTOCOL+"//"+WEBAPP_BASE_URL_ABSOLUTE_HOST+"/",NATIVE_APP=!1,MAX_BOUND_SW=new mapboxgl.LngLat(-82.08504,41.11816),MAX_BOUND_NE=new mapboxgl.LngLat(-81.28029,41.70009),MAX_BOUNDS=new mapboxgl.LngLatBounds(MAX_BOUND_SW,MAX_BOUND_NE),DEFAULT_POI_ZOOM=15,GEOCODE_BIAS_BOX="41.202048178648, -81.9627793163304, 41.5885467839419, -81.386224018357",PRINT_URL="/pdf/create.json",PRINT_PICKUP_BASEURL="/pdf/",BING_API_KEY="AjBuYw8goYn_CWiqk65Rbf_Cm-j1QFPH-gGfOxjBipxuEB2N3n9yACKu5s8Dl18N",PRINT_SIZES={"Letter portrait":[580,714],"Letter landscape":[762,526],"Ledger portrait":[744,1126],"Ledger landscape":[1178,690]},START_CENTER=[-81.673,41.3953],START_ZOOM=14;mapboxgl.accessToken="pk.eyJ1IjoiY2xldmVsYW5kLW1ldHJvcGFya3MiLCJhIjoiWHRKaDhuRSJ9.FGqNSOHwiCr2dmTH2JTMAA";var ctrlGeolocate,STYLE_LAYER_CM_MAP="mapbox://styles/cleveland-metroparks/cisvvmgwe00112xlk4jnmrehn",STYLE_LAYER_CM_SAT="mapbox://styles/cleveland-metroparks/cjcutetjg07892ro6wunp2da9",STYLE_LAYERS={map:STYLE_LAYER_CM_MAP,photo:STYLE_LAYER_CM_SAT},STYLE_NAMES={"CM Light":"map","CM-Aerial":"photo"},isMobile=/Mobi/.test(navigator.userAgent),MARKER_TARGET=new mapboxgl.Marker({color:"#207FD0"}),MARKER_START=new mapboxgl.Marker({color:"#6BB03E"}),MARKER_END=new mapboxgl.Marker({color:"#FF7866"}),ELEVATION_PROFILE=null,SKIP_TO_DIRECTIONS=!1,SETTINGS=[];function initMap(e){var t;switch(e.base||"map"){case"photo":t=STYLE_LAYER_CM_SAT;break;case"map":default:t=STYLE_LAYER_CM_MAP}MAP=new mapboxgl.Map({container:"map_canvas",style:t,center:START_CENTER,zoom:START_ZOOM,preserveDrawingBuffer:!0});var a=new mapboxgl.NavigationControl;MAP.addControl(a,"bottom-right"),ctrlGeolocate=new mapboxgl.GeolocateControl({positionOptions:{enableHighAccuracy:!0},trackUserLocation:0!=e.trackUserLocation}),MAP.addControl(ctrlGeolocate,"bottom-right");var n=new mapboxgl.ScaleControl({maxWidth:80,unit:"imperial"});if(MAP.addControl(n,"bottom-left"),e.lat&&e.lng&&e.zoom){var i=parseFloat(e.lat),r=parseFloat(e.lng),o=parseInt(e.zoom);MAP.setCenter([r,i]),MAP.setZoom(o),e.drop_marker&&(MAP.addLayer(MARKER_TARGET),placeMarker(MARKER_TARGET,r,i))}else MAP.fitBounds(MAX_BOUNDS);$.event.trigger({type:"mapInitialized"})}function placeMarker(e,t,a){e.setLngLat([a,t]).addTo(MAP)}function clearMarker(e){e.remove()}function showInfoPopup(e,t){switch(t){case"warning":classes="info-popup warning";break;case"error":classes="info-popup error";break;default:classes="info-popup"}new mapboxgl.Popup({closeOnClick:!1,className:classes}).setLngLat(MAP.getCenter()).setHTML(e).addTo(MAP)}function changeBasemap(e){active_layer=STYLE_LAYERS[e],MAP.setStyle(active_layer)}function getBasemap(){return style=MAP.getStyle(),STYLE_NAMES[style.name]}function latlng_formatted(e,t){switch(format=null!=t?t:SETTINGS.coordinate_format,format){case"ddm":return latlng_as_ddm(e);case"dd":return latlng_as_dd(e);case"dms":default:return latlng_as_dms(e)}}function latlng_as_dms(e,t){t=void 0!==t?t:0;var a=e.lat<0?"S":"N",n=e.lng<0?"W":"E";lat_dd=Math.abs(e.lat),lng_dd=Math.abs(e.lng);var i=parseInt(lat_dd),r=parseInt(60*(lat_dd-i)),o=(3600*(lat_dd-i-r/60)).toFixed(t),l=parseInt(lng_dd),s=parseInt(60*(lng_dd-l)),c=(3600*(lng_dd-l-s/60)).toFixed(t);return latlng_str=i+"째 "+r+"' "+o+'" '+a+", "+l+"째 "+s+"' "+c+'" '+n,latlng_str}function latlng_as_ddm(e,t){t=void 0!==t?t:2;var a=e.lat<0?"S":"N",n=e.lng<0?"W":"E",i=Math.abs(e.lat),r=Math.abs(e.lng),o=parseInt(i),l=(60*(i-o)).toFixed(t),s=parseInt(r),c=(60*(r-s)).toFixed(t);return latlng_str=o+"째 "+l+"' "+a+", "+s+"째 "+c+"' "+n,latlng_str}function latlng_as_dd(e,t){return t=void 0!==t?t:4,latlng_str=e.lat.toFixed(t)+", "+e.lng.toFixed(t),latlng_str}function shortenStr(e,t,a){if(e.length<=t)return e;var n=e.substr(0,e.lastIndexOf(" ",t));return a&&(n+="..."),n}function saveWindowURL(e,t){WINDOW_URL=decodeURIComponent(location.pathname+"?"+e),WINDOW_URL_QUERYSTRING=e.toString(),t?window.history.pushState(null,null,WINDOW_URL):window.history.replaceState(null,null,WINDOW_URL)}function setWindowURLQueryStringParameters(e,t,a){var n;n=t?new URLSearchParams:new URLSearchParams(location.search),$.each(e,function(e,t){n.set(e,t)}),saveWindowURL(n,a)}SETTINGS.coordinate_format="dms";var CM={activities:[],attractions:[],attractions_nearby:[],autocomplete_keywords:[],categories:[],reservations:[],trails:[],visitor_centers:[]},fuseOptions={keys:["title"]},dummySearchItem={title:"title",gid:"gid",type:"type",w:"boxw",s:"boxs",e:"boxe",n:"boxn",lat:"latitude",lng:"longitude"},fuse=new Fuse([dummySearchItem],fuseOptions);function activity_icon_filepath(e){var t={1:"bike",2:"swim",3:"boat",4:"hike",5:"fish",6:"archery",7:"xcski",9:"geocache",11:"horse",12:"mtnbike",13:"picnic",14:"",15:"sled",16:"snowshoe",17:"",18:"leafman",19:"geology",20:"history",21:"dine",22:"",23:"leafman",24:"",25:"fitness",26:"",30:"golf",39:"fitness",41:""}[e];return t?"/static/images/activities/"+t+".svg":null}function str_to_bool(e){switch(e){case"Yes":case"yes":case"True":case"true":case"1":case 1:case!0:return!0;case"No":case"no":case"False":case"false":case"0":case 0:case!1:case"":case null:default:return!1}}$.get(API_NEW_BASE_URL+"categories",null,function(e){for(var t=0;t<e.data.length;t++){var a=e.data[t].categorytypeid;CM.categories[a]={name:e.data[t].name}}$.event.trigger({type:"dataReadyCategories"})},"json"),$.get(API_NEW_BASE_URL+"visitor_centers",null,function(e){CM.visitor_centers=e.data,CM.visitor_centers.forEach(function(e){e.categories=e.categories?e.categories.split("|").map(Number):null,e.amenities=e.amenities?e.amenities.split("|").map(Number):null,e.activities=e.activities?e.activities.split("|").map(Number):null}),$.event.trigger({type:"dataReadyVisitorCenters"})},"json"),$.get(API_NEW_BASE_URL+"reservations",null,function(e){CM.reservations=e.data,CM.reservations.forEach(function(e){searchItem={title:e.pagetitle,gid:e.record_id,type:"reservation_new",w:e.boxw,s:e.boxs,e:e.boxe,n:e.boxn,lat:e.latitude,lng:e.longitude},fuse.add(searchItem)}),$.event.trigger({type:"dataReadyReservations"})},"json"),$.get(API_NEW_BASE_URL+"attractions",null,function(e){CM.attractions=e.data,CM.attractions.forEach(function(e){e.categories=e.categories?e.categories.split("|").map(Number):null,e.amenities=e.amenities?e.amenities.split("|").map(Number):null,e.activities=e.activities?e.activities.split("|").map(Number):null}),CM.attractions.forEach(function(e){searchItem={title:e.pagetitle,gid:e.gis_id,type:"attraction",w:null,s:null,e:null,n:null,lat:e.latitude,lng:e.longitude},fuse.add(searchItem)}),$.event.trigger({type:"dataReadyAttractions"})},"json"),$.get(API_NEW_BASE_URL+"activities",null,function(e){for(var t=0;t<e.data.length;t++){var a=e.data[t].eventactivitytypeid;CM.activities[a]=e.data[t],CM.activities[a].icon=activity_icon_filepath(a)}$.event.trigger({type:"dataReadyActivities"})},"json"),$.get(API_NEW_BASE_URL+"autocomplete_keywords",null,function(e){for(var t=0;t<e.data.length;t++)CM.autocomplete_keywords.push(e.data[t].word);$.event.trigger({type:"dataReadyAutocompleteKeywords"})},"json"),$.get(API_NEW_BASE_URL+"trails",null,function(e){for(var t=0;t<e.data.length;t++)trail=e.data[t],trail.bike=str_to_bool(trail.bike),trail.hike=str_to_bool(trail.hike),trail.bridle=str_to_bool(trail.bridle),trail.mountainbike=str_to_bool(trail.mountainbike),CM.trails[e.data[t].id]=trail;CM.trails.forEach(function(e){searchItem={title:e.pagetitle,gid:e.record_id,type:"trail",w:e.boxw,s:e.boxs,e:e.boxe,n:e.boxn,lat:e.latitude,lng:e.longitude},fuse.add(searchItem)}),$.event.trigger({type:"dataReadyTrails"})},"json"),CM.get_reservation=function(e){for(var t=0;t<CM.reservations.length;t++)if(CM.reservations[t].record_id==e)return CM.reservations[t]},CM.get_attraction=function(e){for(var t=0;t<CM.attractions.length;t++)if(CM.attractions[t].gis_id==e)return CM.attractions[t]},CM.get_attractions_by_activity=function(n){n=(n=Array.isArray(n)?n:[n]).map(Number);var i=[];return CM.attractions.forEach(function(e){for(var t=!0,a=0;a<n.length;a++)if(!e.activities||!e.activities.includes(n[a])){t=!1;break}t&&i.push(e)}),i},CM.get_attractions_by_amenity=function(n){n=(n=Array.isArray(n)?n:[n]).map(Number);var i=[];return CM.attractions.forEach(function(e){for(var t=!0,a=0;a<n.length;a++)if(!e.amenities||!e.amenities.includes(n[a])){t=!1;break}t&&i.push(e)}),i};var WINDOW_URL=null,WINDOW_URL_QUERYSTRING=null,sidebar=null,LAST_BEEP_IDS=[],LAST_KNOWN_LOCATION=new mapboxgl.LngLat.convert(START_CENTER),AUTO_CENTER_ON_LOCATION=!1,DEFAULT_SORT="distance";function createStartHereTooltip(){var e=$(".sidebar-tabs ul li:first")[0],t=$("body > div.ui-page")[0];return new Tooltip(e,{title:"Start exploring here!",container:t,placement:"right",trigger:"manual"})}function switchToMap(){sidebarCoversMap()&&sidebar.close()}function loadMapAndStartingState(){var a=new URLSearchParams(location.search),e=a.get("lat")||a.get("y"),t=a.get("lng")||a.get("x"),n=a.get("zoom")||a.get("z");if(mapOptions={base:a.get("base"),lat:e,lng:t,zoom:n,drop_marker:!1},initMap(mapOptions),a.get("type")&&a.get("gid"))switch(a.get("type")){case"attraction":$(document).on("dataReadyAttractions",function(){var e=a.get("gid"),t={};if((attraction=CM.get_attraction(e))&&(t.gid=attraction.gis_id,t.title=attraction.pagetitle,t.lat=attraction.latitude,t.lng=attraction.longitude),!t.lat||!t.lng)return alert("Cound not find that feature.");zoomToFeature(t),showAttractionInfo(a.get("type"),t)});break;case"reservation_new":$(document).on("dataReadyReservations",function(){var e=a.get("gid"),t={type:"reservation_new"};if((reservation=CM.get_reservation(e))&&(t.gid=reservation.record_id,t.w=reservation.boxw,t.n=reservation.boxn,t.e=reservation.boxe,t.s=reservation.boxs,t.lat=reservation.latitude,t.lng=reservation.longitude),!(t.w&&t.n&&t.e&&t.s||t.lat&&t.lng))return alert("Cound not find that reservation.");zoomToFeature(t),showFeatureInfo(t)});break;case"loop":showFeatureInfo({type:"loop",gid:a.get("gid")},!0)}if(a.get("routefrom")&&a.get("routeto")&&a.get("routevia")){var i=a.get("routefrom").split(",")[0],r=a.get("routefrom").split(",")[1],o=a.get("routeto").split(",")[0],l=a.get("routeto").split(",")[1],s=a.get("routevia");sidebar.open("pane-getdirections"),$("#getdirections_disabled").hide(),$("#getdirections_enabled").show(),$("#directions_target_title").text(a.get("routetitle")),$("#directions_via").val(a.get("routevia")),$("#directions_via").selectmenu("refresh"),$("#directions_type").val("geocode"),$("#directions_type").selectmenu("refresh"),$("#directions_type_geocode_wrap").show(),$("#directions_address").val(a.get("routefrom")),$("#directions_target_lat").val(o),$("#directions_target_lng").val(l),$("#directions_via").trigger("change"),$("#directions_address").val(a.get("fromaddr")),$("#directions_reverse").val(a.get("whichway")),$("#directions_via_bike").val(a.get("routevia_bike")),setTimeout(function(){$("#directions_reverse").trigger("change")},1e3),$("#directions_type").val(a.get("loctype")),getDirections(i,r,o,l,"to",s)}var c=a.get("base")||"map",d=$('input[name="basemap"][value="photo"]'),u=$('input[name="basemap"][value="map"]');switch(c){case"photo":d.prop("checked",!0).checkboxradio("refresh"),u.prop("checked",!1).checkboxradio("refresh");break;case"map":default:d.prop("checked",!1).checkboxradio("refresh"),u.prop("checked",!0).checkboxradio("refresh")}$.event.trigger({type:"mapReady"})}function showAttractionInfo(e,t){$("#directions_target_lat").val(t.lat),$("#directions_target_lng").val(t.lng),$("#directions_target_type").val(t.type),$("#directions_target_gid").val(t.gid),$("#directions_target_title").text(t.title),sidebar.open("pane-info"),set_pane_back_button("#pane-info","#pane-browse"),$("#getdirections_disabled").hide(),$("#getdirections_enabled").show(),$("#show_on_map").data("wkt",null),$("#info-content").text("Loading...");var a=t.gid||t.record_id;a&&showAttractionInfoContent(e,a)}function make_image_from_pagethumbnail(e,t){e=e.replace("~/","https://www.clevelandmetroparks.com/");var a=new URL(e),n=a.searchParams.get("width"),i=a.searchParams.get("height"),r=a.searchParams;return new_height=parseInt(i/(n/t)),r.set("width",2*t),r.set("height",2*new_height),{src:a.protocol+"//"+a.hostname+a.pathname+"?"+r.toString(),width:t,height:new_height}}function make_activity_icons_list(e){var t=[];return e.forEach(function(e){t.push({src:CM.activities[e].icon,title:CM.activities[e].pagetitle,alt:CM.activities[e].pagetitle})}),t}function showAttractionInfoContent(e,t){switch(e){case"attraction":var a=CM.get_attraction(t),n=CM.Templates.info_attraction,i=make_activity_icons_list(a.activities),r=[];a.pagethumbnail&&(r=make_image_from_pagethumbnail(a.pagethumbnail,320));var o={feature:a,activity_icons:i,img:r};$("#info-content").html(n(o));break;case"reservation_new":var l=CM.get_reservation(t);n=CM.Templates.info_reservation;l.pagethumbnail&&(r=make_image_from_pagethumbnail(l.pagethumbnail,320));o={feature:l,img:r};$("#info-content").html(n(o));break;case"loop":if(t in CM.trails){var s=CM.trails[t];n=CM.Templates.info_trail,o={feature:s,img_src:"static/images/loops/"+s.id+".jpg"};$("#info-content").html(n(o))}else console.log("ERROR: loop id: "+t+" does not exist in CM.trails (app_view_trails).")}}function showElevation(e){$("#elevation").prop("src",e),sidebar.open("pane-elevationprofile")}function showFeatureInfo(e,n){if(prepareInfoPaneForFeature(e),e.type&&e.gid){var t={type:e.type,gid:e.gid||e.record_id};$.get(API_BASEPATH+"ajax/moreinfo",t,function(e){if(SKIP_TO_DIRECTIONS)return $("#directions_car").click(),void(SKIP_TO_DIRECTIONS=!1);$("#info-content").html(e),n&&zoomToFeature(e);var t=$("#info-content").find("div.wkt");if(t){var a=t.text();a&&(showWkt(a),$("#show_on_map").data("wkt",a),t.remove())}},"html")}else $("#info-content").html($("<h1></h1>").text(e.title)),$("#directions_car").click()}function zoomElementClick(e){var t=getFeatureFromElement(e);prepareInfoPaneForFeature(t),showFeatureInfo(t),showOnMap(t)}function prepareInfoPaneForFeature(e){$("#show_on_map").data("zoomelement",e),$("#show_on_map").data("wkt",null),$("#directions_target_lat").val(e.lat),$("#directions_target_lng").val(e.lng),$("#directions_target_type").val(e.type),$("#directions_target_gid").val(e.gid),$("#directions_target_title").text(e.title),sidebar.open("pane-info"),e.back_url||(e.back_url="#pane-browse"),set_pane_back_button("#pane-info",e.back_url),$("#getdirections_disabled").hide(),$("#getdirections_enabled").show(),$("#info-content").text("Loading...")}function getFeatureFromElement(e){var t={};return t.title=e.attr("title"),t.w=e.attr("w"),t.s=e.attr("s"),t.e=e.attr("e"),t.n=e.attr("n"),t.lat=e.attr("lat"),t.lng=e.attr("lng"),t.type=e.attr("type"),"reservation_new"==t.type?t.gid=e.attr("record_id"):t.gid=e.attr("gid"),t.back_url=e.attr("backbutton"),t}function sortLists(e){if(e||(e=$(".sidebar-pane.active ul.distance_sortable").eq(0)).length){switch(e.find(".zoom_distance").each(function(){var e=$(this).parent().parent(),t=new mapboxgl.LngLat(e.attr("lng"),e.attr("lat")),a=distanceTo(LAST_KNOWN_LOCATION,t),n=bearingToInNESW(LAST_KNOWN_LOCATION,t),i=3.2808399*a,r=900<i?(a/1609.344).toFixed(1)+" mi":i.toFixed(0)+" ft";r+=" "+n,$(this).text(r),e.data("meters",a)}),DEFAULT_SORT){case"distance":e.children("li").sort(function(e,t){return $(e).data("meters")>$(t).data("meters")?1:-1});break;case"alphabetical":e.children("li").sort(function(e,t){return $(e).attr("title")>$(t).attr("title")?1:-1})}e.children("li.ui-first-child").removeClass("ui-first-child"),e.children("li").first().addClass("ui-first-child"),e.children("li.ui-last-child").removeClass("ui-last-child"),e.children("li").last().addClass("ui-last-child")}}function showWkt(e){drawHighlightLine(new Wkt.Wkt(e).toJson())}function drawHighlightLine(e){clearHighlightLine(),MAP.addLayer({id:"highlightLine",type:"line",source:{type:"geojson",data:e},layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#01B3FD","line-width":6,"line-opacity":.75}})}function clearHighlightLine(){MAP.getLayer("highlightLine")&&MAP.removeLayer("highlightLine"),MAP.getSource("highlightLine")&&MAP.removeSource("highlightLine")}function zoomToAddress(e){if(!e)return!1;$.get(API_NEW_BASE_URL+"geocode/"+e,null,function(e){if(!e.data)return alert("We couldn't find that address or city.\nPlease try again.");var t=new mapboxgl.LngLat(e.data.lng,e.data.lat);if(!MAX_BOUNDS.contains(t))return alert("The only results we could find are too far away to zoom the map there.");switchToMap(),placeMarker(MARKER_TARGET,e.data.lat,e.data.lng),MAP.flyTo({center:t,zoom:DEFAULT_POI_ZOOM});var a='<h3 class="popup_title">'+e.data.title+"</h3>";a+='<span class="fakelink zoom" title="'+e.data.title+'" lat="'+e.data.lat+'" lng="'+e.data.lng+'" w="'+e.data.w+'" s="'+e.data.s+'" e="'+e.data.e+'" n="'+e.data.n+'" onClick="zoomElementClick($(this));">Directions</span>';(new mapboxgl.Popup).setLngLat(t).setHTML(a).addTo(MAP)},"json")}function showOnMap(e,t){e.type&&e.gid&&0!=e.gid&&setWindowURLQueryStringParameters({type:e.type,gid:e.gid},!1,!0);zoomToFeature(e,t)}function zoomToFeature(e,t){if(clearMarker(MARKER_TARGET),clearHighlightLine(),t&&switchToMap(),e.w&&e.s&&e.e&&e.n&&0!=e.w&&0!=e.s&&0!=e.e&&0!=e.n){var a=new mapboxgl.LngLat(e.w,e.s),n=new mapboxgl.LngLat(e.e,e.n),i=new mapboxgl.LngLatBounds(a,n);MAP.fitBounds(i,{padding:10})}else e.lng&&e.lat&&MAP.flyTo({center:[e.lng,e.lat],zoom:DEFAULT_POI_ZOOM});"poi"!=e.type&&"attraction"!=e.type&&"loop"!=e.type||placeMarker(MARKER_TARGET,e.lat,e.lng),e.wkt&&showWkt(e.wkt)}function setupWindowURLUpdates(){MAP.on("zoomend",updateWindowURLZoom),MAP.on("moveend",updateWindowURLCenter),MAP.on("layerremove",updateWindowURLLayer),MAP.on("layeradd",updateWindowURLLayer)}function updateWindowURLCenter(){var e=MAP.getCenter(),t=e.lat.toFixed(7),a=e.lng.toFixed(7);invalidateWindowURL(),params={lat:t,lng:a},setWindowURLQueryStringParameters(params,!1,!1)}function updateWindowURLZoom(){var e=MAP.getZoom().toFixed(1);invalidateWindowURL(),setWindowURLQueryStringParameters({zoom:e},!1)}function updateWindowURLLayer(){var e="map";"photo"==getBasemap()&&(e="photo"),invalidateWindowURL(),setWindowURLQueryStringParameters({base:e},!1)}function invalidateWindowURL(){hideShareURL()}function changeCoordinateFormat(e){SETTINGS.coordinate_format=e,localStorage.setItem("coordinateFormat",e)}function getSessionCoordinateFormat(){var e=localStorage.getItem("coordinateFormat");"dms"!=e&&"ddm"!=e&&"dd"!=e||(SETTINGS.coordinate_format=e,$("#coordinate_format input[name=coordinate_format]").prop("checked",!1).checkboxradio("refresh"),$("#coordinate_format input[name=coordinate_format][value="+e+"]").prop("checked",!0).checkboxradio("refresh"),update_user_latlon_display())}function wmsGetFeatureInfoByPoint(e,t){var a=MAP.unproject([e.x-20,e.y+20]),n=MAP.unproject([e.x+20,e.y-20]);wmsGetFeatureInfoByBbox(new mapboxgl.LngLatBounds(a,n),t)}function wmsGetFeatureInfoByBbox(e,t){var a={w:e.getWest(),s:e.getSouth(),e:e.getEast(),n:e.getNorth(),zoom:MAP.getZoom()};$.get(API_BASEPATH+"ajax/query",a,function(e){if(e)(new mapboxgl.Popup).setLngLat(t).setHTML(e).addTo(MAP)},"html")}function sidebarCoversMap(){return window_width=$(window).width(),window_width<=768}function basicGeolocate(){navigator.geolocation.getCurrentPosition(geolocateSuccess,null,{enableHighAccuracy:!0})}function geolocateSuccess(e){LAST_KNOWN_LOCATION.lng=e.coords.longitude,LAST_KNOWN_LOCATION.lat=e.coords.latitude}function update_user_latlon_display(e){!e&&LAST_KNOWN_LOCATION&&(e=LAST_KNOWN_LOCATION),latlng_str=e?latlng_formatted(e):"unknown",$("#gps_location").val(latlng_str)}function launchNativeExternalDirections(e,t,a,n,i,r,o){var l=[e,t],s=[a,n];"from"==i&&(l=[a,n],s=[e,t]),options={enableDebug:!0,transportMode:c},o||(options.start=l);var c="bus"==r?launchnavigator.TRANSPORT_MODE.TRANSIT:launchnavigator.TRANSPORT_MODE.DRIVING;launchnavigator.navigate(s,options)}function getDirections(e,t,a,n,i,r,o){$("#directions_steps").empty(),disableDirectionsButton(),$("#directions_source_lat").val(e),$("#directions_source_lng").val(t);var l=$("#directions_prefer").val();if(NATIVE_APP&&("car"==r||"bus"==r))return launchNativeExternalDirections(e,t,a,n,i,r,o),void enableDirectionsButton();var s={sourcelat:e,sourcelng:t,targetlat:a,targetlng:n,tofrom:i,via:r,prefer:l,bing_key:BING_API_KEY};$.get(API_BASEPATH+"ajax/directions",s,function(e){if(enableDirectionsButton(),!e||!e.wkt){var t="Could not find directions.";return"hike"!=r&&(t+="\nTry a different type of trail, terrain, or difficulty."),alert(t)}renderDirectionsStructure(e)},"json")}function disableDirectionsButton(){var e=$("#directions_button");e.button("disable"),e.closest(".ui-btn").find(".ui-btn-text").text(e.attr("value0"))}function enableDirectionsButton(){var e=$("#directions_button");e.button("enable"),e.closest(".ui-btn").find(".ui-btn-text").text(e.attr("value1"))}function processGetDirectionsForm(){var r,o,e=$("#directions_reverse").val(),t=$("#directions_via").val();"bike"==t&&(t=$("#directions_via_bike").val()),$("#directions_source_gid").val(""),$("#directions_source_type").val(""),$.ajaxSetup({async:!1});var a=!1;switch($("#directions_type").val()){case"gps":a=!0,r=LAST_KNOWN_LOCATION.lat,o=LAST_KNOWN_LOCATION.lng;break;case"geocode":var l=$("#directions_address").val();if(!l)return alert("Please enter an address, city, or landmark.");var n=/^(\d+\.\d+)\,(\-\d+\.\d+)$/.exec(l);n?(r=parseFloat(n[1]),o=parseFloat(n[2]),getDirections(r,o,s,c,e,t)):(disableDirectionsButton(),$.get(API_NEW_BASE_URL+"geocode/"+l,null,function(e){if(enableDirectionsButton(),!e)return alert("We couldn't find that address or city.\nPlease try again.");var t=new mapboxgl.LngLat(e.data.lng,e.data.lat);if(!MAX_BOUNDS.contains(t)){var a={rtp:"adr."+l+"~"+("pos."+s+"_"+c)},n="http://bing.com/maps/default.aspx?"+$.param(a),i=$("#directions_steps");return i.empty(),i.append($("<div></div>").html("The address you have chosen is outside of the covered area.<br/>Click the link below to go to Bing Maps for directions.")),void i.append($("<a></a>").text("Click here for directions from Bing Maps").prop("href",n).prop("target","_blank"))}},"json"));break;case"features":disableDirectionsButton();var i={};if(i.keyword=$("#directions_address").val(),i.limit=30,i.lat=LAST_KNOWN_LOCATION.lat,i.lng=LAST_KNOWN_LOCATION.lng,$.get(API_BASEPATH+"ajax/keyword",i,function(e){if(enableDirectionsButton(),!e||!e.length)return alert("We couldn't find any matching landmarks.");for(var t=$("#directions_address").val().replace(/\W/g,"").toLowerCase(),a=0,n=e.length;a<n;a++){if(e[a].name.replace(/\W/g,"").toLowerCase()==t){e=[e[a]];break}}if(1<e.length)return o=r=null,void populateDidYouMean(e);var i=e[0].name.replace(/^\s*/,"").replace(/\s*$/,"");$("#directions_address").val(i),$("#directions_source_gid").val(e[0].gid),$("#directions_source_type").val(e[0].type),r=parseFloat(e[0].lat),o=parseFloat(e[0].lng)},"json"),!r||!o)return}var s=parseFloat($("#directions_target_lat").val()),c=parseFloat($("#directions_target_lng").val()),d=$("#directions_source_gid").val(),u=$("#directions_source_type").val();if("poi"==u||"attraction"==u||"reservation"==u||"trail"==u){var p=geocodeLocationForDirections(u,d,s,c,t,"#directions_source_lat","#directions_source_lng");r=p.lat,o=p.lng}var _=$("#directions_target_gid").val(),g=$("#directions_target_type").val();if("poi"==g||"attraction"==g||"reservation"==g||"trail"==g){var f=geocodeLocationForDirections(g,_,r,o,t,"#directions_target_lat","#directions_target_lng");s=f.lat,c=f.lng}if(!s||!c)return alert("Please close the directions panel, and pick a location.");$.ajaxSetup({async:!0}),getDirections(r,o,s,c,e,t,a)}function geocodeLocationForDirections(e,t,a,n,i,r,o){var l={};switch(console.log("____geocodeLocationForDirections()____"),console.log("loc_type:",e),e){case"attraction":var s=CM.get_attraction(t);console.log(s),console.log("via:",i),"car"==i&&s.drivingdestinationlatitude&&s.drivingdestinationlongitude?(l.lat=s.drivingdestinationlatitude,l.lng=s.drivingdestinationlongitude):(l.lat=s.latitude,l.lng=s.longitude);break;case"trail":var c=CM.trails[t];console.log(c);break;case"reservation":case"reservation_new":var d=CM.get_reservation([t]);console.log(d),console.log("via:",i),"car"==i&&d.drivingdestinationlatitude&&d.drivingdestinationlongitude?(l.lat=d.drivingdestinationlatitude,l.lng=d.drivingdestinationlongitude):(l.lat=d.latitude,l.lng=d.longitude);break;default:console.log("ERROR: in geocodeLocationForDirections(), type: "+e)}return l[a]&&l[n]&&($(r).val(reply.lat),$(o).val(reply.lng)),console.log("output_location:",l),l}function populateDidYouMean(e){var t=$("#directions_steps");t.empty();var a=$("<li></li>").addClass("did-you-mean").text("Did you mean:");t.append(a);for(var n=0,i=e.length;n<i;n++){var r=e[n],o=r.name.replace(/^\s*/,"").replace(/\s*$/,"");(a=$("<li></li>")).append($("<span></span>").addClass("ui-li-heading").text(o)).attr("type",r.type).attr("gid",r.gid);a.click(function(){$("#directions_address").val($(this).text()),$("#directions_source_gid").val($(this).attr("gid")),$("#directions_source_type").val($(this).attr("type")),$("#directions_button").click()}),a.css({cursor:"pointer"}),t.append(a)}t.listview("refresh")}function renderDirectionsStructure(e,t,a){var n=new mapboxgl.LngLat(e.start.lng,e.start.lat),i=new mapboxgl.LngLat(e.end.lng,e.end.lat);drawDirectionsLine(new Wkt.Wkt(e.wkt).toJson(),n,i);var r=new mapboxgl.LngLat(e.bounds.west,e.bounds.south),o=new mapboxgl.LngLat(e.bounds.east,e.bounds.north),l=new mapboxgl.LngLatBounds(r,o);MAP.fitBounds(l,{padding:10}),(t=t||$("#directions_steps")).empty();for(var s=0,c=e.steps.length;s<c;s++){var d=e.steps[s],u=$("<li></li>"),p=d.stepnumber?d.stepnumber+". "+(d.turnword?d.turnword:"")+" "+d.text:d.turnword+" "+d.text;if(u.append($("<span></span>").addClass("ui-li-heading").text(p)),d.distance&&d.duration&&"0"!=d.distance.substr(0,1)){var _=d.distance+", "+d.duration;u.append($("<span></span>").addClass("ui-li-desc").text(_))}t.append(u)}var g=$("<span></span>").addClass("ui-li-desc").html("");e.retries&&3<e.retries&&g.html("Route may be approximated.");var f=$("<span></span>").addClass("ui-li-heading").html("<b>Total:</b> "+e.totals.distance+", "+e.totals.duration);t.append($("<li></li>").append(f).append(g));var h=$("<div></div>").addClass("directions_functions");if(e.elevationprofile){var m=$("<a></a>").addClass("ui-btn").addClass("ui-btn-inline").addClass("ui-corner-all").prop("id","elevationprofile_button").text("Elevation Profile");m.attr("value1","Elevation Profile").attr("value0","Loading"),m.click(function(){makeElevationProfileChart(),sidebar.open("pane-elevationprofile")}),h.append(m)}var v=$("<a></a>").addClass("ui-btn").addClass("ui-btn-inline").addClass("ui-corner-all").text("Clear");v.click(function(){$("#directions_steps").empty(),clearDirectionsLine(),$(".directions_functions").empty()}),h.append(v);var b=$("<a></a>").addClass("ui-btn").addClass("ui-btn-inline").addClass("ui-corner-all").prop("id","share_route_button").text("Share");if(b.click(function(){updateWindowURLWithDirections(),makeAndShowShortURL(),sidebar.open("pane-share")}),h.append(b),!NATIVE_APP){var y=$("<a></a>").addClass("ui-btn").addClass("ui-btn-inline").addClass("ui-corner-all").text("Print");y.click(function(){$("#button_print").click()}),h.append(y)}t.after(h),ELEVATION_PROFILE=[],e.elevationprofile&&(ELEVATION_PROFILE=e.elevationprofile),t.listview("refresh"),$(".directions_functions img:first").removeClass("ui-li-thumb")}function drawDirectionsLine(e,t,a){clearDirectionsLine(),MAP.addLayer({id:"directionsLine",type:"line",source:{type:"geojson",data:e},layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#0000FF","line-width":6,"line-opacity":.5}}),placeMarker(MARKER_START,t.lat,t.lng),placeMarker(MARKER_END,a.lat,a.lng)}function clearDirectionsLine(){MAP.getLayer("directionsLine")&&MAP.removeLayer("directionsLine"),MAP.getSource("directionsLine")&&MAP.removeSource("directionsLine"),clearMarker(MARKER_START),clearMarker(MARKER_END),$("#directions_steps").empty(),$("#measure_steps").empty()}function makeElevationProfileChart(){if(ELEVATION_PROFILE){for(var e=[],t=0,a=ELEVATION_PROFILE.length;t<a;t++)e.push({x:ELEVATION_PROFILE[t].x/5280,y:ELEVATION_PROFILE[t].y});var n=document.getElementById("elevation-profile").getContext("2d");new Chart(n,{type:"line",data:{datasets:[{label:"Elevation Profile",data:e,pointRadius:0,backgroundColor:"rgba(0, 0, 0, 0.2)",borderColor:"rgba(0, 0, 0, 1)",borderWidth:2,fill:!1}]},options:{scales:{yAxes:[{scaleLabel:{display:!0,labelString:"Elevation (feet)",fontColor:"#000"}}],xAxes:[{type:"linear",scaleLabel:{display:!0,labelString:"Distance (miles)",fontColor:"#000"},ticks:{min:0,precision:2}}]}}})}}function showShareURL(){$("#share_url_controls").show(),$("#make_share_url_controls").hide(),setShareURLBoxWidth()}function hideShareURL(){$("#share_url_controls").hide(),$("#make_share_url_controls").show()}function makeAndShowShortURL(){var e;NATIVE_APP?e=WINDOW_URL_QUERYSTRING:("/"==(e=WINDOW_URL).charAt(0)&&(e=e.substr(1)),"?"==e.charAt(0)&&(e=e.substr(1)));var t={querystring:e="/?"+e};$.post(API_NEW_BASE_URL+"shorturls/",t,function(e){var t=new URL(location.href),a=("file:"!=t.protocol?t.protocol:WEBAPP_BASE_URL_ABSOLUTE_PROTOCOL)+"//"+(t.host?t.host:WEBAPP_BASE_URL_ABSOLUTE_HOST)+"/url/"+e.data.shortcode;$("#share_url").val(a),showShareURL()}).fail(function(){alert("Unable to fetch a short URL.\nPlease try again.")})}function setShareURLBoxWidth(){var e=$("#share_url_controls").width(),t=$("#pane-share .copy-to-clipboard").outerWidth(),a=$("#share_url_controls .ui-input-text"),n=e-t-(a.outerWidth()-a.width());a.width(n)}function updateWindowURLWithDirections(){if($("#directions_source_lat").val()){var e={};"photo"==getBasemap()?e.base="photo":e.base="map",e.routevia=$("#directions_via").val(),e.routevia_bike=$("#directions_via_bike").val(),e.routefrom=$("#directions_source_lat").val()+","+$("#directions_source_lng").val(),e.routeto=$("#directions_target_lat").val()+","+$("#directions_target_lng").val(),e.routetitle=$("#directions_target_title").text(),e.whichway=$("#directions_reverse").val(),e.loctype=$("#directions_type").val(),e.fromaddr=$("#directions_address").val(),"trail"==e.routevia&&(e.routevia=$("#directions_via_trail").val()),setWindowURLQueryStringParameters(e,!0,!0)}}function createCopiedToClipboardTooltip(e,t){return new Tooltip(e,{title:"Copied to clipboard.",container:t,placement:"bottom",trigger:"manual"})}function disableKeywordButton(){var e=$("#search_keyword_button");e.button("disable"),e.closest(".ui-btn").find(".ui-btn-text").text(e.attr("value0"))}function enableKeywordButton(){var e=$("#search_keyword_button");e.button("enable"),e.closest(".ui-btn").find(".ui-btn-text").text(e.attr("value1"))}function strToLngLat(e){if((e=e.replace(/\s+$/,"").replace(/^\s+/,"")).match(/^[\d\.\-\,\s]+$/)){var t=e.split(/[\s\,]+/);if(2==t.length)if(t[0]=parseFloat(t[0]),t[1]=parseFloat(t[1]),t[0]&&t[1])return i=t[0]<0?(n=t[1],t[0]):(n=t[0],t[1]),new mapboxgl.LngLat(i,n)}var a=e.match(/^N\s*(\d\d)\s+(\d\d\.\d\d\d)\s+W\s*(\d\d\d)\s+(\d\d\.\d\d\d)$/i);if(a){var n=parseInt(a[1])+parseInt(a[2])/60,i=-parseInt(a[3])-parseInt(a[4])/60;return new mapboxgl.LngLat(i,n)}return null}function searchByKeyword(e){var t=strToLngLat(e);if(t)return MAP.flyTo({center:t,zoom:16}),void placeMarker(MARKER_TARGET,t.lat,t.lng);var a=$("#keyword_results");a.empty(),disableKeywordButton(),$("#pane-search .sortpicker").hide();var n=fuse.search(e);if(enableKeywordButton(),$("#pane-search .sortpicker").show(),!n.length)return $("<li></li>").text("No Cleveland Metroparks results found. Trying an address search.").appendTo(a),void zoomToAddress(e);for(var i=0,r=n.length;i<r;i++){var o=n[i].item,l=$("<li></li>").addClass("zoom").addClass("ui-li-has-count");l.attr("title",o.title).attr("gid",o.gid).attr("type",o.type).attr("w",o.w).attr("s",o.s).attr("e",o.e).attr("n",o.n).attr("lat",o.lat).attr("lng",o.lng),l.attr("backbutton","#pane-search"),link=$("<a></a>"),link.attr("class","ui-btn ui-btn-text"),l.click(function(){zoomElementClick($(this))}),l.append(link),link.append($("<h4></h4>").addClass("ui-li-heading").text(o.title)),link.append($("<span></span>").addClass("ui-li-desc").text(o.description)),link.append($("<span></span>").addClass("zoom_distance").addClass("ui-li-count").addClass("ui-btn-up-c").addClass("ui-btn-corner-all").text("0 mi")),l.append(link),a.append(l)}a.listview("refresh"),sortLists(a)}function turfPointToLngLat(e){return new mapboxgl.LngLat.convert(e.geometry.coordinates)}function distanceTo(e,t){var a=turf.point(e.toArray()),n=turf.point(t.toArray());return turf.distance(a,n,{units:"meters"})}function bearingTo(e,t){var a=turf.point(e.toArray()),n=turf.point(t.toArray());return turf.bearing(a,n,{final:!0})}function bearingToInNESW(e,t){var a=bearingTo(e,t);return 22<=a&&a<=67?"NE":67<=a&&a<=112?"E":112<=a&&a<=157?"SE":157<=a&&a<=202?"S":202<=a&&a<=247?"SW":247<=a&&a<=292?"W":292<=a&&a<=337?"NW":337<=a||a<=22?"N":void 0}function addActivityTypesToNearby(){var a='<fieldset id="nearby-activities" data-role="controlgroup">';$.each(CM.activities,function(e,t){t&&t.pagetitle&&(a+='<label><input type="checkbox" name="nearby-category" value="'+t.pagetitle+'">'+t.pagetitle+"</label>")}),a+="</fieldset>",$(".form-group-wrapper").append(a).enhanceWithin()}function updateNearYouNow(){for(var e=$("#alerts"),t=0,a=CM.attractions_nearby.length;t<a;t++){var n=CM.attractions_nearby[t],i=new mapboxgl.LngLat(n.longitude,n.latitude);n.meters=distanceTo(LAST_KNOWN_LOCATION,i),n.miles=n.meters/1609.344,n.feet=3.2808399*n.meters,n.range=900<n.feet?n.miles.toFixed(1)+" mi":n.feet.toFixed(0)+" ft",n.bearing=bearingToInNESW(LAST_KNOWN_LOCATION,i)}CM.attractions_nearby.sort(function(e,t){return e.meters-t.meters});var r=CM.attractions_nearby.slice(0,25);e.empty();for(t=0,a=r.length;t<a;t++){n=r[t];var o=$("<li></li>").addClass("zoom").addClass("ui-li-has-count");o.attr("title",n.pagetitle),o.attr("category",n.categories),o.attr("type","attraction").attr("gid",n.gis_id),o.attr("lat",n.latitude).attr("lng",n.longitude),o.attr("backbutton","#pane-nearby");var l=$("<div></div>").addClass("ui-btn-text");l.append($("<h2></h2>").text(n.pagetitle));var s="";n.categories.forEach(function(e,t){0<t&&(s+="; "),s+=CM.categories[e].name}),l.append($("<p></p>").text(s)),l.append($("<span></span>").addClass("zoom_distance").addClass("ui-li-count").addClass("ui-btn-up-c").addClass("ui-btn-corner-all").text(n.range+" "+n.bearing)),o.click(function(){zoomElementClick($(this))}),o.append(l),e.append(o)}e.listview("refresh")}function placeCircle(e,t){clearCircle();var a=t/1e3,n=turf.circle(turf.point(e.toArray()),a,{units:"kilometers"});MAP.addLayer({id:"circle",type:"fill",source:{type:"geojson",data:n},layout:{},paint:{"fill-color":"#21A1F3","fill-opacity":.3}})}function clearCircle(){MAP.getLayer("circle")&&MAP.removeLayer("circle"),MAP.getSource("circle")&&MAP.removeSource("circle")}function checkNearby(e,t,a){t=parseFloat(t);for(var n=[],i=0,r=CM.attractions_nearby.length;i<r;i++){var o=CM.attractions_nearby[i],l=distanceTo(e,new mapboxgl.LngLat(o.longitude,o.latitude));if(!(t<l)){if(a){for(var s=o.categories.split("; "),c=!1,d=0,u=s.length;d<u;d++)for(var p=0,_=a.length;p<_;p++)if(a[p]==s[d]){c=!0;break}if(!c)continue}var g=3.2808399*l,f=900<g?(l/1609.344).toFixed(1)+" mi":g.toFixed(0)+" ft";n[n.length]={gid:o.gid,title:o.title,range:f}}}var h=!1;for(i=0,r=n.length;i<r;i++){var m=parseInt(n[i].gid);if(-1==LAST_BEEP_IDS.indexOf(m)){h=!0;break}}LAST_BEEP_IDS=[];for(i=0,r=n.length;i<r;i++){m=parseInt(n[i].gid);LAST_BEEP_IDS[LAST_BEEP_IDS.length]=m}if(LAST_BEEP_IDS.sort(),h){document.getElementById("alert_beep").play();var v=[];for(i=0,r=n.length;i<r;i++)v[v.length]=n[i].title+", "+n[i].range;setTimeout(function(){alert(v.join("\n"))},1e3)}}function filterTrails(t,a,n,i){"bike"==t.substr(0,4)&&(t="bike");var e=CM.trails.filter(function(e){return!(t&&!e[t])&&((!a||e.res==a)&&(void 0===n||!i||!(e.distance_feet<n||e.distance_feet>i)))});return e}function doTrailSearch(){$("#loops_list li").show();var e=$("#loops_filter_type").val(),t=filterTrails(e,$("#loops_filter_reservation").val(),5280*parseInt($("#loops_filter_distance_min").val()),5280*parseInt($("#loops_filter_distance_max").val())),a=$("#loops_list");if(a.empty(),$(".results-notes").remove(),!t||!t.length){a.after('<p class="results-notes">No results.</p>')}for(var n=0;n<t.length;n++){var i,r=t[n],o=$("<li></li>").addClass("zoom").addClass("ui-li-has-count");switch(o.attr("title",r.name).attr("gid",r.id).attr("type","loop").attr("w",r.boxw).attr("s",r.boxs).attr("e",r.boxe).attr("n",r.boxn).attr("lat",r.lat).attr("lng",r.lng),o.attr("backbutton","#pane-trails"),link=$("<a></a>"),link.attr("class","ui-btn ui-btn-text"),o.click(function(){zoomElementClick($(this))}),o.append(link),link.append($("<h4></h4>").addClass("ui-li-heading").text(r.name)),e){case"mountainbike":case"bike_Advanced":i=r.durationtext_bike;break;case"bridle":i=r.durationtext_bridle;break;case"hike":default:i=r.durationtext_hike}link.append($("<span></span>").addClass("ui-li-desc").html(r.distancetext+" &nbsp;&nbsp; "+i)),link.append($("<span></span>").addClass("zoom_distance").addClass("ui-li-count").addClass("ui-btn-up-c").addClass("ui-btn-corner-all").text("0 mi")),o.append(link),a.append(o)}$("#pane-trails .sortpicker").show(),a.listview("refresh"),sortLists(a)}$(document).on("mapInitialized",function(){if(sidebar=sidebar||$("#sidebar").sidebar(),"/"!=window.location.pathname&&!window.location.pathname.endsWith("index.html")||""!=window.location.search||sidebarCoversMap()){var e=createStartHereTooltip();setTimeout(e.show,2500),setTimeout(e.dispose,15e3),$(document).click(function(){e.hide()})}else sidebar.open("pane-welcome")}),$(document).ready(function(){loadMapAndStartingState()}),window.onpopstate=function(){loadMapAndStartingState()},$(document).ready(function(){$('input[type="radio"][name="basemap"]').change(function(){changeBasemap($(this).val())})}),$(document).ready(function(){$("div.sortpicker span").click(function(){DEFAULT_SORT=$(this).attr("value"),sortLists()})}),$(document).ready(function(){$(".zoom").click(function(){zoomElementClick($(this))})}),$(document).ready(function(){$("#geocode_button").click(function(){zoomToAddress($("#geocode_text").val())}),$("#geocode_text").keydown(function(e){13==e.keyCode&&$("#geocode_button").click()})}),$(document).ready(function(){$("#show_on_map").click(function(){var e=$(this).data("zoomelement");e&&(e.wkt=$(this).data("wkt"),showOnMap(e,!0))})}),$(document).on("mapReady",setupWindowURLUpdates),$(document).ready(function(){$('input[type="radio"][name="coordinate_format"]').change(function(){changeCoordinateFormat($(this).val()),update_user_latlon_display()})}),$(document).ready(function(){getSessionCoordinateFormat()}),$(document).on("mapReady",function(){MAP.on("click",function(e){if($(".leaflet-popup").length)return MAP.closePopup();wmsGetFeatureInfoByPoint(e.point,e.lngLat)})}),$(document).ready(function(){$(".sidebar-pane-link").click(function(){link=$(this).attr("href"),"#"==link.charAt(0)&&(pane=link.substr(1)),sidebar.open(pane)}),$('#pane-browse li a[href="#pane-activities"]').click(function(){set_pane_back_button("#pane-activities","#pane-browse")}),$('#pane-browse li a[href="#pane-trails"]').click(function(){set_pane_back_button("#pane-trails","#pane-browse"),doTrailSearch()}),$('.sidebar-tabs li a[href="#pane-nearby"]').click(function(){updateNearYouNow()}),$("#pane-activities li a").click(function(){re=/id=(\d*)/;var e=this.hash.match(re);2==e.length&&(activity_id=e[1]),sidebar.open("pane-browse-results"),pane_title=$(this).text().trim(),set_pane_back_button("#pane-browse-results","#pane-activities");var t=CM.get_attractions_by_activity(activity_id);CM.display_attractions_results(pane_title,t,"attraction")}),$("#pane-amenities li a").click(function(){re=/amenity_id=(\d*)/;var e=this.hash.match(re);2==e.length&&(amenity_id=e[1]),pane_title=$(this).text().trim(),set_pane_back_button("#pane-browse-results","#pane-amenities");var t=CM.get_attractions_by_amenity(amenity_id);CM.display_attractions_results(pane_title,t,"attraction")}),$("#pane-welcome .welcome-pane-visitorcenters a").click(function(){pane_title="Visitor Centers",set_pane_back_button("#pane-browse-results","#pane-welcome"),CM.display_attractions_results(pane_title,CM.visitor_centers,"attraction")}),$("#pane-welcome .welcome-pane-parks a").click(function(){pane_title="Parks",set_pane_back_button("#pane-browse-results","#pane-welcome"),CM.display_attractions_results(pane_title,CM.reservations,"reservation_new")}),$("#pane-welcome .welcome-pane-activities a").click(function(){set_pane_back_button("#pane-activities","#pane-welcome")}),$("#pane-welcome .welcome-pane-trails a").click(function(){set_pane_back_button("#pane-trails","#pane-welcome"),doTrailSearch()}),$("#share_facebook").click(function(){var e=$("#share_url").val();return e="http://www.facebook.com/share.php?u="+encodeURIComponent(e),$("#share_facebook").prop("href",e),!0}),$("#share_twitter").click(function(){var e=$("#share_url").val();return e="http://twitter.com/home?status="+encodeURIComponent(e),$("#share_twitter").prop("href",e),!0})}),CM.display_attractions_results=function(e,t,a){$("#pane-browse-results h1.sidebar-header .title-text").text(e),sidebar.open("pane-browse-results");var n=$("ul#browse_results");n.empty();for(var i=0,r=t.length;i<r;i++){var o=t[i],l=$("<li></li>").addClass("zoom").attr("title",o.pagetitle).attr("gid",o.gis_id).attr("record_id",o.record_id).attr("type",a).attr("w",o.boxw).attr("s",o.boxs).attr("e",o.boxe).attr("n",o.boxn).attr("lat",o.latitude).attr("lng",o.longitude).attr("backbutton","#pane-browse-results");link=$("<a></a>"),link.attr("class","ui-btn ui-btn-text"),l.append(link),l.click(function(){zoomElementClick($(this))}),link.append($("<span></span>").addClass("ui-li-heading").text(o.pagetitle)),link.append($("<span></span>").addClass("zoom_distance").addClass("ui-li-count").addClass("ui-btn-up-c").addClass("ui-btn-corner-all").text("0 mi")),l.append(link),n.append(l)}n.listview("refresh"),sortLists(n)},set_pane_back_button=function(e,t){$(".sidebar-back",$(e)).prop("href",t)},$(document).bind("pagechange",function(e,t){}),$(document).ready(function(){$(function(){FastClick.FastClick.attach(document.getElementById("sidebar"))})}),$(document).on("mapInitialized",function(){ctrlGeolocate.on("geolocate",function(e){if(geolocateSuccess(e),updateNearYouNow(),$("#nearby_enabled").is(":checked")){var t=$("#nearby-radius").val(),a=[];$('input[name="nearby-category"]:checked').each(function(){a[a.length]=$(this).val()});var n=mapboxgl.LngLat.convert([e.coords.longitude,e.coords.latitude]);placeCircle(n,t),checkNearby(n,t,a)}update_user_latlon_display(e.latlng)}),NATIVE_APP||basicGeolocate()}),$(document).ready(function(){function e(e){$("#directions_via").val(e),$("#directions_via").trigger("change"),$("#directions_via").selectmenu("refresh"),sidebar.open("pane-getdirections")}$("#directions_hike").click(function(){e("hike")}),$("#directions_bike").click(function(){e("bike")}),$("#directions_bridle").click(function(){e("bridle")}),$("#directions_car").click(function(){e("car")}),$("#directions_bus").click(function(){e("bus")}),$("#directions_type").change(function(){var e=$(this).val(),t=$("#directions_type_geocode_wrap");"gps"==e?t.hide():t.show()}),$("#directions_reverse").change(function(){var t="to"==$(this).val()?"from":"to";$("#directions_type option").each(function(){var e=$(this).text();e=t+" "+e.replace(/^to /i,"").replace(/^from /i,""),$(this).text(e)}),$("#directions_type").selectmenu("refresh",!0)}),$("#directions_button").click(function(){$("#directions_steps").empty(),$(".directions_functions").remove(),processGetDirectionsForm()}),$("#directions_address").keydown(function(e){13==e.keyCode&&$("#directions_button").click()}),$(".change_directions_link").click(function(){sidebar.open("pane-browse"),SKIP_TO_DIRECTIONS=!0})}),$(document).ready(function(){$("#getdirections_clear").click(function(){clearDirectionsLine(),$("#directions_steps").empty()}),$("#directions_via").change(function(){switch($("#directions_via_bike_wrap").hide(),$(this).val()){case"bike":$("#directions_via_bike_wrap").show()}})}),$(document).ready(function(){hideShareURL(),$("#share_url").click(function(){$(this).select()}),$("#make_share_url_btn").click(function(){makeAndShowShortURL()})}),$(document).ready(function(){$(".copy-to-clipboard").click(function(){var e=$(this).attr("data-copy-id"),t=$(this).closest(".sidebar-pane")[0],a=$("#"+e);NATIVE_APP?cordova.plugins.clipboard.copy(a.val()):(a.focus(),a.select(),a[0].setSelectionRange(0,9999),document.execCommand("copy"));var n=createCopiedToClipboardTooltip(a[0],t);n.show(),$(document).on("click",function(e){$(e.target).closest(".copy-to-clipboard").length||n.hide()})})}),$(document).ready(function(){$("#browse_keyword_button").click(function(){sidebar.open("pane-search"),$("#search_keyword").val($("#browse_keyword").val()),$("#search_keyword_button").click()}),$("#browse_keyword").keydown(function(e){13==e.keyCode&&$("#browse_keyword_button").click()}),$("#search_keyword_button").click(function(){searchByKeyword($("#search_keyword").val())}),$("#search_keyword").keydown(function(e){13==e.keyCode&&$("#search_keyword_button").click()})}),$(document).on("dataReadyAutocompleteKeywords",function(){$.each(CM.autocomplete_keywords,function(e,t){var a="";a+='<li data-icon="arrow-r">',a+='<a href="#" data-transition="fade" class="ui-btn ui-btn-icon-right ui-icon-arrow-r">'+t+"</a>",a+="</li>",$("#browse_keyword_autocomplete").append(a),$("#search_keyword_autocomplete").append(a)}),$("#browse_keyword_autocomplete").listview("refresh").trigger("updatelayout"),$("#search_keyword_autocomplete").listview("refresh").trigger("updatelayout"),$("#browse_keyword_autocomplete li").click(function(){$("#browse_keyword").val("").trigger("change"),$("#browse_keyword").val($(this).text()),$("#browse_keyword_button").click()}),$("#search_keyword_autocomplete li").click(function(){$("#search_keyword").val("").trigger("change"),$("#search_keyword").val($(this).text()),$("#search_keyword_button").click()})}),$(document).on("dataReadyAttractions",function(){CM.attractions_nearby=CM.attractions.slice(0),updateNearYouNow()}),$(document).on("dataReadyAttractions",function(){addActivityTypesToNearby()}),$(document).ready(function(){$("#nearby_enabled").change(function(){var e=$(this).is(":checked");e?$("#nearby-config").show():$("#nearby-config").hide(),e||($("#alerts li").slice(0,25).show(),$("#alerts li").slice(25).hide(),clearCircle())})}),$(document).ready(function(){$("#loops_typeicons img").click(function(){var t=$(this),e=t.attr("data-value");$("#loops_filter_type").val(e).trigger("change"),$("#loops_typeicons img").each(function(){var e=$(this).prop("src");$(this).is(t)?e.includes("-on.svg")||(e=e.replace(".svg","-on.svg")):e=e.replace("-on.svg",".svg"),$(this).prop("src",e)})}).first().click(),$("#loops_filter_distancepicker a").click(function(){var e=$(this),t=e.attr("data-min"),a=e.attr("data-max");$("#loops_filter_distance_min").val(t),$("#loops_filter_distance_max").val(a),$("#loops_filter_distancepicker a").each(function(){$(this).is(e)?$(this).addClass("active"):$(this).removeClass("active")}),doTrailSearch()}),$("#loops_filter_reservation").change(function(){doTrailSearch()}),$("#loops_filter_distance_min").change(),$("#loops_filter_distance_max").change(),$("#loops_filter_type").change(function(){switch($(this).val()){case"hike":case"exercise":$(".time_estimate").hide(),$(".time_hike").show(),$(".time_estimate_prefix").hide();break;case"bridle":$(".time_estimate").hide(),$(".time_bridle").show(),$(".time_estimate_prefix").hide();break;case"bike":case"bike_Novice":case"bike_Beginner":case"bike_Intermediate":case"bike_Advanced":case"mountainbike":$(".time_estimate").hide(),$(".time_bike").show(),$(".time_estimate_prefix").hide();break;default:$(".time_estimate").show(),$(".time_estimate_prefix").show()}doTrailSearch()})}),this.CM=this.CM||{},this.CM.Templates=this.CM.Templates||{},this.CM.Templates.info_attraction=Handlebars.template({1:function(e,t,a,n,i){var r,o=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'    <h4>Activities:</h4>\n    <ul class="activities-icon-list">\n'+(null!=(r=o(a,"each").call(null!=t?t:e.nullContext||{},null!=t?o(t,"activity_icons"):t,{name:"each",hash:{},fn:e.program(2,i,0),inverse:e.noop,data:i,loc:{start:{line:6,column:8},end:{line:8,column:17}}}))?r:"")+"    </ul>\n"},2:function(e,t,a,n,i){var r=e.lambda,o=e.escapeExpression,l=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'            <li><img src="'+o(r(null!=t?l(t,"src"):t,t))+'" title="'+o(r(null!=t?l(t,"title"):t,t))+'" alt="'+o(r(null!=t?l(t,"title"):t,t))+'"></li>\n'},4:function(e,t,a,n,i){var r,o=e.lambda,l=e.escapeExpression,s=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'    <img src="'+l(o(null!=(r=null!=t?s(t,"img"):t)?s(r,"src"):r,t))+'" width="'+l(o(null!=(r=null!=t?s(t,"img"):t)?s(r,"width"):r,t))+'" height="'+l(o(null!=(r=null!=t?s(t,"img"):t)?s(r,"height"):r,t))+'" alt="'+l(o(null!=(r=null!=t?s(t,"feature"):t)?s(r,"pagetitle"):r,t))+'">\n'},6:function(e,t,a,n,i){var r,o=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'    <div class="feature-description">'+e.escapeExpression(e.lambda(null!=(r=null!=t?o(t,"feature"):t)?o(r,"descr"):r,t))+"</div>\n"},8:function(e,t,a,n,i){return'    <ul class="nobull">\n        <li><a href="" target="_blank">More Info</a></li>\n    </ul>\n'},compiler:[8,">= 4.3.0"],main:function(e,t,a,n,i){var r,o=e.lambda,l=e.escapeExpression,s=null!=t?t:e.nullContext||{},c=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return"<h2>"+l(o(null!=(r=null!=t?c(t,"feature"):t)?c(r,"pagetitle"):r,t))+"</h2>\n\n"+(null!=(r=c(a,"if").call(s,null!=(r=null!=t?c(t,"feature"):t)?c(r,"activities"):r,{name:"if",hash:{},fn:e.program(1,i,0),inverse:e.noop,data:i,loc:{start:{line:3,column:0},end:{line:10,column:7}}}))?r:"")+"\n"+(null!=(r=c(a,"if").call(s,null!=t?c(t,"img"):t,{name:"if",hash:{},fn:e.program(4,i,0),inverse:e.noop,data:i,loc:{start:{line:12,column:0},end:{line:14,column:7}}}))?r:"")+"\n"+(null!=(r=c(a,"if").call(s,null!=(r=null!=t?c(t,"feature"):t)?c(r,"descr"):r,{name:"if",hash:{},fn:e.program(6,i,0),inverse:e.noop,data:i,loc:{start:{line:16,column:0},end:{line:18,column:7}}}))?r:"")+"\n"+(null!=(r=c(a,"if").call(s,null!=(r=null!=t?c(t,"feature"):t)?c(r,"cmp_url"):r,{name:"if",hash:{},fn:e.program(8,i,0),inverse:e.noop,data:i,loc:{start:{line:20,column:0},end:{line:24,column:7}}}))?r:"")+'\n<h4>GPS coordinates:</h4>\n<div class="small-light">\n    '+l(o(null!=(r=null!=t?c(t,"feature"):t)?c(r,"latlng_userformatted"):r,t))+"\n</div>"},useData:!0}),this.CM.Templates.info_reservation=Handlebars.template({1:function(e,t,a,n,i){var r,o=e.lambda,l=e.escapeExpression,s=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'    <img src="'+l(o(null!=(r=null!=t?s(t,"img"):t)?s(r,"src"):r,t))+'" width="'+l(o(null!=(r=null!=t?s(t,"img"):t)?s(r,"width"):r,t))+'" height="'+l(o(null!=(r=null!=t?s(t,"img"):t)?s(r,"height"):r,t))+'" alt="'+l(o(null!=(r=null!=t?s(t,"feature"):t)?s(r,"pagetitle"):r,t))+'">\n'},3:function(e,t,a,n,i){var r,o=e.lambda,l=e.escapeExpression,s=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'\t<h4>Phone</h4>\n\t<a title="Call '+l(o(null!=(r=null!=t?s(t,"feature"):t)?s(r,"pagetitle"):r,t))+'" href="tel:'+l(o(null!=(r=null!=t?s(t,"feature"):t)?s(r,"phone"):r,t))+'">'+l(o(null!=(r=null!=t?s(t,"feature"):t)?s(r,"phone"):r,t))+"</a>\n"},compiler:[8,">= 4.3.0"],main:function(e,t,a,n,i){var r,o=e.lambda,l=e.escapeExpression,s=null!=t?t:e.nullContext||{},c=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return"<h2>"+l(o(null!=(r=null!=t?c(t,"feature"):t)?c(r,"pagetitle"):r,t))+"</h2>\n\n"+(null!=(r=c(a,"if").call(s,null!=t?c(t,"img"):t,{name:"if",hash:{},fn:e.program(1,i,0),inverse:e.noop,data:i,loc:{start:{line:3,column:0},end:{line:5,column:7}}}))?r:"")+"\n<p>"+l(o(null!=(r=null!=t?c(t,"feature"):t)?c(r,"descr"):r,t))+"</p>\n\n<h4>Hours of Operation</h4>\n"+l(o(null!=(r=null!=t?c(t,"feature"):t)?c(r,"hoursofoperation"):r,t))+"\n\n"+(null!=(r=c(a,"if").call(s,null!=(r=null!=t?c(t,"feature"):t)?c(r,"phone"):r,{name:"if",hash:{},fn:e.program(3,i,0),inverse:e.noop,data:i,loc:{start:{line:12,column:0},end:{line:15,column:7}}}))?r:"")+'\n<div class="lat_driving">'+l(o(null!=(r=null!=t?c(t,"feature"):t)?c(r,"drivingdestinationlatitude"):r,t))+'</div>\n<div class="lng_driving">'+l(o(null!=(r=null!=t?c(t,"feature"):t)?c(r,"drivingdestinationlongitude"):r,t))+"</div>"},useData:!0}),this.CM.Templates.info_trail=Handlebars.template({1:function(e,t,a,n,i){var r,o=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return"\tEst time, walking: "+e.escapeExpression(e.lambda(null!=(r=null!=t?o(t,"feature"):t)?o(r,"durationtext_hike"):r,t))+"<br/>\n"},3:function(e,t,a,n,i){var r,o=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return"\tEst time, bicycle: "+e.escapeExpression(e.lambda(null!=(r=null!=t?o(t,"feature"):t)?o(r,"durationtext_bike"):r,t))+"<br/>\n"},5:function(e,t,a,n,i){var r,o=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return"\tEst time, horseback: "+e.escapeExpression(e.lambda(null!=(r=null!=t?o(t,"feature"):t)?o(r,"durationtext_bridle"):r,t))+"<br/>\n"},7:function(e,t,a,n,i){var r,o=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'<div class="elevationprofileimage" style="text-align:center;">\n    <img src="'+e.escapeExpression("function"==typeof(r=null!=(r=o(a,"img_src")||(null!=t?o(t,"img_src"):t))?r:e.hooks.helperMissing)?r.call(null!=t?t:e.nullContext||{},{name:"img_src",hash:{},data:i,loc:{start:{line:20,column:14},end:{line:20,column:25}}}):r)+'" alt="Elevation profile">\n</div>\n'},compiler:[8,">= 4.3.0"],main:function(e,t,a,n,i){var r,o=e.lambda,l=e.escapeExpression,s=null!=t?t:e.nullContext||{},c=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return"<h2>"+l(o(null!=(r=null!=t?c(t,"feature"):t)?c(r,"title"):r,t))+"</h2>\n\n<p>\nLength: "+l(o(null!=(r=null!=t?c(t,"feature"):t)?c(r,"distancetext"):r,t))+"<br/>\n"+(null!=(r=c(a,"if").call(s,null!=(r=null!=t?c(t,"feature"):t)?c(r,"hike"):r,{name:"if",hash:{},fn:e.program(1,i,0),inverse:e.noop,data:i,loc:{start:{line:5,column:0},end:{line:7,column:7}}}))?r:"")+(null!=(r=c(a,"if").call(s,null!=(r=null!=t?c(t,"feature"):t)?c(r,"bike"):r,{name:"if",hash:{},fn:e.program(3,i,0),inverse:e.noop,data:i,loc:{start:{line:8,column:0},end:{line:10,column:7}}}))?r:"")+(null!=(r=c(a,"if").call(s,null!=(r=null!=t?c(t,"feature"):t)?c(r,"bridle"):r,{name:"if",hash:{},fn:e.program(5,i,0),inverse:e.noop,data:i,loc:{start:{line:11,column:0},end:{line:13,column:7}}}))?r:"")+"</p>\n\n"+(null!=(r=o(null!=(r=null!=t?c(t,"feature"):t)?c(r,"description"):r,t))?r:"")+"\n\n"+(null!=(r=c(a,"if").call(s,null!=t?c(t,"img_src"):t,{name:"if",hash:{},fn:e.program(7,i,0),inverse:e.noop,data:i,loc:{start:{line:18,column:0},end:{line:22,column:7}}}))?r:"")},useData:!0});
var WINDOW_URL=null,WINDOW_URL_QUERYSTRING=null,sidebar=null,LAST_BEEP_IDS=[],LAST_KNOWN_LOCATION=mapboxgl.LngLat.convert(START_CENTER),AUTO_CENTER_ON_LOCATION=!1,DEFAULT_SORT="distance";function createStartHereTooltip(){var t=$(".sidebar-tabs ul li:first")[0],e=$("body > div.ui-page")[0];return new Tooltip(t,{title:"Start exploring here!",container:e,placement:"right",trigger:"manual"})}function switchToMap(){sidebarCoversMap()&&sidebar.close()}function loadMapAndStartingState(){var t=new URLSearchParams(location.search),e=t.get("lat")||t.get("y"),a=t.get("lng")||t.get("x"),n=t.get("zoom")||t.get("z");if(mapOptions={base:t.get("base"),lat:e,lng:a,zoom:n,drop_marker:!1},initMap(mapOptions),t.get("type")&&t.get("gid")){var i=t.get("type");switch(i){case"attraction":$(document).on("dataReadyAttractions",(function(){var e=t.get("gid"),a={};if((attraction=CM.get_attraction(e))&&(a.gid=attraction.gis_id,a.title=attraction.pagetitle,a.lat=attraction.latitude,a.lng=attraction.longitude),!a.lat||!a.lng)return alert("Cound not find that feature.");zoomToFeature(a),showFeatureInfo(i,a)}));break;case"reservation_new":$(document).on("dataReadyReservations",(function(){var e=t.get("gid"),a={type:"reservation_new"};if((reservation=CM.get_reservation(e))&&(a.gid=reservation.record_id,a.w=reservation.boxw,a.n=reservation.boxn,a.e=reservation.boxe,a.s=reservation.boxs,a.lat=reservation.latitude,a.lng=reservation.longitude),!(a.w&&a.n&&a.e&&a.s||a.lat&&a.lng))return alert("Cound not find that reservation.");zoomToFeature(a),showFeatureInfo(i,a)}));break;case"loop":$(document).on("dataReadyTrails",(function(){var e={type:"loop",gid:t.get("gid")};showFeatureInfo(i,e)}))}}if("directions"==t.get("action")){var o=t.get("via"),r=t.get("sourceText");r&&$("#source-input").val(r);var s=t.get("sourceLatLng").split(",")[0],c=t.get("sourceLatLng").split(",")[1];$("#source-input").data("lat",s),$("#source-input").data("lng",c);var d=t.get("targetText");d&&$("#target-input").val(d);var l=t.get("targetLatLng").split(",")[0],g=t.get("targetLatLng").split(",")[1];$("#target-input").data("lat",l),$("#target-input").data("lng",g),sidebar.open("pane-directions"),getDirections(s,c,l,g,o)}var u=t.get("base")||"map",p=$('input[name="basemap"][value="photo"]'),m=$('input[name="basemap"][value="map"]');switch(u){case"photo":p.prop("checked",!0).checkboxradio("refresh"),m.prop("checked",!1).checkboxradio("refresh");break;case"map":default:p.prop("checked",!1).checkboxradio("refresh"),m.prop("checked",!0).checkboxradio("refresh")}$.event.trigger({type:"mapReady"})}function make_image_from_pagethumbnail(t,e){t=t.replace("~/","https://www.clevelandmetroparks.com/");var a=new URL(t),n=a.searchParams.get("width"),i=a.searchParams.get("height"),o=a.searchParams;return new_height=parseInt(i/(n/e)),o.set("width",2*e),o.set("height",2*new_height),{src:a.protocol+"//"+a.hostname+a.pathname+"?"+o.toString(),width:e,height:new_height}}function make_activity_icons_list(t){var e=[];return t.forEach((function(t){CM.activities[t]?e.push({src:CM.activities[t].icon,title:CM.activities[t].pagetitle,alt:CM.activities[t].pagetitle}):console.log("ERROR in make_activity_icons_list(): Activity "+t+" does not exist.")})),e}function showFeatureInfoContent(t,e){switch(t){case"attraction":var a=CM.get_attraction(e),n=CM.Templates.info_attraction,i=[];a.activities&&(i=make_activity_icons_list(a.activities));var o=[];a.pagethumbnail&&(o=make_image_from_pagethumbnail(a.pagethumbnail,320));var r={feature:a,activity_icons:i,img:o};$("#info-content").html(n(r));break;case"reservation_new":var s=CM.get_reservation(e);n=CM.Templates.info_reservation;s.pagethumbnail&&(o=make_image_from_pagethumbnail(s.pagethumbnail,320));r={feature:s,img:o};$("#info-content").html(n(r));break;case"loop":if(e in CM.trails){$.get(API_NEW_BASE_URL+"trail_geometries/"+e,null,(function(t){t.data.geom_geojson&&drawHighlightLine(JSON.parse(t.data.geom_geojson))}));var c=CM.trails[e];n=CM.Templates.info_trail,r={feature:c,img_src:"static/images/loops/"+c.id+".jpg"};$("#info-content").html(n(r))}else console.log("ERROR: loop id: "+e+" does not exist in CM.trails (app_view_trails).")}}function showElevation(t){$("#elevation").prop("src",t),sidebar.open("pane-elevationprofile")}function zoomElementClick(t){var e=getFeatureFromElement(t);showFeatureInfo(e.type,e),showOnMap(e)}function setUpDirectionsTarget(t){$("#directions_target_lat").val(t.lat),$("#directions_target_lng").val(t.lng),$("#directions_target_type").val(t.type),$("#directions_target_gid").val(t.gid),$("#directions_target_title").text(t.title)}function showFeatureInfo(t,e){$("#show_on_map").data("zoomelement",e),$("#show_on_map").data("wkt",null),setUpDirectionsTarget(e),sidebar.open("pane-info"),e.back_url||(e.back_url="#pane-browse"),set_pane_back_button("#pane-info",e.back_url),$("#info-content").text("Loading...");var a=e.gid||e.record_id;a&&showFeatureInfoContent(t,a)}function getFeatureFromElement(t){var e={};return e.title=t.attr("title"),e.w=t.attr("w"),e.s=t.attr("s"),e.e=t.attr("e"),e.n=t.attr("n"),e.lat=t.attr("lat"),e.lng=t.attr("lng"),e.type=t.attr("type"),"reservation_new"==e.type&&t.attr("record_id")?e.gid=t.attr("record_id"):e.gid=t.attr("gid"),e.back_url=t.attr("backbutton"),e}function getListDistances(t){(t||(t=$(".sidebar-pane.active ul.distance_sortable").eq(0)).length)&&t.find(".zoom_distance").each((function(){var t=$(this).parent().parent(),e=new mapboxgl.LngLat(t.attr("lng"),t.attr("lat")),a=distanceTo(LAST_KNOWN_LOCATION,e),n=bearingToInNESW(LAST_KNOWN_LOCATION,e),i=3.2808399*a,o=i>900?(a/1609.344).toFixed(1)+" mi":i.toFixed(0)+" ft";o+=" "+n,$(this).text(o),t.data("meters",a)}))}function sortLists(t){if(t||(t=$(".sidebar-pane.active ul.distance_sortable").eq(0)).length){switch(getListDistances(t),DEFAULT_SORT){case"distance":t.children("li").sort((function(t,e){return $(t).data("meters")>$(e).data("meters")?1:-1}));break;case"alphabetical":t.children("li").sort((function(t,e){return $(t).attr("title")>$(e).attr("title")?1:-1}))}t.children("li.ui-first-child").removeClass("ui-first-child"),t.children("li").first().addClass("ui-first-child"),t.children("li.ui-last-child").removeClass("ui-last-child"),t.children("li").last().addClass("ui-last-child")}}function showWkt(t){drawHighlightLine(new Wkt.Wkt(t).toJson())}function drawHighlightLine(t){clearHighlightLine(),MAP.addLayer({id:"highlightLine",type:"line",source:{type:"geojson",data:t},layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#01B3FD","line-width":6,"line-opacity":.75}})}function clearHighlightLine(){MAP.getLayer("highlightLine")&&MAP.removeLayer("highlightLine"),MAP.getSource("highlightLine")&&MAP.removeSource("highlightLine")}function zoomToAddress(t){if(!t)return!1;$.get(API_NEW_BASE_URL+"geocode/"+t,null,(function(t){if(!t.data)return alert("We couldn't find that address or city.\nPlease try again.");var e=new mapboxgl.LngLat(t.data.lng,t.data.lat);if(!MAX_BOUNDS.contains(e))return alert("The only results we could find are too far away to zoom the map there.");switchToMap(),placeMarker(MARKER_TARGET,t.data.lat,t.data.lng),MAP.flyTo({center:e,zoom:DEFAULT_POI_ZOOM});var a='<h3 class="popup_title">'+t.data.title+"</h3>";a+='<span class="fakelink zoom" title="'+t.data.title+'" lat="'+t.data.lat+'" lng="'+t.data.lng+'" w="'+t.data.w+'" s="'+t.data.s+'" e="'+t.data.e+'" n="'+t.data.n+'" onClick="zoomElementClick($(this));">Directions</span>';(new mapboxgl.Popup).setLngLat(e).setHTML(a).addTo(MAP)}),"json")}function showOnMap(t,e){if(t.type&&t.gid&&0!=t.gid){var a={type:t.type,gid:t.gid};setWindowURLQueryStringParameters(a,!1,!0)}zoomToFeature(t,e)}function zoomToFeature(t,e){if(clearMarker(MARKER_TARGET),clearHighlightLine(),e&&switchToMap(),t.w&&t.s&&t.e&&t.n&&0!=t.w&&0!=t.s&&0!=t.e&&0!=t.n){var a=new mapboxgl.LngLat(t.w,t.s),n=new mapboxgl.LngLat(t.e,t.n),i=new mapboxgl.LngLatBounds(a,n);MAP.fitBounds(i,{padding:10})}else t.lng&&t.lat&&MAP.flyTo({center:[t.lng,t.lat],zoom:DEFAULT_POI_ZOOM});"poi"!=t.type&&"attraction"!=t.type&&"loop"!=t.type||placeMarker(MARKER_TARGET,t.lat,t.lng),t.wkt&&showWkt(t.wkt)}function setupWindowURLUpdates(){MAP.on("zoomend",updateWindowURLZoom),MAP.on("moveend",updateWindowURLCenter),MAP.on("layerremove",updateWindowURLLayer),MAP.on("layeradd",updateWindowURLLayer)}function updateWindowURLCenter(){var t=MAP.getCenter(),e=t.lat.toFixed(7),a=t.lng.toFixed(7);invalidateWindowURL(),params={lat:e,lng:a},setWindowURLQueryStringParameters(params,!1,!1)}function updateWindowURLZoom(){var t=MAP.getZoom().toFixed(1);invalidateWindowURL(),setWindowURLQueryStringParameters({zoom:t},!1)}function updateWindowURLLayer(){var t="map";"photo"==getBasemap()&&(t="photo"),invalidateWindowURL(),setWindowURLQueryStringParameters({base:t},!1)}function invalidateWindowURL(){hideShareURL()}function changeCoordinateFormat(t){SETTINGS.coordinate_format=t,localStorage.setItem("coordinateFormat",t)}function getSessionCoordinateFormat(){var t=localStorage.getItem("coordinateFormat");"dms"!=t&&"ddm"!=t&&"dd"!=t||(SETTINGS.coordinate_format=t,$("#coordinate_format input[name=coordinate_format]").prop("checked",!1).checkboxradio("refresh"),$("#coordinate_format input[name=coordinate_format][value="+t+"]").prop("checked",!0).checkboxradio("refresh"),update_user_latlon_display())}$(document).on("mapInitialized",(function(){if(sidebar||(sidebar=$("#sidebar").sidebar()),"/"!=window.location.pathname&&!window.location.pathname.endsWith("index.html")||""!=window.location.search||sidebarCoversMap()){var t=createStartHereTooltip();setTimeout(t.show,2500),setTimeout(t.dispose,15e3),$(document).click((function(){t.hide()}))}else sidebar.open("pane-welcome")})),$(document).ready((function(){loadMapAndStartingState()})),window.onpopstate=function(){loadMapAndStartingState()},$(document).ready((function(){$('input[type="radio"][name="basemap"]').change((function(){var t=$(this).val();changeBasemap(t)}))})),$(document).ready((function(){$("div.sortpicker span").click((function(){DEFAULT_SORT=$(this).attr("value"),sortLists()}))})),$(document).ready((function(){$(".zoom").click((function(){zoomElementClick($(this))}))})),$(document).ready((function(){$("#geocode_button").click((function(){zoomToAddress($("#geocode_text").val())})),$("#geocode_text").keydown((function(t){13==t.keyCode&&$("#geocode_button").click()}))})),$(document).ready((function(){$("#show_on_map").click((function(){var t=$(this).data("zoomelement");t&&(t.wkt=$(this).data("wkt"),showOnMap(t,!0))}))})),$(document).on("mapReady",setupWindowURLUpdates),$(document).ready((function(){$('input[type="radio"][name="coordinate_format"]').change((function(){changeCoordinateFormat($(this).val()),update_user_latlon_display()}))})),$(document).ready((function(){getSessionCoordinateFormat()})),$(document).on("mapReady",(function(){MAP.on("mousemove",(function(t){var e=MAP.queryRenderedFeatures(t.point);document.getElementById("debug-features").innerHTML=JSON.stringify(e,null,2)}))}));
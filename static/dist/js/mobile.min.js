var WINDOW_URL=null,WINDOW_URL_QUERYSTRING=null,sidebar=null,LAST_BEEP_IDS=[],LAST_KNOWN_LOCATION=new mapboxgl.LngLat.convert(START_CENTER),AUTO_CENTER_ON_LOCATION=!1,DEFAULT_SORT="distance";function createStartHereTooltip(){var e=$(".sidebar-tabs ul li:first")[0],t=$("body > div.ui-page")[0];return new Tooltip(e,{title:"Start exploring here!",container:t,placement:"right",trigger:"manual"})}function switchToMap(){sidebarCoversMap()&&sidebar.close()}function loadMapAndStartingState(){var e=new URLSearchParams(location.search),t=e.get("lat")||e.get("y"),o=e.get("lng")||e.get("x"),a=e.get("zoom")||e.get("z");if(mapOptions={base:e.get("base"),lat:t,lng:o,zoom:a,drop_marker:!1},initMap(mapOptions),e.get("type")&&e.get("name")){var n={type:e.get("type"),name:e.get("name")};$.get(API_BASEPATH+"ajax/exactnamesearch",n,function(e){if(!(e&&e.s&&e.w&&e.n&&e.e))return alert("Cound not find that feature.");MAP.fitBounds([[e.w,e.s],[e.e,e.n]]),e.lat&&e.lng?placeMarker(MARKER_TARGET,e.lat,e.lng):e.wkt&&showWkt(e.wkt)},"json")}if(e.get("type")&&e.get("gid"))switch(e.get("type")){case"attraction":n={gid:e.get("gid")};$.get(API_BASEPATH+"ajax/get_attraction",n,function(e){if(!e||!e.lat||!e.lng)return alert("Cound not find that feature.");var t=e;t.type="attraction",zoomToFeature(t),showFeatureInfo(t)},"json");break;case"reservation_new":n={gid:e.get("gid")};$.get(API_BASEPATH+"ajax/get_reservation",n,function(e){if(!e||!e.lat||!e.lng)return alert("Cound not find that reservation.");var t=e;t.gid=e.record_id,t.w=e.boxw,t.n=e.boxn,t.e=e.boxe,t.s=e.boxs,t.type="reservation_new",zoomToFeature(t),showFeatureInfo(t)},"json");break;case"loop":showFeatureInfo({type:"loop",gid:e.get("gid")},!0)}if(e.get("routefrom")&&e.get("routeto")&&e.get("routevia")){var i=e.get("routefrom").split(",")[0],r=e.get("routefrom").split(",")[1],s=e.get("routeto").split(",")[0],d=e.get("routeto").split(",")[1],c=e.get("routevia");sidebar.open("pane-getdirections"),$("#getdirections_disabled").hide(),$("#getdirections_enabled").show(),$("#directions_target_title").text(e.get("routetitle")),$("#directions_via").val(e.get("routevia")),$("#directions_via").selectmenu("refresh"),$("#directions_type").val("geocode"),$("#directions_type").selectmenu("refresh"),$("#directions_type_geocode_wrap").show(),$("#directions_address").val(e.get("routefrom")),$("#directions_target_lat").val(s),$("#directions_target_lng").val(d),$("#directions_via").trigger("change"),$("#directions_address").val(e.get("fromaddr")),$("#directions_reverse").val(e.get("whichway")),$("#directions_via_bike").val(e.get("routevia_bike")),setTimeout(function(){$("#directions_reverse").trigger("change")},1e3),$("#directions_type").val(e.get("loctype")),getDirections(i,r,s,d,"to",c)}var l=e.get("base")||"map",g=$('input[name="basemap"][value="photo"]'),u=$('input[name="basemap"][value="map"]');switch(l){case"photo":g.prop("checked",!0).checkboxradio("refresh"),u.prop("checked",!1).checkboxradio("refresh");break;case"map":default:g.prop("checked",!1).checkboxradio("refresh"),u.prop("checked",!0).checkboxradio("refresh")}$.event.trigger({type:"mapReady"})}function showElevation(e){$("#elevation").prop("src",e),sidebar.open("pane-elevationprofile")}function showFeatureInfo(e,a){if(prepareInfoPaneForFeature(e),e.type&&e.gid){var t={type:e.type,gid:e.gid||e.record_id};$.get(API_BASEPATH+"ajax/moreinfo",t,function(e){if(SKIP_TO_DIRECTIONS)return $("#directions_car").click(),void(SKIP_TO_DIRECTIONS=!1);$("#info-content").html(e),a&&zoomToFeature(e);var t=$("#info-content").find("div.wkt");if(t){var o=t.text();o&&(showWkt(o),$("#show_on_map").data("wkt",o),t.remove())}},"html")}else $("#info-content").html($("<h1></h1>").text(e.title)),$("#directions_car").click()}function zoomElementClick(e){var t=getFeatureFromElement(e);prepareInfoPaneForFeature(t),showFeatureInfo(t),showOnMap(t)}function prepareInfoPaneForFeature(e){$("#show_on_map").data("zoomelement",e),$("#show_on_map").data("wkt",null),$("#directions_target_lat").val(e.lat),$("#directions_target_lng").val(e.lng),$("#directions_target_type").val(e.type),$("#directions_target_gid").val(e.gid),$("#directions_target_title").text(e.title),sidebar.open("pane-info"),e.back_url||(e.back_url="#pane-browse"),set_pane_back_button("#pane-info",e.back_url),$("#getdirections_disabled").hide(),$("#getdirections_enabled").show(),$("#info-content").text("Loading...")}function getFeatureFromElement(e){var t={};return t.title=e.attr("title"),t.w=e.attr("w"),t.s=e.attr("s"),t.e=e.attr("e"),t.n=e.attr("n"),t.lat=e.attr("lat"),t.lng=e.attr("lng"),t.type=e.attr("type"),"reservation_new"==t.type?t.gid=e.attr("record_id"):t.gid=e.attr("gid"),t.back_url=e.attr("backbutton"),t}function sortLists(e){if(e||(e=$(".sidebar-pane.active ul.distance_sortable").eq(0)).length){switch(e.find(".zoom_distance").each(function(){var e=$(this).parent().parent(),t=new mapboxgl.LngLat(e.attr("lng"),e.attr("lat")),o=distanceTo(LAST_KNOWN_LOCATION,t),a=bearingToInNESW(LAST_KNOWN_LOCATION,t),n=3.2808399*o,i=900<n?(o/1609.344).toFixed(1)+" mi":n.toFixed(0)+" ft";i+=" "+a,$(this).text(i),e.data("meters",o)}),DEFAULT_SORT){case"distance":e.children("li").sort(function(e,t){return $(e).data("meters")>$(t).data("meters")?1:-1});break;case"alphabetical":e.children("li").sort(function(e,t){return $(e).attr("title")>$(t).attr("title")?1:-1})}e.children("li.ui-first-child").removeClass("ui-first-child"),e.children("li").first().addClass("ui-first-child"),e.children("li.ui-last-child").removeClass("ui-last-child"),e.children("li").last().addClass("ui-last-child")}}function showWkt(e){drawHighlightLine(new Wkt.Wkt(e).toJson())}function drawHighlightLine(e){clearHighlightLine(),MAP.addLayer({id:"highlightLine",type:"line",source:{type:"geojson",data:e},layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#01B3FD","line-width":6,"line-opacity":.75}})}function clearHighlightLine(){MAP.getLayer("highlightLine")&&MAP.removeLayer("highlightLine"),MAP.getSource("highlightLine")&&MAP.removeSource("highlightLine")}function zoomToAddress(e){if(!e)return!1;var t={};t.address=e,t.bing_key=BING_API_KEY,t.bbox=GEOCODE_BIAS_BOX,$.get(API_BASEPATH+"ajax/geocode",t,function(e){if(!e)return alert("We couldn't find that address or city.\nPlease try again.");var t=new mapboxgl.LngLat(e.lng,e.lat);if(!MAX_BOUNDS.contains(t))return alert("The only results we could find are too far away to zoom the map there.");switchToMap(),placeMarker(MARKER_TARGET,e.lat,e.lng),MAP.flyTo({center:t,zoom:DEFAULT_POI_ZOOM});var o='<h3 class="popup_title">'+e.title+"</h3>";o+='<span class="fakelink zoom" title="'+e.title+'" lat="'+e.lat+'" lng="'+e.lng+'" w="'+e.w+'" s="'+e.s+'" e="'+e.e+'" n="'+e.n+'" onClick="zoomElementClick($(this));">Directions</span>';(new mapboxgl.Popup).setLngLat(t).setHTML(o).addTo(MAP)},"json")}function showOnMap(e,t){if(e.type&&e.gid&&0!=e.gid){var o={type:e.type,gid:e.gid};setWindowURLQueryStringParameters(o,!1,!0)}zoomToFeature(e,t)}function zoomToFeature(e,t){if(clearMarker(MARKER_TARGET),clearHighlightLine(),t&&switchToMap(),e.w&&e.s&&e.e&&e.n&&0!=e.w&&0!=e.s&&0!=e.e&&0!=e.n){var o=new mapboxgl.LngLat(e.w,e.s),a=new mapboxgl.LngLat(e.e,e.n),n=new mapboxgl.LngLatBounds(o,a);MAP.fitBounds(n,{padding:10})}else e.lng&&e.lat&&MAP.flyTo({center:[e.lng,e.lat],zoom:DEFAULT_POI_ZOOM});"poi"!=e.type&&"attraction"!=e.type&&"loop"!=e.type||placeMarker(MARKER_TARGET,e.lat,e.lng),e.wkt&&showWkt(e.wkt)}function setupWindowURLUpdates(){MAP.on("zoomend",updateWindowURLZoom),MAP.on("moveend",updateWindowURLCenter),MAP.on("layerremove",updateWindowURLLayer),MAP.on("layeradd",updateWindowURLLayer)}function updateWindowURLCenter(){var e=MAP.getCenter(),t=e.lat.toFixed(7),o=e.lng.toFixed(7);invalidateWindowURL(),params={lat:t,lng:o},setWindowURLQueryStringParameters(params,!1,!1)}function updateWindowURLZoom(){var e=MAP.getZoom().toFixed(1);invalidateWindowURL(),setWindowURLQueryStringParameters({zoom:e},!1)}function updateWindowURLLayer(){var e="map";"photo"==getBasemap()&&(e="photo"),invalidateWindowURL(),setWindowURLQueryStringParameters({base:e},!1)}function invalidateWindowURL(){hideShareURL()}function changeCoordinateFormat(e){setSessionCoordinateFormat(SETTINGS.coordinate_format=e)}function getSessionCoordinateFormat(){$.get(API_BASEPATH+"ajax/get_session_coordinate_format",{},function(e){return e?(SETTINGS.coordinate_format=e,update_user_latlon_display(),e):void console.log("Error: get_session_coordinate_format: Could not get coordinate format.")},"json")}function setSessionCoordinateFormat(e){var t={coordinate_format:e};$.get(API_BASEPATH+"ajax/set_session_coordinate_format",t,function(e){e||console.log("Error: set_session_coordinate_format: No reply.")},"json")}function wmsGetFeatureInfoByPoint(e,t){var o=MAP.unproject([e.x-20,e.y+20]),a=MAP.unproject([e.x+20,e.y-20]);wmsGetFeatureInfoByBbox(new mapboxgl.LngLatBounds(o,a),t)}function wmsGetFeatureInfoByBbox(e,t){var o={w:e.getWest(),s:e.getSouth(),e:e.getEast(),n:e.getNorth(),zoom:MAP.getZoom()};$.get(API_BASEPATH+"ajax/query",o,function(e){if(e)(new mapboxgl.Popup).setLngLat(t).setHTML(e).addTo(MAP)},"html")}$(document).on("mapInitialized",function(){if(sidebar=sidebar||$("#sidebar").sidebar(),"/"!=window.location.pathname&&!window.location.pathname.endsWith("index.html")||""!=window.location.search||sidebarCoversMap()){var e=createStartHereTooltip();setTimeout(e.show,2500),setTimeout(e.dispose,15e3),$(document).click(function(){e.hide()})}else sidebar.open("pane-welcome")}),$(document).ready(function(){loadMapAndStartingState()}),window.onpopstate=function(){loadMapAndStartingState()},$(document).ready(function(){$('input[type="radio"][name="basemap"]').change(function(){var e=$(this).val();changeBasemap(e)})}),$(document).ready(function(){$("div.sortpicker span").click(function(){DEFAULT_SORT=$(this).attr("value"),sortLists()})}),$(document).ready(function(){$(".zoom").click(function(){zoomElementClick($(this))})}),$(document).ready(function(){$("#geocode_button").click(function(){zoomToAddress($("#geocode_text").val())}),$("#geocode_text").keydown(function(e){13==e.keyCode&&$("#geocode_button").click()})}),$(document).ready(function(){$("#show_on_map").click(function(){var e=$(this).data("zoomelement");e&&(e.wkt=$(this).data("wkt"),showOnMap(e,!0))})}),$(document).on("mapReady",setupWindowURLUpdates),$(document).ready(function(){$('input[type="radio"][name="coordinate_format"]').change(function(){changeCoordinateFormat($(this).val()),update_user_latlon_display()})}),$(document).ready(function(){getSessionCoordinateFormat()}),$(document).on("mapReady",function(){MAP.on("click",function(e){if($(".leaflet-popup").length)return MAP.closePopup();wmsGetFeatureInfoByPoint(e.point,e.lngLat)})});
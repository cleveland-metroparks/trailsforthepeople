var WINDOW_URL=null,WINDOW_URL_QUERYSTRING=null,sidebar=null,LAST_BEEP_IDS=[],LAST_KNOWN_LOCATION=new mapboxgl.LngLat.convert(START_CENTER),AUTO_CENTER_ON_LOCATION=!1,DEFAULT_SORT="distance";function createStartHereTooltip(){var t=$(".sidebar-tabs ul li:first")[0],e=$("body > div.ui-page")[0];return new Tooltip(t,{title:"Start exploring here!",container:e,placement:"right",trigger:"manual"})}function switchToMap(){sidebarCoversMap()&&sidebar.close()}function showElevation(t){$("#elevation").prop("src",t),sidebar.open("pane-elevationprofile")}function showAttractionInfo(t,e){$("#directions_target_lat").val(e.lat),$("#directions_target_lng").val(e.lng),$("#directions_target_type").val(e.type),$("#directions_target_gid").val(e.gid),$("#directions_target_title").text(e.title),sidebar.open("pane-info"),set_pane_back_button("#pane-info","#pane-browse"),$("#getdirections_disabled").hide(),$("#getdirections_enabled").show(),$("#show_on_map").data("wkt",null),$("#info-content").text("Loading...");var a=e.gid||e.record_id;a&&showAttractionInfoContent(t,a)}function make_image_from_pagethumbnail(t,e){t=t.replace("~/","https://www.clevelandmetroparks.com/");var a=new URL(t),o=a.searchParams.get("width"),i=a.searchParams.get("height"),n=a.searchParams;return new_height=parseInt(i/(o/e)),n.set("width",2*e),n.set("height",2*new_height),{src:a.protocol+"//"+a.hostname+a.pathname+"?"+n.toString(),width:e,height:new_height}}function make_activity_icons_list(t){var e=[];return t.forEach(function(t){e.push({src:CM.activities[t].icon,title:CM.activities[t].pagetitle,alt:CM.activities[t].pagetitle})}),e}function showAttractionInfoContent(t,e){switch(t){case"attraction":var a=CM.get_attraction(e),o=CM.Templates.info_attraction,i=make_activity_icons_list(a.activities),n=[];a.pagethumbnail&&(n=make_image_from_pagethumbnail(a.pagethumbnail,320));var r={feature:a,activity_icons:i,img:n};$("#info-content").html(o(r));break;case"reservation_new":var s=CM.get_reservation(e);o=CM.Templates.info_reservation;s.pagethumbnail&&(n=make_image_from_pagethumbnail(s.pagethumbnail,320));r={feature:s,img:n};$("#info-content").html(o(r));break;case"loop":if(e in CM.trails){var d=CM.trails[e];o=CM.Templates.info_trail,r={feature:d,img_src:"static/images/loops/"+d.id+".jpg"};$("#info-content").html(o(r))}else console.log("ERROR: loop id: "+e+" does not exist in CM.trails (app_view_trails).")}}function zoomElementClick(t){var e=t.attr("type"),a=t.attr("gid");"reservation_new"==e&&(a=t.attr("record_id")),$("#show_on_map").data("zoomelement",t),$("#directions_target_lat").val(t.attr("lat")),$("#directions_target_lng").val(t.attr("lng")),$("#directions_target_type").val(t.attr("type")),$("#directions_target_gid").val(t.attr("gid")),$("#directions_target_title").text(t.attr("title")),sidebar.open("pane-info");var o=t.attr("backbutton");if(o=o||"#pane-browse",set_pane_back_button("#pane-info",o),$("#getdirections_disabled").hide(),$("#getdirections_enabled").show(),$("#show_on_map").data("wkt",null),$("#info-content").text("Loading..."),e&&a){showAttractionInfoContent(e,a);var i=$("#info-content").find("div.wkt");i&&($("#show_on_map").data("wkt",i.text()),i.remove()),SKIP_TO_DIRECTIONS&&($("#directions_car").click(),SKIP_TO_DIRECTIONS=!1)}else $("#info-content").html($("<h1></h1>").text(t.attr("title"))),$("#directions_car").click()}function sortLists(t){if(t||(t=$(".sidebar-pane.active ul.distance_sortable").eq(0)).length){switch(t.find(".zoom_distance").each(function(){var t=$(this).parent().parent(),e=new mapboxgl.LngLat(t.attr("lng"),t.attr("lat")),a=distanceTo(LAST_KNOWN_LOCATION,e),o=bearingToInNESW(LAST_KNOWN_LOCATION,e),i=3.2808399*a,n=900<i?(a/1609.344).toFixed(1)+" mi":i.toFixed(0)+" ft";n+=" "+o,$(this).text(n),t.data("meters",a)}),DEFAULT_SORT){case"distance":t.children("li").sort(function(t,e){return $(t).data("meters")>$(e).data("meters")?1:-1});break;case"alphabetical":t.children("li").sort(function(t,e){return $(t).attr("title")>$(e).attr("title")?1:-1})}t.children("li.ui-first-child").removeClass("ui-first-child"),t.children("li").first().addClass("ui-first-child"),t.children("li.ui-last-child").removeClass("ui-last-child"),t.children("li").last().addClass("ui-last-child")}}function drawHighlightLine(t){clearHighlightLine(),MAP.addLayer({id:"highlightLine",type:"line",source:{type:"geojson",data:t},layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#01B3FD","line-width":6,"line-opacity":.75}})}function clearHighlightLine(){MAP.getLayer("highlightLine")&&MAP.removeLayer("highlightLine"),MAP.getSource("highlightLine")&&MAP.removeSource("highlightLine")}function zoomToAddress(t){if(!t)return!1;$.get(API_NEW_BASE_URL+"geocode/"+t,null,function(t){if(!t.data)return alert("We couldn't find that address or city.\nPlease try again.");var e=new mapboxgl.LngLat(t.data.lng,t.data.lat);if(!MAX_BOUNDS.contains(e))return alert("The only results we could find are too far away to zoom the map there.");switchToMap(),placeMarker(MARKER_TARGET,t.data.lat,t.data.lng),MAP.flyTo({center:e,zoom:DEFAULT_POI_ZOOM});var a='<h3 class="popup_title">'+t.data.title+"</h3>";a+='<span class="fakelink zoom" title="'+t.data.title+'" lat="'+t.data.lat+'" lng="'+t.data.lng+'" w="'+t.data.w+'" s="'+t.data.s+'" e="'+t.data.e+'" n="'+t.data.n+'" onClick="zoomElementClick( $(this) );">Directions</span>';(new mapboxgl.Popup).setLngLat(e).setHTML(a).addTo(MAP)},"json")}function showOnMap(){var t=$(this).data("zoomelement"),e={};t&&(e.w=t.attr("w"),e.s=t.attr("s"),e.e=t.attr("e"),e.n=t.attr("n"),e.lng=t.attr("lng"),e.lat=t.attr("lat"),e.type=t.attr("type"),e.wkt=$(this).data("wkt"),e.gid=t.attr("gid"),"reservation_new"==e.type&&(e.gid=t.attr("record_id")),zoomToFeature(e))}function zoomToFeature(t){if(t.type&&setWindowURLQueryStringParameter("type",t.type),t.gid&&0!=t.gid&&setWindowURLQueryStringParameter("gid",t.gid),clearMarker(MARKER_TARGET),clearHighlightLine(),switchToMap(),t.w&&t.s&&t.e&&t.n&&0!=t.w&&0!=t.s&&0!=t.e&&0!=t.n){var e=new mapboxgl.LngLat(t.w,t.s),a=new mapboxgl.LngLat(t.e,t.n),o=new mapboxgl.LngLatBounds(e,a);MAP.fitBounds(o,{padding:10})}else t.lng&&t.lat&&MAP.flyTo({center:[t.lng,t.lat],zoom:DEFAULT_POI_ZOOM});"poi"!=t.type&&"attraction"!=t.type&&"loop"!=t.type||placeMarker(MARKER_TARGET,t.lat,t.lng),t.wkt&&(wkt=new Wkt.Wkt(t.wkt),drawHighlightLine(wkt.toJson()))}function setupWindowURLUpdates(){MAP.on("zoomend",updateWindowURLZoom),MAP.on("moveend",updateWindowURLCenter),MAP.on("layerremove",updateWindowURLLayer),MAP.on("layeradd",updateWindowURLLayer)}function updateWindowURLCenter(){var t=MAP.getCenter(),e=t.lat.toFixed(7),a=t.lng.toFixed(7);invalidateWindowURL(),setWindowURLQueryStringParameter("lat",e),setWindowURLQueryStringParameter("lng",a)}function updateWindowURLZoom(){var t=MAP.getZoom().toFixed(1);invalidateWindowURL(),setWindowURLQueryStringParameter("zoom",t)}function updateWindowURLLayer(){var t="map";"photo"==getBasemap()&&(t="photo"),invalidateWindowURL(),setWindowURLQueryStringParameter("base",t)}function invalidateWindowURL(){hideShareURL()}function updateWindowURLAll(){updateWindowURLCenter(),updateWindowURLZoom(),updateWindowURLLayer()}function changeCoordinateFormat(t){setSessionCoordinateFormat(SETTINGS.coordinate_format=t)}function getSessionCoordinateFormat(){$.get(API_BASEPATH+"ajax/get_session_coordinate_format",{},function(t){return t?(SETTINGS.coordinate_format=t,update_user_latlon_display(),t):void console.log("Error: get_session_coordinate_format: Could not get coordinate format.")},"json")}function setSessionCoordinateFormat(t){var e={coordinate_format:t};$.get(API_BASEPATH+"ajax/set_session_coordinate_format",e,function(t){t||console.log("Error: set_session_coordinate_format: No reply.")},"json")}function wmsGetFeatureInfoByPoint(t,e){var a=MAP.unproject([t.x-20,t.y+20]),o=MAP.unproject([t.x+20,t.y-20]);wmsGetFeatureInfoByBbox(new mapboxgl.LngLatBounds(a,o),e)}function wmsGetFeatureInfoByBbox(t,e){var a={w:t.getWest(),s:t.getSouth(),e:t.getEast(),n:t.getNorth(),zoom:MAP.getZoom()};$.get(API_BASEPATH+"ajax/query",a,function(t){if(t)(new mapboxgl.Popup).setLngLat(e).setHTML(t).addTo(MAP)},"html")}$(document).on("mapInitialized",function(){if(sidebar=$("#sidebar").sidebar(),"/"!=window.location.pathname&&!window.location.pathname.endsWith("index.html")||""!=window.location.search||sidebarCoversMap()){var t=createStartHereTooltip();setTimeout(t.show,2500),setTimeout(t.dispose,15e3),$(document).click(function(){t.hide()})}else sidebar.open("pane-welcome")}),$(document).on("mapInitialized",function(){$(window).bind("orientationchange pageshow resize",function(){MAP.resize()})}),$(document).ready(function(){var a=new URLSearchParams(location.search),t=a.get("lat")||a.get("y"),e=a.get("lng")||a.get("x"),o=a.get("zoom")||a.get("z");if(mapOptions={base:a.get("base"),lat:t,lng:e,zoom:o,drop_marker:!1},initMap(mapOptions),a.get("type")&&a.get("gid")&&("attraction"==a.get("type")?$(document).on("dataReadyAttractions",function(){var t=a.get("gid"),e={};if((attraction=CM.get_attraction(t))&&(e.gid=attraction.gis_id,e.title=attraction.pagetitle,e.lat=attraction.latitude,e.lng=attraction.longitude),!e.lat||!e.lng)return alert("Cound not find that feature.");zoomToFeature(e),showAttractionInfo(a.get("type"),e)}):"reservation_new"==a.get("type")&&$(document).on("dataReadyReservations",function(){var t=a.get("gid"),e={};if((reservation=CM.get_reservation(t))&&(e.gid=reservation.record_id,e.w=reservation.boxw,e.n=reservation.boxn,e.e=reservation.boxe,e.s=reservation.boxs,e.lat=reservation.latitude,e.lng=reservation.longitude),!(e.w&&e.n&&e.e&&e.s||e.lat&&e.lng))return alert("Cound not find that reservation.");zoomToFeature(e),showAttractionInfo(a.get("type"),e)})),a.get("routefrom")&&a.get("routeto")&&a.get("routevia")){var i=a.get("routefrom").split(",")[0],n=a.get("routefrom").split(",")[1],r=a.get("routeto").split(",")[0],s=a.get("routeto").split(",")[1],d=a.get("routevia");sidebar.open("pane-getdirections"),$("#getdirections_disabled").hide(),$("#getdirections_enabled").show(),$("#directions_target_title").text(a.get("routetitle")),$("#directions_via").val(a.get("routevia")),$("#directions_via").selectmenu("refresh"),$("#directions_type").val("geocode"),$("#directions_type").selectmenu("refresh"),$("#directions_type_geocode_wrap").show(),$("#directions_address").val(a.get("routefrom")),$("#directions_target_lat").val(r),$("#directions_target_lng").val(s),$("#directions_via").trigger("change"),$("#directions_address").val(a.get("fromaddr")),$("#directions_reverse").val(a.get("whichway")),$("#directions_via_bike").val(a.get("routevia_bike")),setTimeout(function(){$("#directions_reverse").trigger("change")},1e3),$("#directions_type").val(a.get("loctype")),getDirections(i,n,r,s,"to",d)}var c=a.get("base")||"map",l=$('input[name="basemap"][value="photo"]'),g=$('input[name="basemap"][value="map"]');switch(c){case"photo":l.prop("checked",!0).checkboxradio("refresh"),g.prop("checked",!1).checkboxradio("refresh");break;case"map":default:l.prop("checked",!1).checkboxradio("refresh"),g.prop("checked",!0).checkboxradio("refresh")}$.event.trigger({type:"mapReady"})}),$(document).ready(function(){$('input[type="radio"][name="basemap"]').change(function(){var t=$(this).val();changeBasemap(t)})}),$(document).ready(function(){$("div.sortpicker span").click(function(){DEFAULT_SORT=$(this).attr("value"),sortLists()})}),$(document).ready(function(){$(".zoom").click(function(){zoomElementClick($(this))})}),$(document).ready(function(){$("#geocode_button").click(function(){zoomToAddress($("#geocode_text").val())}),$("#geocode_text").keydown(function(t){13==t.keyCode&&$("#geocode_button").click()})}),$(document).ready(function(){$("#show_on_map").click(showOnMap)}),$(document).on("mapReady",setupWindowURLUpdates),$(document).ready(function(){$('input[type="radio"][name="coordinate_format"]').change(function(){changeCoordinateFormat($(this).val()),update_user_latlon_display()})}),$(document).ready(function(){getSessionCoordinateFormat()}),$(document).on("mapReady",function(){MAP.on("click",function(t){if($(".leaflet-popup").length)return MAP.closePopup();wmsGetFeatureInfoByPoint(t.point,t.lngLat)})});
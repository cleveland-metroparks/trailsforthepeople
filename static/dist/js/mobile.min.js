var WINDOW_URL=null,sidebar=null,LAST_BEEP_IDS=[],LAST_KNOWN_LOCATION=L.latLng(41.3953,-81.673),AUTO_CENTER_ON_LOCATION=!1,DEFAULT_SORT="distance",URL_PARAMS=null;function createStartHereTooltip(){var t=$(".sidebar-tabs ul li:first")[0],e=$("body > div.ui-page")[0];return new Tooltip(t,{title:"Start exploring here!",container:e,placement:"right",trigger:"manual"})}function disableClicksMomentarily(){}function disableClicks(){MAP&&(ENABLE_MAPCLICK=!1,MAP.dragging.removeHooks(),MAP.touchZoom.removeHooks())}function enableClicks(){MAP&&(ENABLE_MAPCLICK=!0,MAP.dragging.addHooks(),MAP.touchZoom.addHooks())}function switchToMap(t){sidebarCoversMap()&&sidebar.close(),t&&setTimeout(t,0)}function showPhoto(t){$("#photo").prop("src",t),sidebar.open("pane-photo")}function showElevation(t){$("#elevation").prop("src",t),sidebar.open("pane-elevationprofile")}function showAttractionInfo(t,e){if($("#directions_target_lat").val(e.lat),$("#directions_target_lng").val(e.lng),$("#directions_target_type").val(e.type),$("#directions_target_gid").val(e.gid),$("#directions_target_title").text(e.title),sidebar.open("pane-info"),set_pane_back_button("#pane-info","#pane-browse"),$("#getdirections_disabled").hide(),$("#getdirections_enabled").show(),$("#show_on_map").data("wkt",null),$("#info-content").text("Loading..."),e.gid||e.record_id){var a={};a.type=t,a.gid=e.gid||e.record_id,$.get(API_BASEPATH+"ajax/moreinfo",a,function(t){$("#info-content").html(t)},"html")}}function zoomElementClick(t){if(ENABLE_MAPCLICK){disableClicksMomentarily();var e=t.attr("type"),a=t.attr("gid");"reservation_new"==e&&(a=t.attr("record_id")),$("#show_on_map").data("zoomelement",t),$("#directions_target_lat").val(t.attr("lat")),$("#directions_target_lng").val(t.attr("lng")),$("#directions_target_type").val(t.attr("type")),$("#directions_target_gid").val(t.attr("gid")),$("#directions_target_title").text(t.attr("title")),sidebar.open("pane-info");var o=t.attr("backbutton");if(o=o||"#pane-browse",set_pane_back_button("#pane-info",o),$("#getdirections_disabled").hide(),$("#getdirections_enabled").show(),$("#show_on_map").data("wkt",null),$("#info-content").text("Loading..."),e&&a){var n={};n.type=e,n.gid=a,n.lat=LAST_KNOWN_LOCATION.lat,n.lng=LAST_KNOWN_LOCATION.lng,$.get(API_BASEPATH+"ajax/moreinfo",n,function(t){$("#info-content").html(t);var e=$("#info-content").find("div.wkt");e&&($("#show_on_map").data("wkt",e.text()),e.remove()),SKIP_TO_DIRECTIONS&&($("#directions_car").click(),SKIP_TO_DIRECTIONS=!1)},"html")}else $("#info-content").html($("<h1></h1>").text(t.attr("title"))),$("#directions_car").click()}}function sortLists(t){if(t||(t=$(".sidebar-pane.active ul.distance_sortable").eq(0)).length){switch(t.find(".zoom_distance").each(function(){var t=$(this).parent().parent(),e=L.latLng(t.attr("lat"),t.attr("lng")),a=LAST_KNOWN_LOCATION.distanceTo(e),o=LAST_KNOWN_LOCATION.bearingWordTo(e),n=3.2808399*a,i=900<n?(a/1609.344).toFixed(1)+" mi":n.toFixed(0)+" ft";i+=" "+o,$(this).text(i),t.data("meters",a)}),DEFAULT_SORT){case"distance":t.children("li").sort(function(t,e){return $(t).data("meters")>$(e).data("meters")?1:-1});break;case"alphabetical":t.children("li").sort(function(t,e){return $(t).attr("title")>$(e).attr("title")?1:-1})}t.children("li.ui-first-child").removeClass("ui-first-child"),t.children("li").first().addClass("ui-first-child"),t.children("li.ui-last-child").removeClass("ui-last-child"),t.children("li").last().addClass("ui-last-child")}}function zoomToAddress(t){if(!t)return!1;var e={};e.address=t,e.bing_key=BING_API_KEY,e.bbox=GEOCODE_BIAS_BOX,$.get(API_BASEPATH+"ajax/geocode",e,function(a){if(!a)return alert("We couldn't find that address or city.\nPlease try again.");var o=L.latLng(a.lat,a.lng);if(!MAX_BOUNDS.contains(o))return alert("The only results we could find are too far away to zoom the map there.");switchToMap(function(){MAP.setView(o,16),placeTargetMarker(a.lat,a.lng);var t="";t+='<h3 class="popup_title">'+a.title+"</h3>",t+='<span class="fakelink zoom" title="'+a.title+'" lat="'+a.lat+'" lng="'+a.lng+'" w="'+a.w+'" s="'+a.s+'" e="'+a.e+'" n="'+a.n+'" onClick="zoomElementClick( $(this) );">Directions</span>';var e=new L.Popup;e.setLatLng(o),e.setContent(t),MAP.openPopup(e)})},"json")}function showOnMap(){var t=$(this).data("zoomelement"),e={};t&&(e.w=t.attr("w"),e.s=t.attr("s"),e.e=t.attr("e"),e.n=t.attr("n"),e.lng=t.attr("lng"),e.lat=t.attr("lat"),e.type=t.attr("type"),e.wkt=$(this).data("wkt"),e.gid=t.attr("gid"),"reservation_new"==e.type&&(e.gid=t.attr("record_id")),zoomToFeature(e))}function zoomToFeature(e){e.type&&setWindowURLQueryStringParameter("type",e.type),e.gid&&0!=e.gid&&setWindowURLQueryStringParameter("gid",e.gid),clearTargetMarker(),MAP.hasLayer(HIGHLIGHT_LINE)&&MAP.removeLayer(HIGHLIGHT_LINE),switchToMap(function(){if(null==e.zoomlevel||isNaN(e.zoomlevel))if(0!=e.w&&0!=e.s&&0!=e.e&&0!=e.n){var t=L.latLngBounds(L.latLng(e.s,e.w),L.latLng(e.n,e.e)).pad(.15);MAP.flyToBounds(t)}else MAP.flyTo(L.latLng(e.lat,e.lng),DEFAULT_POI_ZOOM);else MAP.flyTo(L.latLng(e.lat,e.lng),parseFloat(e.zoomlevel));"poi"!=e.type&&"attraction"!=e.type&&"loop"!=e.type||placeTargetMarker(e.lat,e.lng),e.wkt&&(HIGHLIGHT_LINE=lineWKTtoFeature(e.wkt,HIGHLIGHT_LINE_STYLE),MAP.addLayer(HIGHLIGHT_LINE))})}function createCopiedToClipboardTooltip(t,e){return new Tooltip(t,{title:"Copied to clipboard.",container:e,placement:"bottom",trigger:"manual"})}function setupWindowUrlUpdates(){MAP.on("zoomend",updateWindowURLZoom),MAP.on("moveend",updateWindowURLCenter),MAP.on("layerremove",updateWindowURLLayer),MAP.on("layeradd",updateWindowURLLayer)}function updateWindowURLCenter(){var t=MAP.getCenter(),e=t.lat.toFixed(7),a=t.lng.toFixed(7);invalidateMapURL(),setWindowURLQueryStringParameter("lat",e),setWindowURLQueryStringParameter("lng",a)}function updateWindowURLZoom(){var t=Number.parseFloat(MAP.getZoom()).toFixed(2);invalidateMapURL(),setWindowURLQueryStringParameter("zoom",t)}function updateWindowURLLayer(){var t="map";MAP.hasLayer(AVAILABLE_LAYERS.photo)&&(t="photo"),invalidateMapURL(),setWindowURLQueryStringParameter("base",t)}function invalidateMapURL(){hideShareURL()}function updateWindowURLAll(){updateWindowURLCenter(),updateWindowURLZoom(),updateWindowURLLayer()}function setWindowURLQueryStringParameter(t,e){var a=new URLSearchParams(location.search);a.set(t,e),a.has("y")&&"lat"==t&&a.delete("y"),a.has("x")&&"lng"==t&&a.delete("x"),a.has("z")&&"zoom"==t&&a.delete("z"),WINDOW_URL=decodeURIComponent(location.pathname+"?"+a),window.history.replaceState(null,null,WINDOW_URL)}function WSENtoBounds(t,e,a,o){return L.latLngBounds([[e,t],[o,a]])}function changeCoordinateFormat(t){setSessionCoordinateFormat(SETTINGS.coordinate_format=t)}function getSessionCoordinateFormat(){$.get(API_BASEPATH+"ajax/get_session_coordinate_format",{},function(t){return t?(SETTINGS.coordinate_format=t,update_user_latlon_display(),t):void console.log("Error: get_session_coordinate_format: Could not get coordinate format.")},"json")}function setSessionCoordinateFormat(t){var e={coordinate_format:t};$.get(API_BASEPATH+"ajax/set_session_coordinate_format",e,function(t){t||console.log("Error: set_session_coordinate_format: No reply.")},"json")}function wmsGetFeatureInfoByPoint(t){var e=MAP.layerPointToLatLng(new L.Point(t.x-20,t.y+20)),a=MAP.layerPointToLatLng(new L.Point(t.x+20,t.y-20));wmsGetFeatureInfoByLatLngBBOX({w:e.lng,s:e.lat,e:a.lng,n:a.lat},MAP.layerPointToLatLng(new L.Point(t.x,t.y)))}function wmsGetFeatureInfoByLatLng(t){wmsGetFeatureInfoByLatLngBBOX({w:t.lng,s:t.lat,e:t.lng,n:t.lat},t)}function wmsGetFeatureInfoByLatLngBBOX(t,o){var e=t;e.zoom=MAP.getZoom(),$.get(API_BASEPATH+"ajax/query",e,function(t){if(t){var e={};e.maxHeight=parseInt($("#map_canvas").height()),e.maxWidth=parseInt($("#map_canvas").width());var a=new L.Popup(e);a.setLatLng(o),a.setContent(t),MAP.openPopup(a)}},"html")}$(document).on("mapInitialized",function(){if(sidebar=L.control.sidebar("sidebar").addTo(MAP),"/"!=window.location.pathname&&!window.location.pathname.endsWith("index.html")||""!=window.location.search||sidebarCoversMap()){var t=createStartHereTooltip();setTimeout(t.show,2500),setTimeout(t.dispose,15e3),$(document).click(function(){t.hide()})}else sidebar.open("pane-welcome")}),$(document).on("mapInitialized",function(){$(window).bind("orientationchange pageshow resize",function(){MAP.invalidateSize()})}),$(document).ready(function(){var t=(URL_PARAMS=$.url()).param("lat")||URL_PARAMS.param("y"),e=URL_PARAMS.param("lng")||URL_PARAMS.param("x"),a=URL_PARAMS.param("zoom")||URL_PARAMS.param("z");if(mapOptions={base:URL_PARAMS.param("base"),lat:t,lng:e,zoom:a,drop_marker:!1},initMap(mapOptions),URL_PARAMS.param("type")&&URL_PARAMS.param("name")){var o={type:URL_PARAMS.param("type"),name:URL_PARAMS.param("name")};$.get(API_BASEPATH+"ajax/exactnamesearch",o,function(t){if(!(t&&t.s&&t.w&&t.n&&t.e))return alert("Cound not find that feature.");var e=L.latLngBounds(L.latLng(t.s,t.w),L.latLng(t.n,t.e));MAP.fitBounds(e),t.lat&&t.lng?placeTargetMarker(t.lat,t.lng):t.wkt&&(HIGHLIGHT_LINE=lineWKTtoFeature(t.wkt,HIGHLIGHT_LINE_STYLE),MAP.addLayer(HIGHLIGHT_LINE))},"json")}if(URL_PARAMS.param("type")&&URL_PARAMS.param("gid"))if("attraction"==URL_PARAMS.param("type")){o={gid:URL_PARAMS.param("gid")};$.get(API_BASEPATH+"ajax/get_attraction",o,function(t){if(!t||!t.lat||!t.lng)return alert("Cound not find that feature.");zoomToFeature(t),showAttractionInfo(URL_PARAMS.param("type"),t)},"json")}else if("reservation_new"==URL_PARAMS.param("type")){o={gid:URL_PARAMS.param("gid")};$.get(API_BASEPATH+"ajax/get_reservation",o,function(t){if(!t||!t.lat||!t.lng)return alert("Cound not find that reservation.");feature=t,feature.gid=t.record_id,feature.w=t.boxw,feature.n=t.boxn,feature.e=t.boxe,feature.s=t.boxs,feature.zoomlevel=t.zoomlevel,zoomToFeature(feature),showAttractionInfo(URL_PARAMS.param("type"),t)},"json")}if(URL_PARAMS.param("routefrom")&&URL_PARAMS.param("routeto")&&URL_PARAMS.param("routevia")){var n=URL_PARAMS.param("routefrom").split(",")[0],i=URL_PARAMS.param("routefrom").split(",")[1],r=URL_PARAMS.param("routeto").split(",")[0],d=URL_PARAMS.param("routeto").split(",")[1],l=URL_PARAMS.param("routevia");sidebar.open("pane-getdirections"),$("#getdirections_disabled").hide(),$("#getdirections_enabled").show(),$("#directions_target_title").text(URL_PARAMS.param("routetitle")),$("#directions_via").val(URL_PARAMS.param("routevia")),$("#directions_via").selectmenu("refresh"),$("#directions_type").val("geocode"),$("#directions_type").selectmenu("refresh"),$("#directions_type_geocode_wrap").show(),$("#directions_address").val(URL_PARAMS.param("routefrom")),$("#directions_target_lat").val(r),$("#directions_target_lng").val(d),$("#directions_via").trigger("change"),$("#directions_address").val(URL_PARAMS.param("fromaddr")),$("#directions_reverse").val(URL_PARAMS.param("whichway")),$("#directions_via_bike").val(URL_PARAMS.param("routevia_bike")),setTimeout(function(){$("#directions_reverse").trigger("change")},1e3),$("#directions_type").val(URL_PARAMS.param("loctype")),getDirections(n,i,r,d,"to",l)}var s=URL_PARAMS.param("base")||"map",c=$('input[name="basemap"][value="photo"]'),p=$('input[name="basemap"][value="map"]');switch(s){case"photo":c.prop("checked",!0).checkboxradio("refresh"),p.prop("checked",!1).checkboxradio("refresh");break;case"map":default:c.prop("checked",!1).checkboxradio("refresh"),p.prop("checked",!0).checkboxradio("refresh")}$.event.trigger({type:"mapReady"})}),$(document).ready(function(){$('input[type="radio"][name="basemap"]').change(function(){var t=$(this).val();changeBasemap(t)})}),$(document).ready(function(){$("div.sortpicker span").click(function(){DEFAULT_SORT=$(this).attr("value"),sortLists()})}),$(document).ready(function(){$(".zoom").click(function(){zoomElementClick($(this))})}),$(document).ready(function(){$("#geocode_button").click(function(){zoomToAddress($("#geocode_text").val())}),$("#geocode_text").keydown(function(t){13==t.keyCode&&$("#geocode_button").click()})}),$(document).ready(function(){$("#show_on_map").click(showOnMap)}),$(document).ready(function(){$(".copy-to-clipboard").click(function(){var t=$(this).attr("data-copy-id"),e=$(this).closest(".sidebar-pane")[0],a=$("#"+t),o=createCopiedToClipboardTooltip(a[0],e);o.show(),$(document).on("click",function(t){$(t.target).closest(".copy-to-clipboard").length||o.hide()}),a.focus(),a.select(),a[0].setSelectionRange(0,9999),document.execCommand("copy")})}),$(document).on("mapReady",setupWindowUrlUpdates),$(document).ready(function(){$('input[type="radio"][name="coordinate_format"]').change(function(){changeCoordinateFormat($(this).val()),update_user_latlon_display()})}),$(document).ready(function(){getSessionCoordinateFormat()}),$(document).on("mapReady",function(){MAP.on("click",function(t){if(ENABLE_MAPCLICK)return $(".leaflet-popup").length?MAP.closePopup():void wmsGetFeatureInfoByPoint(t.layerPoint)})});
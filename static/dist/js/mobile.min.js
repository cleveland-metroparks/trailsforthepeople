var WINDOW_URL=null,WINDOW_URL_QUERYSTRING=null,sidebar=null,LAST_BEEP_IDS=[],LAST_KNOWN_LOCATION=new mapboxgl.LngLat.convert(START_CENTER),AUTO_CENTER_ON_LOCATION=!1,DEFAULT_SORT="distance";function createStartHereTooltip(){var t=$(".sidebar-tabs ul li:first")[0],e=$("body > div.ui-page")[0];return new Tooltip(t,{title:"Start exploring here!",container:e,placement:"right",trigger:"manual"})}function switchToMap(){sidebarCoversMap()&&sidebar.close()}function loadMapAndStartingState(){var e=new URLSearchParams(location.search),t=e.get("lat")||e.get("y"),o=e.get("lng")||e.get("x"),n=e.get("zoom")||e.get("z");if(mapOptions={base:e.get("base"),lat:t,lng:o,zoom:n,drop_marker:!1},initMap(mapOptions),e.get("type")&&e.get("name")){var a={type:e.get("type"),name:e.get("name")};$.get(API_BASEPATH+"ajax/exactnamesearch",a,function(t){if(!(t&&t.s&&t.w&&t.n&&t.e))return alert("Cound not find that feature.");MAP.fitBounds([[t.w,t.s],[t.e,t.n]]),t.lat&&t.lng?placeMarker(MARKER_TARGET,t.lat,t.lng):t.wkt&&(wkt=new Wkt.Wkt(t.wkt),drawHighlightLine(wkt.toJson()))},"json")}if(e.get("type")&&e.get("gid"))if("attraction"==e.get("type")){a={gid:e.get("gid")};$.get(API_BASEPATH+"ajax/get_attraction",a,function(t){if(!t||!t.lat||!t.lng)return alert("Cound not find that feature.");zoomToFeature(t),showAttractionInfo(e.get("type"),t)},"json")}else if("reservation_new"==e.get("type")){a={gid:e.get("gid")};$.get(API_BASEPATH+"ajax/get_reservation",a,function(t){if(!t||!t.lat||!t.lng)return alert("Cound not find that reservation.");feature=t,feature.gid=t.record_id,feature.w=t.boxw,feature.n=t.boxn,feature.e=t.boxe,feature.s=t.boxs,zoomToFeature(feature),showAttractionInfo(e.get("type"),t)},"json")}if(e.get("routefrom")&&e.get("routeto")&&e.get("routevia")){var i=e.get("routefrom").split(",")[0],r=e.get("routefrom").split(",")[1],d=e.get("routeto").split(",")[0],s=e.get("routeto").split(",")[1],l=e.get("routevia");sidebar.open("pane-getdirections"),$("#getdirections_disabled").hide(),$("#getdirections_enabled").show(),$("#directions_target_title").text(e.get("routetitle")),$("#directions_via").val(e.get("routevia")),$("#directions_via").selectmenu("refresh"),$("#directions_type").val("geocode"),$("#directions_type").selectmenu("refresh"),$("#directions_type_geocode_wrap").show(),$("#directions_address").val(e.get("routefrom")),$("#directions_target_lat").val(d),$("#directions_target_lng").val(s),$("#directions_via").trigger("change"),$("#directions_address").val(e.get("fromaddr")),$("#directions_reverse").val(e.get("whichway")),$("#directions_via_bike").val(e.get("routevia_bike")),setTimeout(function(){$("#directions_reverse").trigger("change")},1e3),$("#directions_type").val(e.get("loctype")),getDirections(i,r,d,s,"to",l)}var c=e.get("base")||"map",g=$('input[name="basemap"][value="photo"]'),u=$('input[name="basemap"][value="map"]');switch(c){case"photo":g.prop("checked",!0).checkboxradio("refresh"),u.prop("checked",!1).checkboxradio("refresh");break;case"map":default:g.prop("checked",!1).checkboxradio("refresh"),u.prop("checked",!0).checkboxradio("refresh")}$.event.trigger({type:"mapReady"})}function showElevation(t){$("#elevation").prop("src",t),sidebar.open("pane-elevationprofile")}function showAttractionInfo(t,e){if($("#directions_target_lat").val(e.lat),$("#directions_target_lng").val(e.lng),$("#directions_target_type").val(e.type),$("#directions_target_gid").val(e.gid),$("#directions_target_title").text(e.title),sidebar.open("pane-info"),set_pane_back_button("#pane-info","#pane-browse"),$("#getdirections_disabled").hide(),$("#getdirections_enabled").show(),$("#show_on_map").data("wkt",null),$("#info-content").text("Loading..."),e.gid||e.record_id){var o={};o.type=t,o.gid=e.gid||e.record_id,$.get(API_BASEPATH+"ajax/moreinfo",o,function(t){$("#info-content").html(t)},"html")}}function zoomElementClick(t){var e=t.attr("type"),o=t.attr("gid");"reservation_new"==e&&(o=t.attr("record_id")),$("#show_on_map").data("zoomelement",t),$("#directions_target_lat").val(t.attr("lat")),$("#directions_target_lng").val(t.attr("lng")),$("#directions_target_type").val(t.attr("type")),$("#directions_target_gid").val(t.attr("gid")),$("#directions_target_title").text(t.attr("title")),sidebar.open("pane-info");var n=t.attr("backbutton");if(n=n||"#pane-browse",set_pane_back_button("#pane-info",n),$("#getdirections_disabled").hide(),$("#getdirections_enabled").show(),$("#show_on_map").data("wkt",null),$("#info-content").text("Loading..."),e&&o){var a={};a.type=e,a.gid=o,a.lat=LAST_KNOWN_LOCATION.lat,a.lng=LAST_KNOWN_LOCATION.lng,$.get(API_BASEPATH+"ajax/moreinfo",a,function(t){$("#info-content").html(t);var e=$("#info-content").find("div.wkt");e&&($("#show_on_map").data("wkt",e.text()),e.remove()),SKIP_TO_DIRECTIONS&&($("#directions_car").click(),SKIP_TO_DIRECTIONS=!1)},"html")}else $("#info-content").html($("<h1></h1>").text(t.attr("title"))),$("#directions_car").click()}function sortLists(t){if(t||(t=$(".sidebar-pane.active ul.distance_sortable").eq(0)).length){switch(t.find(".zoom_distance").each(function(){var t=$(this).parent().parent(),e=new mapboxgl.LngLat(t.attr("lng"),t.attr("lat")),o=distanceTo(LAST_KNOWN_LOCATION,e),n=bearingToInNESW(LAST_KNOWN_LOCATION,e),a=3.2808399*o,i=900<a?(o/1609.344).toFixed(1)+" mi":a.toFixed(0)+" ft";i+=" "+n,$(this).text(i),t.data("meters",o)}),DEFAULT_SORT){case"distance":t.children("li").sort(function(t,e){return $(t).data("meters")>$(e).data("meters")?1:-1});break;case"alphabetical":t.children("li").sort(function(t,e){return $(t).attr("title")>$(e).attr("title")?1:-1})}t.children("li.ui-first-child").removeClass("ui-first-child"),t.children("li").first().addClass("ui-first-child"),t.children("li.ui-last-child").removeClass("ui-last-child"),t.children("li").last().addClass("ui-last-child")}}function drawHighlightLine(t){clearHighlightLine(),MAP.addLayer({id:"highlightLine",type:"line",source:{type:"geojson",data:t},layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#01B3FD","line-width":6,"line-opacity":.75}})}function clearHighlightLine(){MAP.getLayer("highlightLine")&&MAP.removeLayer("highlightLine"),MAP.getSource("highlightLine")&&MAP.removeSource("highlightLine")}function zoomToAddress(t){if(!t)return!1;var e={};e.address=t,e.bing_key=BING_API_KEY,e.bbox=GEOCODE_BIAS_BOX,$.get(API_BASEPATH+"ajax/geocode",e,function(t){if(!t)return alert("We couldn't find that address or city.\nPlease try again.");var e=new mapboxgl.LngLat(t.lng,t.lat);if(!MAX_BOUNDS.contains(e))return alert("The only results we could find are too far away to zoom the map there.");switchToMap(),placeMarker(MARKER_TARGET,t.lat,t.lng),MAP.flyTo({center:e,zoom:DEFAULT_POI_ZOOM});var o='<h3 class="popup_title">'+t.title+"</h3>";o+='<span class="fakelink zoom" title="'+t.title+'" lat="'+t.lat+'" lng="'+t.lng+'" w="'+t.w+'" s="'+t.s+'" e="'+t.e+'" n="'+t.n+'" onClick="zoomElementClick( $(this) );">Directions</span>';(new mapboxgl.Popup).setLngLat(e).setHTML(o).addTo(MAP)},"json")}function showOnMap(){var t=$(this).data("zoomelement"),e={};if(t){e.w=t.attr("w"),e.s=t.attr("s"),e.e=t.attr("e"),e.n=t.attr("n"),e.lng=t.attr("lng"),e.lat=t.attr("lat"),e.type=t.attr("type"),e.wkt=$(this).data("wkt"),e.gid=t.attr("gid"),"reservation_new"==e.type&&(e.gid=t.attr("record_id"));var o={};e.type&&(o.type=e.type),e.gid&&0!=e.gid&&(o.gid=e.gid),setWindowURLQueryStringParameters(o,!1,!0),zoomToFeature(e)}}function zoomToFeature(t){if(clearMarker(MARKER_TARGET),clearHighlightLine(),switchToMap(),t.w&&t.s&&t.e&&t.n&&0!=t.w&&0!=t.s&&0!=t.e&&0!=t.n){var e=new mapboxgl.LngLat(t.w,t.s),o=new mapboxgl.LngLat(t.e,t.n),n=new mapboxgl.LngLatBounds(e,o);MAP.fitBounds(n,{padding:10})}else t.lng&&t.lat&&MAP.flyTo({center:[t.lng,t.lat],zoom:DEFAULT_POI_ZOOM});"poi"!=t.type&&"attraction"!=t.type&&"loop"!=t.type||placeMarker(MARKER_TARGET,t.lat,t.lng),t.wkt&&(wkt=new Wkt.Wkt(t.wkt),drawHighlightLine(wkt.toJson()))}function setupWindowURLUpdates(){MAP.on("zoomend",updateWindowURLZoom),MAP.on("moveend",updateWindowURLCenter),MAP.on("layerremove",updateWindowURLLayer),MAP.on("layeradd",updateWindowURLLayer)}function updateWindowURLCenter(){var t=MAP.getCenter(),e=t.lat.toFixed(7),o=t.lng.toFixed(7);invalidateWindowURL(),params={lat:e,lng:o},setWindowURLQueryStringParameters(params,!1,!1)}function updateWindowURLZoom(){var t=MAP.getZoom().toFixed(1);invalidateWindowURL(),setWindowURLQueryStringParameters({zoom:t},!1)}function updateWindowURLLayer(){var t="map";"photo"==getBasemap()&&(t="photo"),invalidateWindowURL(),setWindowURLQueryStringParameters({base:t},!1)}function invalidateWindowURL(){hideShareURL()}function changeCoordinateFormat(t){setSessionCoordinateFormat(SETTINGS.coordinate_format=t)}function getSessionCoordinateFormat(){$.get(API_BASEPATH+"ajax/get_session_coordinate_format",{},function(t){return t?(SETTINGS.coordinate_format=t,update_user_latlon_display(),t):void console.log("Error: get_session_coordinate_format: Could not get coordinate format.")},"json")}function setSessionCoordinateFormat(t){var e={coordinate_format:t};$.get(API_BASEPATH+"ajax/set_session_coordinate_format",e,function(t){t||console.log("Error: set_session_coordinate_format: No reply.")},"json")}function wmsGetFeatureInfoByPoint(t,e){var o=MAP.unproject([t.x-20,t.y+20]),n=MAP.unproject([t.x+20,t.y-20]);wmsGetFeatureInfoByBbox(new mapboxgl.LngLatBounds(o,n),e)}function wmsGetFeatureInfoByBbox(t,e){var o={w:t.getWest(),s:t.getSouth(),e:t.getEast(),n:t.getNorth(),zoom:MAP.getZoom()};$.get(API_BASEPATH+"ajax/query",o,function(t){if(t)(new mapboxgl.Popup).setLngLat(e).setHTML(t).addTo(MAP)},"html")}$(document).on("mapInitialized",function(){if(sidebar=sidebar||$("#sidebar").sidebar(),"/"!=window.location.pathname&&!window.location.pathname.endsWith("index.html")||""!=window.location.search||sidebarCoversMap()){var t=createStartHereTooltip();setTimeout(t.show,2500),setTimeout(t.dispose,15e3),$(document).click(function(){t.hide()})}else sidebar.open("pane-welcome")}),$(document).on("mapInitialized",function(){$(window).bind("orientationchange pageshow resize",function(){MAP.resize()})}),$(document).ready(function(){loadMapAndStartingState()}),window.onpopstate=function(){loadMapAndStartingState()},$(document).ready(function(){$('input[type="radio"][name="basemap"]').change(function(){var t=$(this).val();changeBasemap(t)})}),$(document).ready(function(){$("div.sortpicker span").click(function(){DEFAULT_SORT=$(this).attr("value"),sortLists()})}),$(document).ready(function(){$(".zoom").click(function(){zoomElementClick($(this))})}),$(document).ready(function(){$("#geocode_button").click(function(){zoomToAddress($("#geocode_text").val())}),$("#geocode_text").keydown(function(t){13==t.keyCode&&$("#geocode_button").click()})}),$(document).ready(function(){$("#show_on_map").click(showOnMap)}),$(document).on("mapReady",setupWindowURLUpdates),$(document).ready(function(){$('input[type="radio"][name="coordinate_format"]').change(function(){changeCoordinateFormat($(this).val()),update_user_latlon_display()})}),$(document).ready(function(){getSessionCoordinateFormat()}),$(document).on("mapReady",function(){MAP.on("click",function(t){if($(".leaflet-popup").length)return MAP.closePopup();wmsGetFeatureInfoByPoint(t.point,t.lngLat)})});
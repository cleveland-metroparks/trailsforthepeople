let trailviewToggled=!1,trailviewViewer=null,trailviewMapMarker=null,trailviewMouseOnDot=!1,trailviewFocusedElement="map",lastMapResize=new Date;function initTrailView(){const e=document.querySelector("#trailview_enable_button");if(null===e)throw new Error("trailview_enable_button id not found");e.addEventListener("click",()=>{toggleTrailView()});const t=document.querySelector("#map_canvas");new ResizeObserver(()=>{(new Date).valueOf()-lastMapResize.valueOf()>100&&(MAP.resize(),lastMapResize=new Date)}).observe(t),t.addEventListener("transitionend",()=>{MAP.resize(),null!==trailviewMapMarker&&MAP.easeTo({center:trailviewMapMarker.getLngLat(),duration:500})})}function toggleTrailView(){if(!1===trailviewToggled){if(trailviewToggled=!0,addTrailViewMapLayer(),$("#trailview_viewer").fadeIn(),null===trailviewViewer){const e=trailviewer.defaultBaseOptions;e.target="trailview_viewer",trailviewViewer=new trailviewer.TrailViewerBase(e),trailviewViewer.on("image-change",e=>{null!==MAP&&null!==trailviewMapMarker&&(trailviewMapMarker.setLngLat([e.longitude,e.latitude]),MAP.easeTo({center:trailviewMapMarker.getLngLat(),duration:500}))})}addTrailviewUI()}else"viewer"===trailviewFocusedElement&&toggleTrailViewFocus(),trailviewToggled=!1,removeTrailViewMapLayer(),$("#trailview_viewer").fadeOut(),trailviewViewer.destroy(),trailviewViewer=null}function removeTrailViewMapLayer(){MAP.getSource("dots")&&(MAP.removeLayer("dots"),MAP.removeSource("dots"))}function addTrailviewUI(){{const e=document.createElement("button");e.type="button",e.id="trailview_expand_button",e.classList.add("trailview-button"),e.setAttribute("data-role","none");const t=document.createElement("span");t.classList.add("cm-icon-expand"),e.appendChild(t),document.querySelector("#trailview_viewer").appendChild(e),e.addEventListener("click",()=>{toggleTrailViewFocus()})}{const e=document.createElement("button");e.type="button",e.id="trailview_close_button",e.classList.add("trailview-button"),e.setAttribute("data-role","none");const t=document.createElement("span");t.classList.add("cm-icon-close"),e.appendChild(t),document.querySelector("#trailview_viewer").appendChild(e),e.addEventListener("click",()=>{toggleTrailView()})}}function toggleTrailViewFocus(){if("map"===trailviewFocusedElement){trailviewFocusedElement="viewer",document.querySelector("#map_canvas").classList.add("trailview-map-small"),document.querySelector("#trailview_viewer").classList.remove("trailviewer-small"),document.querySelector("#trailview_viewer").classList.add("trailviewer-focus"),document.querySelector("#trailview_expand_button span").classList=["cm-icon-compress"],document.querySelector("#map_canvas").addEventListener("transitionend",()=>{MAP.resize()},{once:!0});const e=document.createElement("button");e.type="button",e.id="trailview_map_expand_button",e.classList.add("trailview-button"),e.setAttribute("data-role","none");const t=document.createElement("span");t.classList.add("cm-icon-expand"),e.appendChild(t),document.querySelector("#map_canvas").appendChild(e),e.addEventListener("click",()=>{toggleTrailViewFocus()})}else"viewer"===trailviewFocusedElement&&(trailviewFocusedElement="map",document.querySelector("#map_canvas").classList.remove("trailview-map-small"),document.querySelector("#trailview_viewer").classList.remove("trailviewer-focus"),document.querySelector("#trailview_viewer").classList.add("trailviewer-small"),document.querySelector("#trailview_expand_button span").classList=["cm-icon-expand"],document.querySelector("#trailview_map_expand_button").remove(),MAP.resize())}function addTrailViewMapLayer(){if(null===MAP)return;removeTrailViewMapLayer();MAP.addSource("dots",{type:"vector",format:"pbf",tiles:["https://trailview.cmparks.net/api/tiles/{z}/{x}/{y}/standard"]}),MAP.addLayer({id:"dots","source-layer":"geojsonLayer",source:"dots",type:"circle",paint:{"circle-radius":10,"circle-color":["case",["==",["get","visible"],!0],"#00a108","#db8904"]}}),MAP.setPaintProperty("dots","circle-radius",["interpolate",["exponential",.5],["zoom"],13,3,16,5,17,7,20,8]),MAP.setPaintProperty("dots","circle-opacity",["interpolate",["exponential",.5],["zoom"],13,.05,15,.1,17,.25,20,1]),MAP.on("mouseenter","dots",()=>{trailviewMouseOnDot=!0,null!==MAP&&(MAP.getCanvas().style.cursor="pointer")}),MAP.on("mouseleave","dots",()=>{trailviewMouseOnDot=!1,null!==MAP&&(MAP.getCanvas().style.cursor="grab")}),MAP.on("mousedown",()=>{null===MAP||trailviewMouseOnDot||(MAP.getCanvas().style.cursor="grabbing")}),MAP.on("mouseup",()=>{null!==MAP&&trailviewMouseOnDot?MAP.getCanvas().style.cursor="pointer":null!==MAP&&(MAP.getCanvas().style.cursor="grab")}),createTrailviewMapMarker(),MAP.on("click","dots",e=>{void 0!==e.features&&null!==e.features[0].properties?trailviewViewer.goToImageID(e.features[0].properties.imageID):console.warn("Features is undefiend or properties are null")})}function createTrailviewMapMarker(){const e=document.createElement("div");e.classList.add("trailview-current-marker-wrapper");const t=document.createElement("div");t.classList.add("trailview-current-marker");const a=document.createElement("div");a.classList.add("trailview-marker-viewer"),e.appendChild(t),e.appendChild(a),trailviewMapMarker=new mapboxgl.Marker(e).setLngLat([-81.682665,41.4097766]).addTo(MAP).setRotationAlignment("map"),updateTrailViewMarkerRotation()}function updateTrailViewMarkerRotation(){if(null!==trailviewViewer&&null!==trailviewMapMarker){const e=trailviewViewer.getBearing();void 0!==e&&trailviewMapMarker.setRotation((e+225)%360)}!1!==trailviewToggled?requestAnimationFrame(updateTrailViewMarkerRotation):trailviewMapMarker.remove()}
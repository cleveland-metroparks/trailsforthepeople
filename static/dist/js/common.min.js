function initMap(){var a,b=URL_PARAMS.param("base")||"map";switch(b){case"photo":a=LAYER_MAPBOX_SAT;break;case"map":default:a=isMobile?LAYER_MAPBOX_MAP:LAYER_MAPBOX_GL_MAP}var c={attributionControl:!1,zoomControl:!1,dragging:!0,closePopupOnClick:!1,crs:L.CRS.EPSG3857,minZoom:MIN_ZOOM,maxZoom:MAX_ZOOM,layers:[a]},d=navigator.userAgent.match(/Android (4|5)/);if(d&&(c.fadeAnimation=!0,c.zoomAnimation=!0,c.markerZoomAnimation=!0),MAP=new L.Map("map_canvas",c),new L.Control.Zoom({position:"bottomright"}).addTo(MAP),URL_PARAMS.param("x")&&URL_PARAMS.param("y")&&URL_PARAMS.param("z")){var e=parseFloat(URL_PARAMS.param("x")),f=parseFloat(URL_PARAMS.param("y")),g=parseInt(URL_PARAMS.param("z"));MAP.setView(L.latLng(f,e),g),MAP.addLayer(MARKER_TARGET),MARKER_TARGET.setLatLng(L.latLng(f,e))}else MAP.fitBounds(MAX_BOUNDS);if(L.control.scale().addTo(MAP),MAP.on("click",function(a){if(ENABLE_MAPCLICK)return $(".leaflet-popup").length?MAP.closePopup():void wmsGetFeatureInfoByPoint(a.layerPoint)}),URL_PARAMS.param("type")&&URL_PARAMS.param("name")){var h={type:URL_PARAMS.param("type"),name:URL_PARAMS.param("name")};$.get(APP_BASEPATH+"ajax/exactnamesearch",h,function(a){if(!(a&&a.s&&a.w&&a.n&&a.e))return alert("Cound not find that feature.");var b=L.latLngBounds(L.latLng(a.s,a.w),L.latLng(a.n,a.e));MAP.fitBounds(b),a.lat&&a.lng?placeTargetMarker(a.lat,a.lng):a.wkt&&(HIGHLIGHT_LINE=lineWKTtoFeature(a.wkt,HIGHLIGHT_LINE_STYLE),MAP.addLayer(HIGHLIGHT_LINE))},"json")}if(URL_PARAMS.param("type")&&URL_PARAMS.param("gid")&&"attraction"==URL_PARAMS.param("type")){var h={gid:URL_PARAMS.param("gid")};$.get(APP_BASEPATH+"ajax/get_attraction",h,function(a){return a&&a.lat&&a.lng?(placeTargetMarker(a.lat,a.lng),MAP.flyTo(L.latLng(a.lat,a.lng),DEFAULT_POI_ZOOM),void showAttractionInfo(a)):alert("Cound not find that feature.")},"json")}if(URL_PARAMS.param("routefrom")&&URL_PARAMS.param("routeto")&&URL_PARAMS.param("routevia")){var i=URL_PARAMS.param("routefrom").split(",")[0],j=URL_PARAMS.param("routefrom").split(",")[1],k=URL_PARAMS.param("routeto").split(",")[0],l=URL_PARAMS.param("routeto").split(",")[1],m=URL_PARAMS.param("routevia"),n="to";sidebar.open("pane-getdirections"),$("#getdirections_disabled").hide(),$("#getdirections_enabled").show(),$("#directions_target_title").text(URL_PARAMS.param("routetitle")),$("#directions_via").val(URL_PARAMS.param("routevia")),MOBILE&&$("#directions_via").selectmenu("refresh"),$("#directions_type").val("geocode"),MOBILE&&$("#directions_type").selectmenu("refresh"),MOBILE?$("#directions_type_geocode_wrap").show():$("#directions_type").change(),$("#directions_address").val(URL_PARAMS.param("routefrom")),$("#directions_target_lat").val(k),$("#directions_target_lng").val(l),$("#directions_via").trigger("change"),$("#directions_address").val(URL_PARAMS.param("fromaddr")),$("#directions_reverse").val(URL_PARAMS.param("whichway")),$("#directions_via_bike").val(URL_PARAMS.param("routevia_bike")),setTimeout(function(){$("#directions_reverse").trigger("change")},1e3),$("#directions_type").val(URL_PARAMS.param("loctype")),getDirections(i,j,k,l,n,m)}$.event.trigger({type:"mapReady"})}function lineWKTtoFeature(a,b){var c=new Wkt.Wkt;return c.read(a),c.toObject(b)}function WSENtoBounds(a,b,c,d){return L.latLngBounds([[b,a],[d,c]])}function placeTargetMarker(a,b){MAP.addLayer(MARKER_TARGET),MARKER_TARGET.setLatLng(L.latLng(a,b))}function clearTargetMarker(){MAP.removeLayer(MARKER_TARGET)}function placeGPSMarker(a,b){MAP.addLayer(MARKER_GPS),MARKER_GPS.setLatLng(L.latLng(a,b))}function clearGPSMarker(){MAP.removeLayer(MARKER_GPS)}function showInfoPopup(a,b){switch(MAP.removeLayer(INFO_POPUP),b){case"warning":classes="info-popup warning";break;case"error":classes="info-popup error";break;default:classes="info-popup"}INFO_POPUP=L.popup({className:classes}).setLatLng(MAP.getCenter()).setContent(a).openOn(MAP)}function clearInfoPopup(){MAP.removeLayer(INFO_POPUP),INFO_POPUP.options.className}function placeCircle(a,b,c){MAP.removeLayer(CIRCLE),CIRCLE.setLatLng(L.latLng(a,b)),CIRCLE.setRadius(c),MAP.addLayer(CIRCLE)}function clearCircle(){CIRCLE.setLatLng(L.latLng(0,0)),CIRCLE.setRadius(1),MAP.removeLayer(CIRCLE)}function strToLatLng(a){var a=a.replace(/\s+$/,"").replace(/^\s+/,"");if(a.match(/^[\d\.\-\,\s]+$/)){var b=a.split(/[\s\,]+/);if(2==b.length&&(b[0]=parseFloat(b[0]),b[1]=parseFloat(b[1]),b[0]&&b[1])){var c,d;return b[0]<0?(c=b[1],d=b[0]):(c=b[0],d=b[1]),L.latLng([c,d])}}var e=a.match(/^N\s*(\d\d)\s+(\d\d\.\d\d\d)\s+W\s*(\d\d\d)\s+(\d\d\.\d\d\d)$/i);if(e){var f=parseInt(e[1]),g=parseInt(e[2]),h=parseInt(e[3]),i=parseInt(e[4]),c=f+g/60,d=-h-i/60;return L.latLng([c,d])}return null}function zoomToAddress(a){if(!a)return!1;var b={};b.address=a,b.bing_key=BING_API_KEY,b.bbox=GEOCODE_BIAS_BOX,$.get(APP_BASEPATH+"ajax/geocode",b,function(a){if(!a)return alert("We couldn't find that address or city.\nPlease try again.");var b=L.latLng(a.lat,a.lng);return MAX_BOUNDS.contains(b)?void switchToMap(function(){MAP.setView(b,16),placeTargetMarker(a.lat,a.lng);var c="";c+='<h3 class="popup_title">'+a.title+"</h3>",c+='<span class="fakelink zoom" title="'+a.title+'" lat="'+a.lat+'" lng="'+a.lng+'" w="'+a.w+'" s="'+a.s+'" e="'+a.e+'" n="'+a.n+'" onClick="zoomElementClick( $(this) );">Directions</span>';var d=new L.Popup;d.setLatLng(b),d.setContent(c),MAP.openPopup(d)}):alert("The only results we could find are too far away to zoom the map there.")},"json")}function wmsGetFeatureInfoByPoint(a){var b=20,c=MAP.layerPointToLatLng(new L.Point(a.x-b,a.y+b)),d=MAP.layerPointToLatLng(new L.Point(a.x+b,a.y-b)),e={w:c.lng,s:c.lat,e:d.lng,n:d.lat},f=MAP.layerPointToLatLng(new L.Point(a.x,a.y));wmsGetFeatureInfoByLatLngBBOX(e,f)}function wmsGetFeatureInfoByLatLng(a){var b={w:a.lng,s:a.lat,e:a.lng,n:a.lat},c=a;wmsGetFeatureInfoByLatLngBBOX(b,c)}function wmsGetFeatureInfoByLatLngBBOX(a,b){var c=a;c.zoom=MAP.getZoom(),$.get(APP_BASEPATH+"ajax/query",c,function(a){if(a){var c={};c.maxHeight=parseInt($("#map_canvas").height()),c.maxWidth=parseInt($("#map_canvas").width());var d=new L.Popup(c);d.setLatLng(b),d.setContent(a),MAP.openPopup(d)}},"html")}function changeBasemap(a){for("map"==a&&(isMobile||(a="vector")),new_active_layer=AVAILABLE_LAYERS[a],i=0;i<ALL_LAYERS.length;i++)ALL_LAYERS[i]==new_active_layer?(MAP.hasLayer(ALL_LAYERS[i])||MAP.addLayer(ALL_LAYERS[i],!0),"vector"!=a&&new_active_layer.bringToBack()):MAP.hasLayer(ALL_LAYERS[i])&&MAP.removeLayer(ALL_LAYERS[i])}function disableKeywordButton(){var a=$("#search_keyword_button");MOBILE?(a.button("disable"),a.closest(".ui-btn").find(".ui-btn-text").text(a.attr("value0"))):(a.prop("disabled",!0),a.val(a.attr("value0")))}function enableKeywordButton(){var a=$("#search_keyword_button");MOBILE?(a.button("enable"),a.closest(".ui-btn").find(".ui-btn-text").text(a.attr("value1"))):(a.prop("disabled",!1),a.val(a.attr("value1")))}function trailfinderUpdate(){var a={};a.reservation=$('select[name="trailfinder_reservation"]').val(),a.paved=$('select[name="trailfinder_paved"]').val(),a.uses=[],$('input[name="trailfinder_uses"]:checked').each(function(){a.uses[a.uses.length]=$(this).val()}),a.uses=a.uses.join(","),searchTrails(a)}function searchTrails(a){var b=$("#trailfinder_results");b.empty(),$.get(APP_BASEPATH+"ajax/search_trails",a,function(a){if(a.length)for(var c=0,d=a.length;c<d;c++){var e=a[c],f=$("<li></li>").addClass("zoom");f.attr("title",e.name).attr("gid",e.gid).attr("type",e.type).attr("w",e.w).attr("s",e.s).attr("e",e.e).attr("n",e.n).attr("lat",e.lat).attr("lng",e.lng),f.attr("backbutton","#pane-trailfinder"),link=$("<a></a>"),link.attr("class","ui-btn ui-btn-text"),f.append(link),f.click(function(){zoomElementClick($(this))}),link.append($("<h4></h4>").addClass("ui-li-heading").text(e.name)),e.note&&link.append($("<span></span>").addClass("ui-li-desc").html(e.note)),link.append($("<span></span>").addClass("zoom_distance").addClass("ui-li-count").addClass("ui-btn-up-c").addClass("ui-btn-corner-all").text("0 mi")),f.append(link),b.append(f)}else b.append($("<li></li>").text("No results."));MOBILE&&b.listview("refresh"),MOBILE&&sortLists(b)},"json")}var MOBILE,isMobile=/Mobi/.test(navigator.userAgent),ICON_TARGET=L.icon({iconUrl:APP_BASEPATH+"static/images/markers/marker-target.png",iconSize:[25,41],iconAnchor:[13,41],popupAnchor:[0,-41]}),MARKER_TARGET=L.marker(L.latLng(0,0),{clickable:!1,draggable:!1,icon:ICON_TARGET}),ICON_GPS=L.icon({iconUrl:APP_BASEPATH+"static/images/markers/marker-gps.png",iconSize:[25,41],iconAnchor:[13,41],popupAnchor:[0,-41]}),MARKER_GPS=L.marker(L.latLng(0,0),{clickable:!1,draggable:!1,icon:ICON_GPS}),ICON_FROM=L.icon({iconUrl:APP_BASEPATH+"static/images/markers/measure1.png",iconSize:[20,34],iconAnchor:[10,34]}),ICON_TO=L.icon({iconUrl:APP_BASEPATH+"static/images/markers/measure2.png",iconSize:[20,34],iconAnchor:[10,34]}),MARKER_FROM=L.marker(L.latLng(0,0),{clickable:!0,draggable:!0,icon:ICON_FROM}),MARKER_TO=L.marker(L.latLng(0,0),{clickable:!0,draggable:!0,icon:ICON_TO}),INFO_POPUP_OPTIONS={className:"info-popup"},INFO_POPUP=L.popup(INFO_POPUP_OPTIONS),CIRCLE=new L.Circle(L.latLng(0,0),1),ELEVATION_PROFILE=null,HIGHLIGHT_LINE=null,HIGHLIGHT_LINE_STYLE={color:"#FF00FF",weight:3,opacity:.75,clickable:!1,smoothFactor:.25},URL_PARAMS=null,ENABLE_MAPCLICK=!0,SKIP_TO_DIRECTIONS=!1;L.LatLng.prototype.bearingTo=function(a){var b=L.LatLng.DEG_TO_RAD,c=L.LatLng.RAD_TO_DEG,d=this.lat*b,e=a.lat*b,f=(a.lng-this.lng)*b,g=Math.sin(f)*Math.cos(e),h=Math.cos(d)*Math.sin(e)-Math.sin(d)*Math.cos(e)*Math.cos(f),i=Math.atan2(g,h);return i=parseInt(i*c),i=(i+360)%360},L.LatLng.prototype.bearingWordTo=function(a){var b=this.bearingTo(a),c="";return b>=22&&b<=67?c="NE":b>=67&&b<=112?c="E":b>=112&&b<=157?c="SE":b>=157&&b<=202?c="S":b>=202&&b<=247?c="SW":b>=247&&b<=292?c="W":b>=292&&b<=337?c="NW":(b>=337||b<=22)&&(c="N"),c},$(window).load(function(){var a=function(){var a=$("#geocode_text").val();zoomToAddress(a)};$("#geocode_button").click(a),$("#geocode_text").keydown(function(a){13==a.keyCode&&$("#geocode_button").click()})}),$(window).load(function(){var a=function(){zoomElementClick($(this))};$(".zoom").click(a);var b=function(){var a=$(this).data("zoomelement");if(a){var b=a.attr("w"),c=a.attr("s"),d=a.attr("e"),e=a.attr("n"),f=a.attr("lng"),g=a.attr("lat"),h=a.attr("type"),i=$(this).data("wkt");switchToMap(function(){if(0!=b&&0!=c&&0!=d&&0!=e){var a=L.latLngBounds(L.latLng(c,b),L.latLng(e,d));a=a.pad(.15),MAP.fitBounds(a)}else MAP.flyTo(L.latLng(g,f),DEFAULT_POI_ZOOM);"poi"!=h&&"attraction"!=h&&"loop"!=h||placeTargetMarker(g,f),i&&(HIGHLIGHT_LINE&&(MAP.removeLayer(HIGHLIGHT_LINE),HIGHLIGHT_LINE=null),HIGHLIGHT_LINE=lineWKTtoFeature(i,HIGHLIGHT_LINE_STYLE),MAP.addLayer(HIGHLIGHT_LINE))})}};$("#show_on_map").click(b)}),$(window).load(function(){$("#trailfinder_typeicons img").click(function(){var a=$(this),b=a.attr("data-value");$('input[name="trailfinder_uses"]').removeAttr("checked").filter('[value="'+b+'"]').attr("checked","checked"),$("#trailfinder_typeicons img").each(function(){var b=$(this).prop("src");b=$(this).is(a)?b.replace("_off.png","_on.png"):b.replace("_on.png","_off.png"),$(this).prop("src",b)}),trailfinderUpdate()}),$("#trailfinder_go").click(function(){trailfinderUpdate()}),$('select[name="trailfinder_reservation"]').change(function(){trailfinderUpdate()}),$('select[name="trailfinder_paved"]').change(function(){trailfinderUpdate()})});
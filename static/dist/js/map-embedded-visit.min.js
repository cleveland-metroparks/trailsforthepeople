function disableGeolocation(){$(".interactive-form-distance-near-me-input").prop("checked",!1),userLocation=null,clearGPSMarker()}function callGetActivities(a){return $.ajax({url:a.get_activities_url,dataType:"json",data:a}).done(function(a){displayActivities(a.results)}).fail(function(a,b,c){console.log("callGetActivities error"),console.log(b+": "+c)})}function callGeocodeAddress(a){var b={};return b.address=a.searchtext,b.bing_key=BING_API_KEY,b.bbox=GEOCODE_BIAS_BOX,$.ajax({url:APP_BASEPATH+"ajax/geocode",dataType:"json",data:b}).done(function(a){var b=L.latLng(a.lat,a.lng);return MAX_BOUNDS.contains(b)?void placeGPSMarker(a.lat,a.lng):void showInfoPopup("The location we found for your address is too far away.","warning")}).fail(function(a,b,c){console.log(b+": "+c),showInfoPopup("We couldn't find that address or city.\nPlease try again.","warning")})}function displayActivities(a){for(var b=0;b<a.length;b++){var c=a[b];marker=new L.marker([c.lat,c.lng],{clickable:!0,draggable:!1,icon:ICON_TARGET}).bindPopup(attractionPopupMarkup(c)),markerLayer.addLayer(marker)}markerLayer.addTo(MAP),MAP.fitBounds(MAX_BOUNDS)}function attractionPopupMarkup(a){return showAll=$("#map_canvas").height()>=500,markup="<h3>"+a.name+"</h3>",showAll&&a.description&&(markup+="<p>"+a.description+"</p>"),a.cmp_url&&(markup+='<p><a href="'+a.cmp_url+'" title="Find out more about '+a.name+'." target="_blank">More info</a></p>'),showAll&&a.thumbnail&&(thumbnail_path=CM_SITE_BASEURL+a.thumbnail.replace("~/",""),thumbnail_height=150,thumbnail_path=thumbnail_path.replace(/width=\d*\&height=\d*\&/,"height="+thumbnail_height+"&"),markup+='<img src="'+thumbnail_path+'" height="'+thumbnail_height+'" alt="'+a.name+'" />'),map_link=APP_BASEPATH+"mobile?type=attraction&gid="+a.gid,markup+='<p><a href="'+map_link+'" target="_blank">See on full map </a></p>',markup}var markerLayer=L.featureGroup(),userLocation;$(document).ready(function(){var a={base:"map"};initMap(a),MAP.scrollWheelZoom.disable(),$("#filters-section .filter-action-area .update-results-button").click(function(){markerLayer.clearLayers();var a=[];if($("#filters-section .filter-subfield-list input:checkbox:checked").each(function(){a.push($(this).attr("value"))}),a.length){var b=$(".interactive-form-distance-near-me-input").prop("checked"),c=$("input.locationTxt").val(),d={activity_ids:a},e=5280*$("select.locationRadiusDDL").val();b&&userLocation?(d.get_activities_url=APP_BASEPATH+"ajax/get_nearby_attractions_with_activities",d.lat=userLocation.lat,d.lng=userLocation.lng,d.within_feet=e,callGetActivities(d)):c?(d.get_activities_url=APP_BASEPATH+"ajax/get_nearby_attractions_with_activities",d.searchtext=c,d.within_feet=e,callGeocodeAddress(d).then(function(a,b,c){d.lat=a.lat,d.lng=a.lng,callGetActivities(d)})):(d.get_activities_url=APP_BASEPATH+"ajax/get_attractions_by_activity",callGetActivities(d))}}),$("#filters-section .filter-action-area .clear-filters-button").click(function(){markerLayer.clearLayers()}),$(".interactive-form-distance-near-me-input").click(function(){$(".interactive-form-distance-near-me-input").prop("checked")?MAP.locate({watch:!1,enableHighAccuracy:!0}):(MAP.stopLocate(),disableGeolocation())}),MAP.on("locationfound",function(a){placeGPSMarker(a.latlng.lat,a.latlng.lng),userLocation=a.latlng,MAX_BOUNDS.contains(a.latlng)?MAP.panTo(a.latlng):(showInfoPopup("Sorry, your current location is too far away.","warning"),console.log("Geolocation out of bounds: ",userLocation),disableGeolocation())}),MAP.on("locationerror",function(a){showInfoPopup("We couldn't acquire your current location.","error"),console.log("Geolocation error: "+a.message+"("+a.code+")"),disableGeolocation()}),$(".update-results-button").attr("type","button"),$(".update-results-button").attr("onclick",""),$(".clear-filters-button").attr("onclick","")});
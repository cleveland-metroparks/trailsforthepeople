function disableGeolocation(){userLocation=null,clearGPSMarker()}function callGetAttractions(a){return $.ajax({url:a.get_attractions_url,dataType:"json",data:a}).done(function(a){displayActivities(a.results)}).fail(function(a,b,c){console.log("callGetAttractions error"),console.log(b+": "+c)})}function callGeocodeAddress(a){var b={};return b.address=a.searchtext,b.bing_key=BING_API_KEY,b.bbox=GEOCODE_BIAS_BOX,$.ajax({url:API_ENDPOINT_GEOCODE,dataType:"json",data:b}).done(function(a){var b=L.latLng(a.lat,a.lng);if(!MAX_BOUNDS.contains(b))return void showInfoPopup("The location we found for your address is too far away.","warning");placeGPSMarker(a.lat,a.lng)}).fail(function(a,b,c){console.log(b+": "+c),showInfoPopup("We couldn't find that address or city.\nPlease try again.","warning")})}function displayActivities(a){var b,c;for(b=0;b<a.length;b+=1)c=a[b],marker=new L.marker([c.lat,c.lng],{clickable:!0,draggable:!1,icon:ICON_TARGET}).bindPopup(attractionPopupMarkup(c)),markerLayer.addLayer(marker);markerLayer.addTo(MAP),MAP.fitBounds(MAX_BOUNDS)}function attractionPopupMarkup(a){return showAll=$("#map_canvas").height()>=500,markup="<h3>"+a.name+"</h3>",showAll&&a.description&&(markup+="<p>"+a.description+"</p>"),a.cmp_url&&(markup+='<p><a href="'+a.cmp_url+'" title="Find out more about '+a.name+'." target="_blank">More info</a></p>'),showAll&&a.thumbnail&&(thumbnail_path=CM_SITE_BASEURL+a.thumbnail.replace("~/",""),thumbnail_height=150,thumbnail_path=thumbnail_path.replace(/width=\d*\&height=\d*\&/,"height="+thumbnail_height+"&"),markup+='<img src="'+thumbnail_path+'" height="'+thumbnail_height+'" alt="'+a.name+'" />'),map_link=WEBAPP_BASEPATH+"mobile?type=attraction&gid="+a.gid,markup+='<p><a href="'+map_link+'" target="_blank">See on full map </a></p>',markup}const API_ENDPOINT_GEOCODE=API_BASEPATH+"ajax/geocode",API_ENDPOINT_ATTRACTIONS_WITH_ACTIVITIES=API_BASEPATH+"ajax/get_attractions_by_activity",API_ENDPOINT_ATTRACTIONS_WITH_ACTIVITIES_NEARBY=API_BASEPATH+"ajax/get_nearby_attractions_with_activities";var markerLayer=L.featureGroup(),userLocation;$(document).ready(function(){var a={base:"map"};initMap(a),MAP.scrollWheelZoom.disable();var b=new URLSearchParams(location.search);if(b.has("activitytype"))var c=b.get("activitytype").split("|");var d;b.has("location")&&(d=b.get("location"));var e=b.has("nearme")&&"True"==b.get("nearme");if(b.has("lat")&&b.has("long"))var f=parseFloat(b.get("lat")),g=parseFloat(b.get("long"));var h,i;b.has("distance")&&(h=b.get("distance"),i=5280*h),i=Number.isInteger(i)?i:0;var j={activity_ids:c,within_feet:i};c&&(e?(j.get_attractions_url=API_ENDPOINT_ATTRACTIONS_WITH_ACTIVITIES_NEARBY,userLocation?(j.lat=userLocation.lat,j.lng=userLocation.lng):f&&g?(j.lat=f,j.lng=g):j.get_attractions_url=API_ENDPOINT_ATTRACTIONS_WITH_ACTIVITIES,callGetAttractions(j)):d?(j.get_attractions_url=API_ENDPOINT_ATTRACTIONS_WITH_ACTIVITIES_NEARBY,j.searchtext=d,callGeocodeAddress(j).then(function(a,b,c){j.lat=a.lat,j.lng=a.lng,callGetAttractions(j)})):(j.get_attractions_url=API_ENDPOINT_ATTRACTIONS_WITH_ACTIVITIES,delete j.within_feet,callGetAttractions(j))),$("#nearme").click(function(){$("#nearme").prop("checked")?MAP.locate({watch:!1,enableHighAccuracy:!0}):(MAP.stopLocate(),disableGeolocation())}),MAP.on("locationfound",function(a){placeGPSMarker(a.latlng.lat,a.latlng.lng),userLocation=a.latlng,MAX_BOUNDS.contains(a.latlng)?MAP.panTo(a.latlng):(showInfoPopup("Sorry, your current location is too far away.","warning"),console.log("Geolocation out of bounds: ",userLocation),disableGeolocation())}),MAP.on("locationerror",function(a){showInfoPopup("We couldn't acquire your current location.","error"),console.log("Geolocation error: "+a.message+"("+a.code+")"),disableGeolocation()})});
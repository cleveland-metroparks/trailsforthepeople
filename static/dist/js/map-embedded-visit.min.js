var userLocation,API_ENDPOINT_GEOCODE=API_BASEPATH+"ajax/geocode",API_ENDPOINT_ATTRACTIONS_WITH_ACTIVITIES=API_BASEPATH+"ajax/get_attractions_by_activity",API_ENDPOINT_ATTRACTIONS_WITH_ACTIVITIES_NEARBY=API_BASEPATH+"ajax/get_nearby_attractions_with_activities",markerLayer=L.featureGroup();function disableGeolocation(){userLocation=null}function callGetAttractions(a){return $.ajax({url:a.get_attractions_url,dataType:"json",data:a}).done(function(a){displayActivities(a.results)}).fail(function(a,t,o){console.log("callGetAttractions error"),console.log(t+": "+o)})}function callGeocodeAddress(a){var t={};return t.address=a.searchtext,t.bing_key=BING_API_KEY,t.bbox=GEOCODE_BIAS_BOX,$.ajax({url:API_ENDPOINT_GEOCODE,dataType:"json",data:t}).done(function(a){var t=L.latLng(a.lat,a.lng);MAX_BOUNDS.contains(t)||showInfoPopup("The location we found for your address is too far away.","warning")}).fail(function(a,t,o){console.log(t+": "+o),showInfoPopup("We couldn't find that address or city.\nPlease try again.","warning")})}function displayActivities(a){var t,o;for(t=0;t<a.length;t+=1)o=a[t],marker=new L.marker([o.lat,o.lng],{clickable:!0,draggable:!1,icon:ICON_TARGET}).bindPopup(attractionPopupMarkup(o)),markerLayer.addLayer(marker);markerLayer.addTo(MAP),MAP.fitBounds(MAX_BOUNDS)}function attractionPopupMarkup(a){return showAll=500<=$("#map_canvas").height(),markup="<h3>"+a.name+"</h3>",showAll&&a.description&&(markup+="<p>"+a.description+"</p>"),a.cmp_url&&(markup+='<p><a href="'+a.cmp_url+'" title="Find out more about '+a.name+'." target="_blank">More info</a></p>'),showAll&&a.thumbnail&&(thumbnail_path=CM_SITE_BASEURL+a.thumbnail.replace("~/",""),thumbnail_height=150,thumbnail_path=thumbnail_path.replace(/width=\d*\&height=\d*\&/,"height="+thumbnail_height+"&"),markup+='<img src="'+thumbnail_path+'" height="'+thumbnail_height+'" alt="'+a.name+'" />'),map_link=WEBAPP_BASEPATH+"mobile?type=attraction&gid="+a.gid,markup+='<p><a href="'+map_link+'" target="_blank">See on full map </a></p>',markup}$(document).ready(function(){initMap({base:"map"}),MAP.scrollZoom.disable();var a,t=new URLSearchParams(location.search);if(t.has("activitytype"))var o=t.get("activitytype").split("|");t.has("location")&&(a=t.get("location"));var e,n=t.has("nearme")&&"True"==t.get("nearme");if(t.has("lat")&&t.has("long"))var r=parseFloat(t.get("lat")),i=parseFloat(t.get("long"));t.has("distance")&&(e=5280*t.get("distance"));var l={activity_ids:o,within_feet:e=Number.isInteger(e)?e:0};n&&MAP.locate({watch:!1,enableHighAccuracy:!0}),o&&(n?(l.get_attractions_url=API_ENDPOINT_ATTRACTIONS_WITH_ACTIVITIES_NEARBY,userLocation?(l.lat=userLocation.lat,l.lng=userLocation.lng):r&&i?(l.lat=r,l.lng=i):l.get_attractions_url=API_ENDPOINT_ATTRACTIONS_WITH_ACTIVITIES,callGetAttractions(l)):a?(l.get_attractions_url=API_ENDPOINT_ATTRACTIONS_WITH_ACTIVITIES_NEARBY,l.searchtext=a,callGeocodeAddress(l).then(function(a,t,o){l.lat=a.lat,l.lng=a.lng,callGetAttractions(l)})):(l.get_attractions_url=API_ENDPOINT_ATTRACTIONS_WITH_ACTIVITIES,delete l.within_feet,callGetAttractions(l))),$("#nearme").click(function(){$("#nearme").prop("checked")?MAP.locate({watch:!1,enableHighAccuracy:!0}):(MAP.stopLocate(),disableGeolocation())}),MAP.on("locationfound",function(a){userLocation=a.latlng,MAX_BOUNDS.contains(a.latlng)?MAP.panTo(a.latlng):(showInfoPopup("Sorry, your current location is too far away.","warning"),console.log("Geolocation out of bounds: ",userLocation),disableGeolocation())}),MAP.on("locationerror",function(a){showInfoPopup("We couldn't acquire your current location.","error"),console.log("Geolocation error: "+a.message+"("+a.code+")"),disableGeolocation()})});
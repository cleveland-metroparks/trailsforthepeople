var USER_LOCATION,ALL_MARKERS=[];function processQueryParams(){var t,a=new URLSearchParams(location.search),o=null;a.has("activitytype")&&(o=a.get("activitytype").split("|")),a.has("location")&&(t=a.get("location"));var e,n=a.has("nearme")&&"True"==a.get("nearme");if(n&&basicGeolocate(),a.has("lat")&&a.has("long"))var i=parseFloat(a.get("lat")),r=parseFloat(a.get("long"));a.has("distance")&&(e=5280*a.get("distance")),e=Number.isInteger(e)?e:0;var l={with_activities:o?o.join("|"):"",within_feet:e};if(o)if(n){if(null!=USER_LOCATION?(l.nearby_lat=USER_LOCATION.coords.latitude,l.nearby_lng=USER_LOCATION.coords.longitude):i&&r&&(l.nearby_lat=i,l.nearby_lng=r),l.nearby_lat&&l.nearby_lng)return $.get(API_NEW_BASE_URL+"attractions",l,(function(t){t.data.length>0?displayAttractions(t.data):showInfoPopup("Didn't find any attractions with those activities within the given radius from your location.","error")})).fail((function(t,a,o){showInfoPopup("Could not find any nearby attractions.","error"),console.log(a+": "+o)}))}else if(t)callGeocodeAddress(t).then((function(t,a,o){return l.nearby_lat=t.data.lat,l.nearby_lng=t.data.lng,$.get(API_NEW_BASE_URL+"attractions",l,(function(t){t.data.length>0?displayAttractions(t.data):showInfoPopup("Didn't find any attractions with those activities within the given radius from your address.","error")})).fail((function(t,a,o){showInfoPopup("Failed searching for attractions nearby the given address.","error"),console.log(a+": "+o)}))})).fail((function(t,a,o){showInfoPopup("Failed finding the address you provided.","error"),console.log(a+": "+o)}));else{displayAttractions(CM.get_attractions_by_activity(o))}}function basicGeolocate(){navigator.geolocation.getCurrentPosition(geolocateSuccess,null,{enableHighAccuracy:!0})}function geolocateSuccess(t){USER_LOCATION=t}function disableGeolocation(){USER_LOCATION=null}function callGeocodeAddress(t){return $.get(API_NEW_BASE_URL+"geocode/"+t,null,(function(t){var a=new mapboxgl.LngLat(t.data.lng,t.data.lat);MAX_BOUNDS.contains(a)||showInfoPopup("The location we found for your address is too far away.","warning")})).fail((function(t,a,o){console.log(a+": "+o),showInfoPopup("We couldn't find that address or city.\nPlease try again.","warning")}))}function clearMarkers(){if(null!==ALL_MARKERS&&ALL_MARKERS.length>0)for(var t=ALL_MARKERS.length-1;t>=0;t--)ALL_MARKERS[t].remove()}function displayAttractions(t){clearMarkers();for(var a=0;a<t.length;a++){var o=t[a],e=new mapboxgl.Popup({offset:25}).setHTML(attractionPopupMarkup(o)),n=(new mapboxgl.Marker).setLngLat([o.longitude,o.latitude]).setPopup(e).addTo(MAP);ALL_MARKERS.push(n)}MAP.fitBounds(MAX_BOUNDS)}function attractionPopupMarkup(t){var a=t.pagethumbnail,o=t.pagetitle,e=t.descr,n=t.gis_id;return showImage=$("#map_canvas").height()>=500,markup="<h3>"+o+"</h3>","string"==typeof e&&(e=shortenStr(e,100,!0),markup+="<p>"+e+"</p>"),"string"==typeof t.cmp_url&&(markup+='<p><a href="'+t.cmp_url+'" title="Find out more about '+o+'." target="_blank">More info</a></p>'),showImage&&a&&(thumbnailPath=CM_SITE_BASEURL+a.replace("~/",""),origWidth=thumbnailPath.match(/width=(\d*)/),origHeight=thumbnailPath.match(/height=(\d*)/),Array.isArray(origWidth)&&Array.isArray(origHeight)&&(origWidth=origWidth[1],origHeight=origHeight[1],thumbnailWidth=180,thumbnailHeight=origHeight/origWidth*thumbnailWidth,thumbnailPath=thumbnailPath.replace(/width=(\d*)\&height=(\d)*\&/,"height="+thumbnailHeight+"&"),markup+='<div style="text-align:center">',markup+='<img src="'+thumbnailPath+'" height="'+thumbnailHeight+'" width="'+thumbnailWidth+'" alt="'+o+'" /></div>',markup+="</div>")),mapLink=WEBAPP_BASEPATH+"mobile?type=attraction&gid="+n,markup+='<p><a href="'+mapLink+'" target="_blank">See on full map </a></p>',markup}$(document).ready((function(){initMap({base:"map",scrollZoom:!1,trackUserLocation:!1}),processQueryParams(),$("#nearme").click((function(){$("#nearme").prop("checked")?basicGeolocate():disableGeolocation()}))})),$(document).on("mapInitialized",(function(){ctrlGeolocate.on("geolocate",(function(t){var a=new mapboxgl.LngLat(t.coords.longitude,t.coords.latitude);geolocateSuccess(a),MAX_BOUNDS.contains(a)||(showInfoPopup("Sorry, your current location is too far away.","warning"),console.log("Geolocation out of bounds: ",USER_LOCATION),disableGeolocation())})),MAP.on("locationerror",(function(t){showInfoPopup("We couldn't acquire your current location.","error"),console.log("Geolocation error: "+t.message+"("+t.code+")"),disableGeolocation()}))}));
var USER_LOCATION,API_ENDPOINT_GEOCODE=API_BASEPATH+"ajax/geocode",API_ENDPOINT_ATTRACTIONS_WITH_ACTIVITIES=API_BASEPATH+"ajax/get_attractions_by_activity",API_ENDPOINT_ATTRACTIONS_WITH_ACTIVITIES_NEARBY=API_BASEPATH+"ajax/get_nearby_attractions_with_activities";function geolocateSuccess(t){USER_LOCATION=t}function disableGeolocation(){USER_LOCATION=null}function callGetAttractions(t){return $.ajax({url:t.get_attractions_url,dataType:"json",data:t}).done(function(t){displayActivities(t.results)}).fail(function(t,a,o){console.log("callGetAttractions error"),console.log(a+": "+o)})}function callGeocodeAddress(t){var a={};return a.address=t.searchtext,a.bing_key=BING_API_KEY,a.bbox=GEOCODE_BIAS_BOX,$.ajax({url:API_ENDPOINT_GEOCODE,dataType:"json",data:a}).done(function(t){var a=new mapboxgl.LngLat(t.lng,t.lat);MAX_BOUNDS.contains(a)||showInfoPopup("The location we found for your address is too far away.","warning")}).fail(function(t,a,o){console.log(a+": "+o),showInfoPopup("We couldn't find that address or city.\nPlease try again.","warning")})}function displayActivities(t){for(var a=0;a<t.length;a++){var o=t[a],e=new mapboxgl.Popup({offset:25}).setHTML(attractionPopupMarkup(o));(new mapboxgl.Marker).setLngLat([o.lng,o.lat]).setPopup(e).addTo(MAP)}MAP.fitBounds(MAX_BOUNDS)}function attractionPopupMarkup(t){return showAll=500<=$("#map_canvas").height(),markup="<h3>"+t.name+"</h3>",showAll&&t.description&&(markup+="<p>"+t.description+"</p>"),t.cmp_url&&(markup+='<p><a href="'+t.cmp_url+'" title="Find out more about '+t.name+'." target="_blank">More info</a></p>'),showAll&&t.thumbnail&&(thumbnail_path=CM_SITE_BASEURL+t.thumbnail.replace("~/",""),thumbnail_height=150,thumbnail_path=thumbnail_path.replace(/width=\d*\&height=\d*\&/,"height="+thumbnail_height+"&"),markup+='<img src="'+thumbnail_path+'" height="'+thumbnail_height+'" alt="'+t.name+'" />'),map_link=WEBAPP_BASEPATH+"mobile?type=attraction&gid="+t.gid,markup+='<p><a href="'+map_link+'" target="_blank">See on full map </a></p>',markup}$(document).ready(function(){initMap({base:"map",scrollZoom:!1,trackUserLocation:!1});var t,a=new URLSearchParams(location.search);if(a.has("activitytype"))var o=a.get("activitytype").split("|");a.has("location")&&(t=a.get("location"));var e,n=a.has("nearme")&&"True"==a.get("nearme");if(a.has("lat")&&a.has("long"))var i=parseFloat(a.get("lat")),l=parseFloat(a.get("long"));a.has("distance")&&(e=5280*a.get("distance"));var r={activity_ids:o,within_feet:e=Number.isInteger(e)?e:0};n&&MAP.locate({watch:!1,enableHighAccuracy:!0}),o&&(n?(r.get_attractions_url=API_ENDPOINT_ATTRACTIONS_WITH_ACTIVITIES_NEARBY,USER_LOCATION?(r.lat=USER_LOCATION.lat,r.lng=USER_LOCATION.lng):i&&l?(r.lat=i,r.lng=l):r.get_attractions_url=API_ENDPOINT_ATTRACTIONS_WITH_ACTIVITIES,callGetAttractions(r)):t?(r.get_attractions_url=API_ENDPOINT_ATTRACTIONS_WITH_ACTIVITIES_NEARBY,r.searchtext=t,callGeocodeAddress(r).then(function(t,a,o){r.lat=t.lat,r.lng=t.lng,callGetAttractions(r)})):(r.get_attractions_url=API_ENDPOINT_ATTRACTIONS_WITH_ACTIVITIES,delete r.within_feet,callGetAttractions(r))),$("#nearme").click(function(){$("#nearme").prop("checked")?MAP.locate({watch:!1,enableHighAccuracy:!0}):(MAP.stopLocate(),disableGeolocation())})}),$(document).on("mapInitialized",function(){ctrlGeolocate.on("geolocate",function(t){var a=new mapboxgl.LngLat(t.coords.longitude,t.coords.latitude);geolocateSuccess(a),MAX_BOUNDS.contains(a)||(showInfoPopup("Sorry, your current location is too far away.","warning"),console.log("Geolocation out of bounds: ",USER_LOCATION),disableGeolocation())}),MAP.on("locationerror",function(t){showInfoPopup("We couldn't acquire your current location.","error"),console.log("Geolocation error: "+t.message+"("+t.code+")"),disableGeolocation()})});
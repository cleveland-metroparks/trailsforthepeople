var USER_LOCATION,API_ENDPOINT_GEOCODE=API_BASEPATH+"ajax/geocode",API_ENDPOINT_ATTRACTIONS_WITH_ACTIVITIES=API_BASEPATH+"ajax/get_attractions_by_activity",API_ENDPOINT_ATTRACTIONS_WITH_ACTIVITIES_NEARBY=API_BASEPATH+"ajax/get_nearby_attractions_with_activities";function geolocateSuccess(t){USER_LOCATION=t}function disableGeolocation(){USER_LOCATION=null}function callGetAttractions(t){return $.ajax({url:t.get_attractions_url,dataType:"json",data:t}).done(function(t){displayActivities(t.results)}).fail(function(t,a,o){console.log("callGetAttractions error"),console.log(a+": "+o)})}function callGeocodeAddress(t){var a={};return a.address=t.searchtext,a.bing_key=BING_API_KEY,a.bbox=GEOCODE_BIAS_BOX,$.ajax({url:API_ENDPOINT_GEOCODE,dataType:"json",data:a}).done(function(t){var a=new mapboxgl.LngLat(t.lng,t.lat);MAX_BOUNDS.contains(a)||showInfoPopup("The location we found for your address is too far away.","warning")}).fail(function(t,a,o){console.log(a+": "+o),showInfoPopup("We couldn't find that address or city.\nPlease try again.","warning")})}function displayActivities(t){for(var a=0;a<t.length;a++){var o=t[a],e=new mapboxgl.Popup({offset:25}).setHTML(attractionPopupMarkup(o));(new mapboxgl.Marker).setLngLat([o.lng,o.lat]).setPopup(e).addTo(MAP)}MAP.fitBounds(MAX_BOUNDS)}function attractionPopupMarkup(t){return showImage=500<=$("#map_canvas").height(),markup="<h3>"+t.name+"</h3>","string"==typeof t.description&&(t.description=shortenStr(t.description,100,!0),markup+="<p>"+t.description+"</p>"),"string"==typeof t.cmp_url&&(markup+='<p><a href="'+t.cmp_url+'" title="Find out more about '+t.name+'." target="_blank">More info</a></p>'),showImage&&t.thumbnail&&(thumbnailPath=CM_SITE_BASEURL+t.thumbnail.replace("~/",""),origWidth=thumbnailPath.match(/width=(\d*)/),origHeight=thumbnailPath.match(/height=(\d*)/),Array.isArray(origWidth)&&Array.isArray(origHeight)&&(origWidth=origWidth[1],origHeight=origHeight[1],thumbnailWidth=180,thumbnailHeight=origHeight/origWidth*thumbnailWidth,thumbnailPath=thumbnailPath.replace(/width=(\d*)\&height=(\d)*\&/,"height="+thumbnailHeight+"&"),markup+='<div style="text-align:center">',markup+='<img src="'+thumbnailPath+'" height="'+thumbnailHeight+'" width="'+thumbnailWidth+'" alt="'+t.name+'" /></div>',markup+="</div>")),mapLink=WEBAPP_BASEPATH+"mobile?type=attraction&gid="+t.gid,markup+='<p><a href="'+mapLink+'" target="_blank">See on full map </a></p>',markup}$(document).ready(function(){initMap({base:"map",scrollZoom:!1,trackUserLocation:!1});var t,a=new URLSearchParams(location.search);if(a.has("activitytype"))var o=a.get("activitytype").split("|");a.has("location")&&(t=a.get("location"));var e,i=a.has("nearme")&&"True"==a.get("nearme");if(a.has("lat")&&a.has("long"))var n=parseFloat(a.get("lat")),r=parseFloat(a.get("long"));a.has("distance")&&(e=5280*a.get("distance"));var l={activity_ids:o,within_feet:e=Number.isInteger(e)?e:0};i&&MAP.locate({watch:!1,enableHighAccuracy:!0}),o&&(i?(l.get_attractions_url=API_ENDPOINT_ATTRACTIONS_WITH_ACTIVITIES_NEARBY,USER_LOCATION?(l.lat=USER_LOCATION.lat,l.lng=USER_LOCATION.lng):n&&r?(l.lat=n,l.lng=r):l.get_attractions_url=API_ENDPOINT_ATTRACTIONS_WITH_ACTIVITIES,callGetAttractions(l)):t?(l.get_attractions_url=API_ENDPOINT_ATTRACTIONS_WITH_ACTIVITIES_NEARBY,l.searchtext=t,callGeocodeAddress(l).then(function(t,a,o){l.lat=t.lat,l.lng=t.lng,callGetAttractions(l)})):(l.get_attractions_url=API_ENDPOINT_ATTRACTIONS_WITH_ACTIVITIES,delete l.within_feet,callGetAttractions(l))),$("#nearme").click(function(){$("#nearme").prop("checked")?MAP.locate({watch:!1,enableHighAccuracy:!0}):(MAP.stopLocate(),disableGeolocation())})}),$(document).on("mapInitialized",function(){ctrlGeolocate.on("geolocate",function(t){var a=new mapboxgl.LngLat(t.coords.longitude,t.coords.latitude);geolocateSuccess(a),MAX_BOUNDS.contains(a)||(showInfoPopup("Sorry, your current location is too far away.","warning"),console.log("Geolocation out of bounds: ",USER_LOCATION),disableGeolocation())}),MAP.on("locationerror",function(t){showInfoPopup("We couldn't acquire your current location.","error"),console.log("Geolocation error: "+t.message+"("+t.code+")"),disableGeolocation()})});
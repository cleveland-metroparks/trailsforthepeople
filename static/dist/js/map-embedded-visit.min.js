var USER_LOCATION,ALL_MARKERS=[];function processQueryParams(){var t,a=new URLSearchParams(location.search),o=null;a.has("activitytype")&&(o=a.get("activitytype").split("|")),a.has("location")&&(t=a.get("location"));var e,i=a.has("nearme")&&"True"==a.get("nearme");if(i&&basicGeolocate(),a.has("lat")&&a.has("long"))var n=parseFloat(a.get("lat")),r=parseFloat(a.get("long"));a.has("distance")&&(e=5280*a.get("distance"));var l={activity_ids:o,within_feet:e=Number.isInteger(e)?e:0};if(o){var c=!1;if(i?null!=USER_LOCATION?(c=!0,l.lat=USER_LOCATION.coords.latitude,l.lng=USER_LOCATION.coords.longitude):n&&r?(c=!0,l.lat=n,l.lng=r):c=!1:t?(c=!0,callGeocodeAddress(t).then((function(t,a,o){l.lat=t.data.lat,l.lng=t.data.lng}))):c=!1,c)callGetNearbyAttractions(l);else displayAttractions(CM.get_attractions_by_activity(o))}}function basicGeolocate(){navigator.geolocation.getCurrentPosition(geolocateSuccess,null,{enableHighAccuracy:!0})}function geolocateSuccess(t){USER_LOCATION=t}function disableGeolocation(){USER_LOCATION=null}function callGetNearbyAttractions(t){return $.ajax({url:API_BASEPATH+"ajax/get_nearby_attractions_with_activities",dataType:"json",data:t}).done((function(t){displayAttractions(t.results)})).fail((function(t,a,o){console.log("callGetNearbyAttractions error"),console.log(a+": "+o)}))}function callGeocodeAddress(t){return $.get(API_NEW_BASE_URL+"geocode/"+t,null,(function(t){var a=new mapboxgl.LngLat(t.data.lng,t.data.lat);MAX_BOUNDS.contains(a)||showInfoPopup("The location we found for your address is too far away.","warning")})).fail((function(t,a,o){console.log(a+": "+o),showInfoPopup("We couldn't find that address or city.\nPlease try again.","warning")}))}function clearMarkers(){if(null!==ALL_MARKERS&&ALL_MARKERS.length>0)for(var t=ALL_MARKERS.length-1;t>=0;t--)ALL_MARKERS[t].remove()}function displayAttractions(t){clearMarkers();for(var a=0;a<t.length;a++){var o=t[a],e=new mapboxgl.Popup({offset:25}).setHTML(attractionPopupMarkup(o)),i=o.lng?o.lng:o.longitude,n=o.lat?o.lat:o.latitude,r=(new mapboxgl.Marker).setLngLat([i,n]).setPopup(e).addTo(MAP);ALL_MARKERS.push(r)}MAP.fitBounds(MAX_BOUNDS)}function attractionPopupMarkup(t){var a=t.pagethumbnail?t.pagethumbnail:t.thumbnail,o=t.pagetitle?t.pagetitle:t.name,e=t.descr?t.descr:t.description,i=t.gis_id?t.gis_id:t.gid;return showImage=$("#map_canvas").height()>=500,markup="<h3>"+o+"</h3>","string"==typeof e&&(e=shortenStr(e,100,!0),markup+="<p>"+e+"</p>"),"string"==typeof t.cmp_url&&(markup+='<p><a href="'+t.cmp_url+'" title="Find out more about '+o+'." target="_blank">More info</a></p>'),showImage&&a&&(thumbnailPath=CM_SITE_BASEURL+a.replace("~/",""),origWidth=thumbnailPath.match(/width=(\d*)/),origHeight=thumbnailPath.match(/height=(\d*)/),Array.isArray(origWidth)&&Array.isArray(origHeight)&&(origWidth=origWidth[1],origHeight=origHeight[1],thumbnailWidth=180,thumbnailHeight=origHeight/origWidth*thumbnailWidth,thumbnailPath=thumbnailPath.replace(/width=(\d*)\&height=(\d)*\&/,"height="+thumbnailHeight+"&"),markup+='<div style="text-align:center">',markup+='<img src="'+thumbnailPath+'" height="'+thumbnailHeight+'" width="'+thumbnailWidth+'" alt="'+o+'" /></div>',markup+="</div>")),mapLink=WEBAPP_BASEPATH+"mobile?type=attraction&gid="+i,markup+='<p><a href="'+mapLink+'" target="_blank">See on full map </a></p>',markup}$(document).ready((function(){initMap({base:"map",scrollZoom:!1,trackUserLocation:!1}),processQueryParams(),$("#nearme").click((function(){$("#nearme").prop("checked")?basicGeolocate():disableGeolocation()}))})),$(document).on("mapInitialized",(function(){ctrlGeolocate.on("geolocate",(function(t){var a=new mapboxgl.LngLat(t.coords.longitude,t.coords.latitude);geolocateSuccess(a),MAX_BOUNDS.contains(a)||(showInfoPopup("Sorry, your current location is too far away.","warning"),console.log("Geolocation out of bounds: ",USER_LOCATION),disableGeolocation())})),MAP.on("locationerror",(function(t){showInfoPopup("We couldn't acquire your current location.","error"),console.log("Geolocation error: "+t.message+"("+t.code+")"),disableGeolocation()}))}));
<!DOCTYPE html>
<html>
<head>
    <title>Test: Capital Projects</title>

    <meta charset="utf-8" />
    <link rel="shortcut icon" href="/static/images/favicons/favicon.ico">

    <!-- Scripts already included in CM site Kentico pages: -->
    <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js?v=1.19"></script>

    <!-- Concat-aggregated map JS, minus jQuery -->
    <script type="text/javascript" src="/static/dist/js/map-embedded-base-nojq.js"></script>

    <!-- Concat-aggregated map JS, minus jQuery -->
    <script type="text/javascript" src="/static/src/js/embedded-visit.js"></script>

    <!-- Import-aggregated map CSS -->
    <link rel="stylesheet" type="text/css" href='/static/dist/css/embedded.css' />

    <style>
        .mapboxgl-marker {
            cursor: pointer;
        }
    </style>

</head>

<body>

    <h1>Test: Embedded Map with Capital Projects</h1>

    <p>Map embed showing markers for Planning & Design capital projects, currently pulled from local static GeoJSON.</p>

	<!-- Map -->
    <div id="map_canvas" style="width:100%; height:500px;"></div>

    <script type="text/javascript">
        const projectDataGeoJsonUrl = '/test/pnd-markers.geojson';

        const markerClasses = [
            {
                id: 'reservation',
                text: 'Reservation Capital Project',
                color: 'blue'
            },
            {
                id: 'trail',
                text: 'Trail Project',
                color: 'brown'
            },
            {
                id: 'restoration',
                text: 'Ecological Restoration and Site Improvements',
                color: 'green'
            },
            {
                id: 'golf',
                text: 'Golf Capital Project',
                color: 'black'
            },
            {
                id: 'expansion',
                text: 'New Reservations/Major Park Expansions',
                color: 'red'
            },
            {
                id: 'zoo',
                text: 'Zoo Capital Project',
                color: 'purple'
            }
        ];

        /**
         *
         */
        $(document).on("mapInitialized", function () {
            MAP.on('load', () => {

                markerClasses.forEach((item, index, arr) => {
                    const sourceId = 'source-' + item.id;
                    const markerLayerId = 'layer-' + item.id;
                    const clusterLayerId = 'layer-cluster-' + item.id;
                    const clusterCountLayerId = 'layer-cluster-count-' + item.id;

                    /**
                     * Map data source for this class of markers, with point clustering.
                     *
                     * We make a separate data source for each layer
                     * in order to cluster per layer.
                     *
                     * Mapbox GL JS clustering examples:
                     * - https://docs.mapbox.com/mapbox-gl-js/example/cluster/
                     * - https://docs.mapbox.com/mapbox-gl-js/example/cluster-html/
                     */
                    MAP.addSource(sourceId, {
                        type: 'geojson',
                        data: projectDataGeoJsonUrl,
                        filter: ['==', ['get', 'Map Class'], item.text],
                        cluster: true,
                        clusterMinPoints: 2,
                        clusterMaxZoom: 9,
                    });

                    // Map layer for this class of markers
                    MAP.addLayer({
                        id: markerLayerId,
                        type: 'circle',
                        source: sourceId,
                        // filter: ['==', ['get', 'Map Class'], item.text],
                        paint: {
                            'circle-radius': 8,
                            'circle-stroke-width': 1,
                            'circle-color': item.color,
                            'circle-stroke-color': 'white'
                        }
                    });

                    MAP.addLayer({
                        id: clusterLayerId,
                        type: 'circle',
                        source: sourceId,
                        filter: ['has', 'point_count'],
                        // filter: ['all', ['has', 'point_count'], ['==', ['get', 'Map Class'], item.text]],
                        paint: {
                            'circle-color': item.color,
                            'circle-radius': [
                                'step', // Step expression
                                        // - https://docs.mapbox.com/mapbox-gl-js/style-spec/#expressions-step
                                ['get', 'point_count'],
                                12, //   * 12px circles when point count is < 2
                                2,
                                16, //   * 16px circles when point count is between 2 and 4
                                4,
                                20  //   * 20px circles when point count is >= 4
                            ]
                        }
                    });

                    MAP.addLayer({
                        id: clusterCountLayerId,
                        type: 'symbol',
                        source: sourceId,
                        filter: ['has', 'point_count'],
                        layout: {
                            'text-field': '{point_count}',
                            'text-font': ['Open Sans Semibold', 'Arial Unicode MS Bold'],
                            'text-size': 16
                        },
                        paint: {
                            'text-color': 'white'
                        }
                    });

                    // Change the cursor to a pointer when hovering over individual markers
                    MAP.on('mousemove', markerLayerId, (event) => {
                        MAP.getCanvas().style.cursor = 'pointer';
                    });
                    MAP.on('mouseleave', markerLayerId, () => {
                        MAP.getCanvas().style.cursor = ''; // Reset
                    });

                    MAP.on('click', markerLayerId, (e) => {
                        const coordinates = e.features[0].geometry.coordinates.slice();
                        const project = {
                            name: e.features[0].properties['Project'],
                            type: e.features[0].properties['Project Type'],
                            link: e.features[0].properties['Project Page Link']
                        }

                        const popupHtml =
                            '<h2 class="project-name">' + project.name + '</h2>' +
                            '<p class="project-type">' + project.type + '</p>' +
                            '<p class="project-link"><a class="project-link"><a href="' + project.link + '">More info</a></p>';

                        // Ensure that if the map is zoomed out such that
                        // multiple copies of the feature are visible, the
                        // popup appears over the copy being pointed to.
                        while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                            coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
                        }

                        new mapboxgl.Popup()
                            .setLngLat(coordinates)
                            .setHTML(popupHtml)
                            .addTo(MAP);
                    });
                });
            });
        });
    </script>

</body>
</html>